{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/cactus/source/css/rtl.styl","path":"css/rtl.styl","modified":0,"renderable":1},{"_id":"themes/cactus/source/css/style.styl","path":"css/style.styl","modified":0,"renderable":1},{"_id":"themes/cactus/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/js/search.js","path":"js/search.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/apple-touch-icon.png","path":"images/apple-touch-icon.png","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/favicon-192x192.png","path":"images/favicon-192x192.png","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/clipboard/clipboard.min.js","path":"lib/clipboard/clipboard.min.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff","path":"lib/vazir-font/Vazir-Black.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff2","path":"lib/vazir-font/Vazir-Black.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff","path":"lib/vazir-font/Vazir-Bold.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff2","path":"lib/vazir-font/Vazir-Bold.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff","path":"lib/vazir-font/Vazir-Light.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff2","path":"lib/vazir-font/Vazir-Light.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff","path":"lib/vazir-font/Vazir-Medium.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff2","path":"lib/vazir-font/Vazir-Medium.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff2","path":"lib/vazir-font/Vazir-Thin.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff","path":"lib/vazir-font/Vazir-Thin.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff2","path":"lib/vazir-font/Vazir.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff","path":"lib/vazir-font/Vazir.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/font-face.css","path":"lib/vazir-font/font-face.css","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/jquery/jquery.min.js","path":"lib/jquery/jquery.min.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.ttf","path":"lib/vazir-font/Vazir-Black.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.eot","path":"lib/vazir-font/Vazir-Black.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.eot","path":"lib/vazir-font/Vazir-Bold.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.ttf","path":"lib/vazir-font/Vazir-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.ttf","path":"lib/vazir-font/Vazir-Light.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.eot","path":"lib/vazir-font/Vazir-Light.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.ttf","path":"lib/vazir-font/Vazir-Medium.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.eot","path":"lib/vazir-font/Vazir-Medium.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.ttf","path":"lib/vazir-font/Vazir-Thin.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.eot","path":"lib/vazir-font/Vazir-Thin.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.eot","path":"lib/vazir-font/Vazir.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.ttf","path":"lib/vazir-font/Vazir.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.eot","path":"lib/font-awesome/webfonts/fa-regular-400.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.ttf","path":"lib/font-awesome/webfonts/fa-regular-400.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff","path":"lib/font-awesome/webfonts/fa-regular-400.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/justified-gallery/css/justifiedGallery.min.css","path":"lib/justified-gallery/css/justifiedGallery.min.css","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/justified-gallery/js/jquery.justifiedGallery.min.js","path":"lib/justified-gallery/js/jquery.justifiedGallery.min.js","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff","path":"lib/font-awesome/webfonts/fa-brands-400.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.eot","path":"lib/font-awesome/webfonts/fa-brands-400.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.ttf","path":"lib/font-awesome/webfonts/fa-brands-400.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff","path":"lib/font-awesome/webfonts/fa-solid-900.woff","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.svg","path":"lib/font-awesome/webfonts/fa-regular-400.svg","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.ttf","path":"lib/font-awesome/webfonts/fa-solid-900.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.eot","path":"lib/font-awesome/webfonts/fa-solid-900.eot","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGM-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Italic.ttf","path":"lib/meslo-LG/MesloLGM-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGS-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Italic.ttf","path":"lib/meslo-LG/MesloLGS-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Italic.ttf","path":"lib/meslo-LG/MesloLGL-Italic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-BoldItalic.ttf","path":"lib/meslo-LG/MesloLGL-BoldItalic.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Bold.ttf","path":"lib/meslo-LG/MesloLGM-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Bold.ttf","path":"lib/meslo-LG/MesloLGS-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Regular.ttf","path":"lib/meslo-LG/MesloLGL-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Regular.ttf","path":"lib/meslo-LG/MesloLGS-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Bold.ttf","path":"lib/meslo-LG/MesloLGL-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Regular.ttf","path":"lib/meslo-LG/MesloLGM-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.svg","path":"lib/font-awesome/webfonts/fa-brands-400.svg","modified":0,"renderable":1},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.svg","path":"lib/font-awesome/webfonts/fa-solid-900.svg","modified":0,"renderable":1}],"Cache":[{"_id":"themes/cactus/.git","hash":"84ddcc4cdecf4eabff10c773b98d310530a85e78","modified":1577520163228},{"_id":"themes/cactus/LICENSE","hash":"346ece39a983b0e7858c11f785cd846cef9eb875","modified":1577520163295},{"_id":"themes/cactus/.gitignore","hash":"c5345a2c5fa6c136dbe2020a405e541b4755a259","modified":1577520163294},{"_id":"themes/cactus/.jshintrc","hash":"2548bd6ce44422edc7e6f9f68061ab47f26c4f57","modified":1577520163294},{"_id":"themes/cactus/.stylintrc","hash":"eb5f48e83657928cb0cbee031373b2cd36ca0083","modified":1577520163295},{"_id":"themes/cactus/README.md","hash":"859d11941c46be4f7b4a6d62297ccbeb4f732bc9","modified":1577520163295},{"_id":"themes/cactus/_config.yml","hash":"ba5f81c207aacb2cc87d0b51ccb7eca30341d550","modified":1577521264833},{"_id":"themes/cactus/gulpfile.js","hash":"0e55606323a45873506c08be6528478c08373e1e","modified":1577521235339},{"_id":"themes/cactus/theme-cactus-changes.patch","hash":"80bab7c0823075e0e42cac496c86a1adebee3d45","modified":1577520327963},{"_id":"themes/cactus/package.json","hash":"a6060fadd36114d8cb74e7ff4c7d073901b5edcd","modified":1577521235343},{"_id":"source/_posts/4chan-parallel-image-downloader.md","hash":"ef3f926668465ca574628a9c3e325240bf2b5711","modified":1577519742184},{"_id":"source/_posts/audio-changes-qemu-4-0-ac97-passthrough.md","hash":"c134693c9672eec7c4d779941248a5d329a0c628","modified":1577519742185},{"_id":"source/_posts/compiling-a-single-module-linux-kernel.md","hash":"cb50fdc8a4ede25b10ccffcc3df5afef42cb95de","modified":1577519742185},{"_id":"source/_posts/ezjail-and-network-interfaces.md","hash":"fda8397a9c9a90b5a09bec30146756ed9fb53d90","modified":1577519742185},{"_id":"source/_posts/coffee-lake-build-gentoo.md","hash":"25f09cda67dd86f02dcf718c51f92b986dd15b75","modified":1577519742185},{"_id":"source/_posts/lamp-control-based-on-video-conferencing.md","hash":"669bb19eb36d31c62a5073e7a191a7eb7866c3a2","modified":1596197675011},{"_id":"source/_posts/iOS-openvpn-connect-read-length-inconsistency.md","hash":"c14a7959ad94e79197ea454539602891e682c31f","modified":1577519742186},{"_id":"source/_posts/notes-on-flashing-the-esp8266-esp-01s.md","hash":"dc2d23ceaf4babde0143b67f705077cfc059d729","modified":1577519742186},{"_id":"source/_posts/migrating-weechat-linux-macos.md","hash":"4b60c65da4739b6d8b8a2ef0b4d031ac2d5543df","modified":1577519742186},{"_id":"source/_posts/passthrough-disk-performance-zfs.md","hash":"07d4b2f60ddceed390c9c9dde7c0dd0fe8d40125","modified":1577519742186},{"_id":"source/_posts/qemu-vm-wireguard-vpn-tun-tap-networking.md","hash":"13ef0530bedc8b2439b8f6ea3613bcb075d6cb56","modified":1577519742186},{"_id":"source/_posts/ros-kinetic-macos-may17.md","hash":"7dac24e44922a672e8950617c746e10d8a804c33","modified":1577519742186},{"_id":"source/_posts/rsync-parallel.md","hash":"31d6fa6a490e7eeb8dd3504615431dae8b1862b0","modified":1593064272631},{"_id":"source/_posts/rtorrent-move-on-completion-flood.md","hash":"a47ae2f876b84824e2aafd7ef035d73b3c27a9c2","modified":1577521785807},{"_id":"source/_posts/rustcon-beijing.md","hash":"015a2b9fb20ad27adb2c667eadfc3c5f6c293de3","modified":1577519742187},{"_id":"source/_posts/sane-sshd-ipfw-defaults.md","hash":"bbb9fa8af43adf096208d8babae03c14cbba5f93","modified":1577519742188},{"_id":"source/_posts/running-windows-with-pci-passthrough-on-gentoo-linux.md","hash":"8be91f1a37ff435ba3e2fe9acdec9ef0eef548f9","modified":1577519742187},{"_id":"source/_posts/whatsapp-chat-backup-getting-stuck.md","hash":"6251a6e99d629ef96cb666d3ae15aa06b68b1bfb","modified":1577519742188},{"_id":"source/_posts/say-no-to-catkin-make.md","hash":"b680e0f9e5c3ed960710a0e42de33647ec49b5e6","modified":1577519742188},{"_id":"themes/cactus/languages/ca.yml","hash":"b79dd2c21dc6697c635e92db1f661a4b8d5d2305","modified":1577520163295},{"_id":"themes/cactus/languages/en.yml","hash":"703548ad90034d4e5207a27eb50f726dc27e4c0c","modified":1577521235340},{"_id":"themes/cactus/languages/fa.yml","hash":"63f32e50953af1c4bd0308a4fca5862b5287c2cb","modified":1577520163296},{"_id":"themes/cactus/languages/default.yml","hash":"703548ad90034d4e5207a27eb50f726dc27e4c0c","modified":1577521235340},{"_id":"themes/cactus/languages/es.yml","hash":"2b1fc8b0d636123e9ee39017fa20053bd1913a5a","modified":1577520163296},{"_id":"themes/cactus/languages/it.yml","hash":"62800bcae1f2d2454f87f4bcf4d7593848424f61","modified":1577520163296},{"_id":"themes/cactus/languages/fr.yml","hash":"4fea266d3c522903f3eee4fffee6e66c44775005","modified":1577520163296},{"_id":"themes/cactus/languages/pl.yml","hash":"8a2d6dc874d86c38d42c2c861c39590647b5d536","modified":1577520163297},{"_id":"themes/cactus/languages/kr.yml","hash":"651fb83991c91b13b53ed55740e5402cf0f1c5e8","modified":1577521235340},{"_id":"themes/cactus/languages/nl.yml","hash":"ac0573352ad2c737a7686bcca498b985e7bd6447","modified":1577520163297},{"_id":"themes/cactus/languages/pt-br.yml","hash":"4859aba788a050c2d5d0b997693b0c8c24b349f7","modified":1577520163297},{"_id":"themes/cactus/languages/tr.yml","hash":"2702914007e6bade9d6861078c0e179ac05bf48c","modified":1577520163298},{"_id":"themes/cactus/languages/ru.yml","hash":"81b57fcd1977ef534f4bf303dbc1b4710cc7f057","modified":1577520163297},{"_id":"themes/cactus/languages/vi.yml","hash":"f84893c3ec3e45875c90069e14b17ed3016ed973","modified":1577520163298},{"_id":"themes/cactus/languages/zh-CN.yml","hash":"8f81faaad9a0615b09dbc23868484a55ec958f6f","modified":1577521235341},{"_id":"themes/cactus/languages/zh-TW.yml","hash":"2f4e050c9b35a67f4a7278cec3a949533c2ac16a","modified":1577520163298},{"_id":"themes/cactus/layout/archive.ejs","hash":"53de8817e37be01b3ba8fa5ca31b9cafa2f3c011","modified":1577520163301},{"_id":"themes/cactus/layout/layout.ejs","hash":"8504004f2ed78914f806c6699d9bd722318cbe56","modified":1577520163301},{"_id":"themes/cactus/layout/post.ejs","hash":"a7d164ce888a60cd3eddd9c04bc6762428fa66bb","modified":1577520163302},{"_id":"themes/cactus/layout/index.ejs","hash":"1fd8aad25b2893a26b4483b91a341907e55c16be","modified":1577521235342},{"_id":"themes/cactus/layout/page.ejs","hash":"c5465d5315a7544aa466b01fd8cfb62917a8bb1d","modified":1577520163301},{"_id":"themes/cactus/scripts/merge-configs.js","hash":"2048c3415d96b17b9d84aa44bc0c25f1210525f8","modified":1577520163302},{"_id":"themes/cactus/scripts/meta.js","hash":"fa6055a39851c9953d033e70c1614547b94dce60","modified":1577520163302},{"_id":"themes/cactus/scripts/page_title.js","hash":"fa662dbdb82779af1b95e35ed7ccdf4866a53dee","modified":1577520163302},{"_id":"themes/cactus/scripts/thumbnail.js","hash":"df8829fd8c3119650037eba5ec11bdce06acff9d","modified":1577520163303},{"_id":"themes/cactus/layout/_partial/comments.ejs","hash":"4cf8d0059e5f8bc8ae1dd1a426293583fd398052","modified":1577520163299},{"_id":"themes/cactus/layout/_partial/pagination.ejs","hash":"23bf862b3b8a3cd831850504d9b5a24d21b005e7","modified":1577520163299},{"_id":"themes/cactus/layout/_partial/footer.ejs","hash":"c3a80e347cb11022baf5e65fb4d0209b8d205693","modified":1577520163299},{"_id":"themes/cactus/layout/_partial/head.ejs","hash":"b7db191b7ad066b1f3f9c34d8a4b77e1ee815215","modified":1577521235341},{"_id":"themes/cactus/layout/_partial/scripts.ejs","hash":"137d3039f61cae8ae9219eb6771dd367304f9ec3","modified":1577521235342},{"_id":"themes/cactus/layout/_partial/header.ejs","hash":"6b534801486f6baa989bd351915a9156b838b777","modified":1577521235341},{"_id":"themes/cactus/layout/_partial/styles.ejs","hash":"be1b54388eb02176dd4722285dda19e3dce2e62e","modified":1577520163301},{"_id":"themes/cactus/layout/_partial/search.ejs","hash":"8b4bf9cf5db0ce762a31fc3baae0f2fc004bece4","modified":1577520163301},{"_id":"themes/cactus/source/css/_fonts.styl","hash":"354809b5a64e8a47a66c66fd1a28ac597c1460a6","modified":1577520163303},{"_id":"themes/cactus/source/css/_extend.styl","hash":"b6a4e5905a7515dda66919167531a5ab2b3d1fe2","modified":1577521235343},{"_id":"themes/cactus/source/css/_util.styl","hash":"2bfeb2e2605dd5235693b00c71a212646d2e0410","modified":1577520163315},{"_id":"themes/cactus/source/css/_variables.styl","hash":"02079fb71b7d1c01d15fa512a1948ad4cbb416b5","modified":1577520163315},{"_id":"themes/cactus/source/css/rtl.styl","hash":"ff8700e1626feeb53d905a2df2777bda7d1eca50","modified":1577521235345},{"_id":"themes/cactus/source/css/style.styl","hash":"18b22cfdc7457d81db7694aef5850cc36ff87a77","modified":1577521235345},{"_id":"themes/cactus/source/css/_mixins.styl","hash":"1a9e309523df9685e8d088dcff0a809c58e2c392","modified":1577520163314},{"_id":"themes/cactus/source/js/main.js","hash":"584c5a69ac81a483a1c4377a2e2cf326c2795e7b","modified":1577520163318},{"_id":"themes/cactus/source/js/search.js","hash":"a74d0c601f820160825a2e4ad13618074d714933","modified":1577520163318},{"_id":"themes/cactus/source/images/apple-touch-icon.png","hash":"57e2def34682655f41a0be2d083f16765ba7858b","modified":1577520163316},{"_id":"themes/cactus/source/images/favicon-192x192.png","hash":"96e6fcbbb13a5914a6131391e210eb7dfd13d692","modified":1577520163316},{"_id":"themes/cactus/source/images/favicon.ico","hash":"189f9842bcb79a6f8f9e8445bc8bbd773443826b","modified":1577520163316},{"_id":"themes/cactus/layout/_partial/post/actions_desktop.ejs","hash":"38aadd1ed890303dde582b722486138afee09b0a","modified":1577520163299},{"_id":"themes/cactus/layout/_partial/post/actions_mobile.ejs","hash":"79b234ff3c264e66b2e71c819228e62bf92b48e4","modified":1577520163300},{"_id":"themes/cactus/layout/_partial/post/gallery.ejs","hash":"9aecd8908e8a684f33dc20c02497c0f1774137c7","modified":1577520163300},{"_id":"themes/cactus/layout/_partial/post/share.ejs","hash":"1a294382bd14d979525b8ed934d807bc7d083e4d","modified":1577521235342},{"_id":"themes/cactus/layout/_partial/post/category.ejs","hash":"b5bfa049f17868fb09d9d2a7e1d5279fa0381d37","modified":1577520163300},{"_id":"themes/cactus/layout/_partial/post/date.ejs","hash":"6f2d1aa9562df343b797d25705f1945323c465fb","modified":1577520163300},{"_id":"themes/cactus/layout/_partial/post/tag.ejs","hash":"e08fae30da060f49c087f6c121868b08eb55c795","modified":1577520163300},{"_id":"themes/cactus/layout/_partial/post/title.ejs","hash":"a060f1c6e3718494a6b1d0e1981ea0bf4e549828","modified":1577520163300},{"_id":"themes/cactus/source/css/_colors/classic.styl","hash":"0f0ec41a4165814ce69688425d5ac4d701b7cc70","modified":1577520163303},{"_id":"themes/cactus/source/css/_colors/light.styl","hash":"d09f781cb02394850737b3a9efc6693307d5bf09","modified":1577520163303},{"_id":"themes/cactus/source/css/_colors/dark.styl","hash":"9c9655b42b85f754b8a573a1d4634c23c680e1bf","modified":1577520163303},{"_id":"themes/cactus/source/css/_partial/archive.styl","hash":"ef8fc52337c4c7b010cad7c427cb78009b30f9d8","modified":1577520163314},{"_id":"themes/cactus/source/css/_colors/white.styl","hash":"3a838e272902270bc32481cce5a7308d8ae7be7b","modified":1577520339784},{"_id":"themes/cactus/source/css/_partial/article.styl","hash":"c6a3c395ceb4aacba8c995bcde7b58a7ca501919","modified":1577521235343},{"_id":"themes/cactus/source/css/_partial/categories.styl","hash":"a43f00e61b3507f130b8a3f8108a4eeca147c2a0","modified":1577520163314},{"_id":"themes/cactus/source/css/_partial/comments.styl","hash":"1e90f1fb9d4c155df518cacb5a537e9de9c042c1","modified":1577520163314},{"_id":"themes/cactus/source/css/_partial/header.styl","hash":"519af79eb34ee922b48e6c19aa8f4856e3f76486","modified":1577521235344},{"_id":"themes/cactus/source/css/_partial/footer.styl","hash":"14dda7f155bb21e6cd33ca3d8daa5b489b4707b3","modified":1577521235344},{"_id":"themes/cactus/source/css/_partial/index.styl","hash":"59c99f4ea3a73bf47ce030df166c5e33d5de31fb","modified":1577520163314},{"_id":"themes/cactus/source/css/_partial/pagination.styl","hash":"950bf517bbe7adb9a9aa4eb5ddec74ffc7598787","modified":1577520163314},{"_id":"themes/cactus/source/css/_partial/search.styl","hash":"159be002780c62a77f46947cf854a7342fba24f4","modified":1577520163315},{"_id":"themes/cactus/source/css/_partial/tags.styl","hash":"d571d5c7c960300d29c5f0ec3fe1140322ecd6b3","modified":1577520163315},{"_id":"themes/cactus/source/css/_partial/tooltip.styl","hash":"2daff581ec3efaec840cbfdee512195919c32629","modified":1577521235344},{"_id":"themes/cactus/source/css/_highlight/agate.styl","hash":"53027913ed8d4f75ac3e49e76aad824f0df62da3","modified":1577520163304},{"_id":"themes/cactus/source/css/_highlight/androidstudio.styl","hash":"2af0861725f97f0ee2ded67c3d2d4548c62b2d16","modified":1577520163304},{"_id":"themes/cactus/source/css/_highlight/arduino-light.styl","hash":"15e8572585cd708221c513dea4bdd89d8fe56c10","modified":1577520163304},{"_id":"themes/cactus/source/css/_highlight/arta.styl","hash":"b3e81e3e694ceb8deed178adb8b91013c5120e30","modified":1577520163304},{"_id":"themes/cactus/source/css/_highlight/ascetic.styl","hash":"32cff3bef6fac3760fe78f203096477052a90552","modified":1577520163305},{"_id":"themes/cactus/source/css/_highlight/atelier-cave-dark.styl","hash":"ce63dd8548688d88254405eedfa75b1d7c82449e","modified":1577520163305},{"_id":"themes/cactus/source/css/_highlight/atelier-cave-light.styl","hash":"a5be0744a7ecf4a08f600ade4cfd555afc67bc15","modified":1577520163305},{"_id":"themes/cactus/source/css/_highlight/atelier-estuary-dark.styl","hash":"0bb16a4eff93688f40787abc2f9e56e7d5cc93e7","modified":1577520163305},{"_id":"themes/cactus/source/css/_highlight/atelier-dune-light.styl","hash":"931435fbc6f974e8ce9e32722680035d248a9dc1","modified":1577520163305},{"_id":"themes/cactus/source/css/_highlight/atelier-dune-dark.styl","hash":"c196ff0ee064af0e507823694ae39020addfc280","modified":1577520163305},{"_id":"themes/cactus/source/css/_highlight/atelier-forest-dark.styl","hash":"effbc5d75fa87203c847039869c22031b40d5b7d","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-estuary-light.styl","hash":"344276ca9b27e51d4c907f76afe5d13cf8e60bdf","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-forest-light.styl","hash":"95228d9f2102fad425536aac44b80b2cba1f5950","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-heath-dark.styl","hash":"9a2e9a1d0a01bbdf158560c3ed1c134e098b2c68","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-lakeside-dark.styl","hash":"10ee3882fca7b97a37bd309d2d35fce9868647bb","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-heath-light.styl","hash":"8c8c2e445abef85273be966d59770e9ced6aac21","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-plateau-light.styl","hash":"d1a05fdd1ededc9063d181ab25bad55a164aeb4a","modified":1577520163307},{"_id":"themes/cactus/source/css/_highlight/atelier-plateau-dark.styl","hash":"84c80e6f67f62fce958d25817c277d2360272617","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-lakeside-light.styl","hash":"2c54cb9bdb259ae3b5b29f63ac2469ed34b08578","modified":1577520163306},{"_id":"themes/cactus/source/css/_highlight/atelier-savanna-light.styl","hash":"f8244c93711c7cb59dd79d2df966806b30d171ea","modified":1577520163307},{"_id":"themes/cactus/source/css/_highlight/atelier-savanna-dark.styl","hash":"e32c1c70def8060fce5e790979a126da650ac642","modified":1577520163307},{"_id":"themes/cactus/source/css/_highlight/atelier-seaside-dark.styl","hash":"2edf385215bbe1985b1a10106525d362667d28c2","modified":1577520163307},{"_id":"themes/cactus/source/css/_highlight/atelier-seaside-light.styl","hash":"0597342da6e2d0c5bdcc7d42dabb07322b1a4177","modified":1577520163307},{"_id":"themes/cactus/source/css/_highlight/atelier-sulphurpool-light.styl","hash":"efa52713efc468abeeb2b9299704371583b857de","modified":1577520163308},{"_id":"themes/cactus/source/css/_highlight/brown-paper.styl","hash":"c2326ba20a5020a66ca7895258d18833327d4334","modified":1577520163308},{"_id":"themes/cactus/source/css/_highlight/atelier-sulphurpool-dark.styl","hash":"538a14321193cd8abf2ddc484306631e54149ffb","modified":1577520163308},{"_id":"themes/cactus/source/css/_highlight/brown-papersq.png","hash":"3a1332ede3a75a3d24f60b6ed69035b72da5e182","modified":1577520163308},{"_id":"themes/cactus/source/css/_highlight/codepen-embed.styl","hash":"8b7b34484f76a6c2c3b1a9e49abb9b382f439ae8","modified":1577520163308},{"_id":"themes/cactus/source/css/_highlight/color-brewer.styl","hash":"2a439d6214430e2f45dd4939b4dfe1fe1a20aa0f","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/dark.styl","hash":"f5e6e75958de59e87fc6be3a1668e870e20bc836","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/darkula.styl","hash":"9717efa9194837ba3fb4d762997d33075dcf8bfa","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/docco.styl","hash":"b1c176378bb275f2e8caa759f36294e42d614bf1","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/github-gist.styl","hash":"48211a03d33e7f7ada0b261162bea06676155a71","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/far.styl","hash":"aaac3028f5e33123cd123a583cddc9290c45ec8e","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/foundation.styl","hash":"bf8ddc94b4ad995b8b8805b5a4cf95004553fdac","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/github.styl","hash":"3336aeba324c6d34a6fd41fef9b47bc598f7064c","modified":1577520163309},{"_id":"themes/cactus/source/css/_highlight/googlecode.styl","hash":"bda816beee7b439814b514e6869dc678822be1bc","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/grayscale.styl","hash":"bf37d8b8d1e602126c51526f0cc28807440228ed","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/highlightjs.styl","hash":"0e198b7a59191c7a39b641a4ddd22c948edb9358","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/hopscotch.styl","hash":"1378a6bc67a32c0cbff72ab771268b53f9aa586d","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/hybrid.styl","hash":"b8eb5c69d12f2ee5ebc50265ae271699d7f1a8d3","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/idea.styl","hash":"a02967cb51c16a34e0ee895d33ded2b823d35b21","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/gruvbox-dark.styl","hash":"76b744c14fd5600bea64731c05df97c2df75523f","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/ir-black.styl","hash":"53e5d74326a4527b92272bbd6946d4fec92720e8","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/kimbie.dark.styl","hash":"45dbb168f22d739d0109745d2decd66b5f94e786","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/index.styl","hash":"002d5596f6379cc87dbd43d9145bc764aa666be1","modified":1577520163310},{"_id":"themes/cactus/source/css/_highlight/kimbie.light.styl","hash":"61f8baed25be05288c8604d5070afbcd9f183f49","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/mono-blue.styl","hash":"4c89a6ae29de67c0700585af82a60607e85df928","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/magula.styl","hash":"16d323f989b1420a0f72ef989242ece9bf17a456","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/monokai-sublime.styl","hash":"c385b11345894be7e6ce3c5f08663e199933b8e4","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/kimbie.styl","hash":"51b889ca7c6fe178cfbbe28d875a6ea427184441","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/monokai.styl","hash":"f87be027848ea6bee623a08ad1e17b2f5b7937ee","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/obsidian.styl","hash":"199e28326be8590883f0813ebbd54fcfaa4750fd","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/paraiso-dark.styl","hash":"f1537bd868579fa018ecdbfd2eb922dcf3ba2cac","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/paraiso-light.styl","hash":"d224d1df0eb3395d9eea1344cee945c228af2911","modified":1577520163311},{"_id":"themes/cactus/source/css/_highlight/paraiso.styl","hash":"75f181eece6b71d033ea0c8d6cf00ae7efb9e29b","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/pojoaque.jpg","hash":"c5fe6533b88b21f8d90d3d03954c6b29baa67791","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/pojoaque.styl","hash":"4e7b6b046b8575ac749f6aec4e953a62ada27a36","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/railscasts.styl","hash":"b6674db9210e0c4444e4835fff2d1361f3ebd64c","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/rainbow.styl","hash":"c0cf97aae3e10fdcd10414547a711c9effbc39b8","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/school-book.png","hash":"711ec983c874e093bb89eb77afcbdf6741fa61ee","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/school-book.styl","hash":"d43560fe519a931ce6da7d57416d7aa148441b83","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/solarized-dark.styl","hash":"90c9da5aa594383697e5b18892a7f95beb053f55","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/solarized-light.styl","hash":"aa0dd3fd25c464183b59c5575c9bee8756b397f2","modified":1577520163312},{"_id":"themes/cactus/source/css/_highlight/sunburst.styl","hash":"af3eec0fd56151e55bbd49c31b151f36717611d8","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-blue.styl","hash":"f24c17d0ab815dcfaab3438cb9fe2ab4839f5e0d","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-eighties.styl","hash":"28d751075ebabf7d0327a36f725076fe82fdf626","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night-bright.styl","hash":"7674fecb6d27350727dc0d2dc93bc018382ebbd0","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/tomorrow-night.styl","hash":"16ba09b2db501e4e3e2e7d62595d9bf935bf27c4","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/vs.styl","hash":"959a746f4b37aacb5d1d6ff1d57e0c045289d75d","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/tomorrow.styl","hash":"15779cf6846725c7c35fc56cac39047d7e0aec1c","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/xcode.styl","hash":"5e8532ae8366dcf6a4ef5e4813dc3d42ab3d0a50","modified":1577520163313},{"_id":"themes/cactus/source/css/_highlight/zenburn.styl","hash":"68ff9332ccc03f9389b15b713415cde016f8088f","modified":1577520163313},{"_id":"themes/cactus/source/lib/clipboard/clipboard.min.js","hash":"ee60ca5ba9401456105ef703a98092369b579c80","modified":1577521235345},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff","hash":"9e8d954c46eaad8b8234fa906e9a268ee354dced","modified":1577521235381},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.woff2","hash":"f1c5d7523d21c2bf820d827c9d5df4184c3866dc","modified":1577521235381},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff","hash":"9376516725e502f4375e06cc4fa7d940e2c93251","modified":1577521235384},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.woff2","hash":"8d4810991aa94f958aff20a9cd381caf338e3061","modified":1577521235384},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff","hash":"cba77d3d16f7565f9ea79bd7657f4e00c7fe851f","modified":1577521235387},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.woff2","hash":"e520d5f6bf7ea3c1e4f2aef2abbbc6a6f9b697cb","modified":1577521235388},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff","hash":"2e8e3c873e6d98acc3c10aa84997104b276e1e68","modified":1577521235390},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.woff2","hash":"976b7aa7c2c2c049c548a25b5914cfbda74b0453","modified":1577521235391},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff2","hash":"baa42f95b41411b9aeaa6c7594e5ccee10d42ac4","modified":1577521235394},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.woff","hash":"f231111b3c778b7a5898ea88c0f150c0e72be468","modified":1577521235394},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff2","hash":"dc3c0ed67c9abb062b562e8553776f614d2946c2","modified":1577521235398},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.woff","hash":"c798391d624b9bb44497a87ffc4f7eb52042dceb","modified":1577521235397},{"_id":"themes/cactus/source/lib/vazir-font/font-face.css","hash":"2a95709b15ee45fc2328051038ceedddf83235bb","modified":1577521235398},{"_id":"themes/cactus/source/lib/jquery/jquery.min.js","hash":"88523924351bac0b5d560fe0c5781e2556e7693d","modified":1577521235377},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.ttf","hash":"23ee4a19421de9a0ca9dddc5435a8efe5bf28d87","modified":1577521235380},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Black.eot","hash":"603acd29416644e4b4fb8646abeada1865ba6869","modified":1577521235379},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.eot","hash":"9ef82b07f3adad7d644c9c3a6d35a0c727bd64e8","modified":1577521235382},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Bold.ttf","hash":"658c1da4f2a0124f6340058daa6873a86e6ba4fc","modified":1577521235383},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.ttf","hash":"b2372b67b9519fb4fa8e05de6c0ddae56845ff79","modified":1577521235386},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Light.eot","hash":"32f51bf715663f5ca419e138617fc05f7055aef5","modified":1577521235385},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.ttf","hash":"31cdbcc7215d01c9dd2beb8a28f8b7a7de75b9f4","modified":1577521235390},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Medium.eot","hash":"17be9f699c30f0384004b46e991db8ac38a9992e","modified":1577521235388},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.ttf","hash":"d53fcc2e2d6c9c77613afcd34058be1b75bb0fef","modified":1577521235393},{"_id":"themes/cactus/source/lib/vazir-font/Vazir-Thin.eot","hash":"2c0ebb336dd012da8d575cae0ee4d048b65fe6e1","modified":1577521235392},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.eot","hash":"bd3a7cb9eb70d36b4cfba8c5a05d234aefeefe3c","modified":1577521235395},{"_id":"themes/cactus/source/lib/vazir-font/Vazir.ttf","hash":"c7a3f2f4d56c4c4ec69d395baf39b55198da0254","modified":1577521235396},{"_id":"themes/cactus/source/images/logo.png","hash":"0e3029251dfda26adee2761f71377297e8c26871","modified":1577520163318},{"_id":"themes/cactus/source/css/_partial/post/actions_desktop.styl","hash":"dc726537928fc0d7703e73c0a5e4b82ad1731d59","modified":1577521235344},{"_id":"themes/cactus/source/css/_partial/post/actions_mobile.styl","hash":"0d2966c1d870392476864af8ee3ba312ba30cb82","modified":1577520163315},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.eot","hash":"3ad44eb5c276d1435408f253ca78da729a1aca90","modified":1577521235360},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.ttf","hash":"114f35e6d9053caca2ef6d1e34fea3f87a59245b","modified":1577521235361},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff","hash":"f3f0ea4847825806062a9b7a0f629671eb6b6408","modified":1577521235362},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"830f8653e5f4a5331ac0b47c5701f65fe9f1bb32","modified":1577521235363},{"_id":"themes/cactus/source/lib/justified-gallery/css/justifiedGallery.min.css","hash":"92bb6e468a1db7fbd99ccb960e15e28572254263","modified":1577520163338},{"_id":"themes/cactus/source/lib/justified-gallery/js/jquery.justifiedGallery.min.js","hash":"82ab395176c927ffbb2f7c95132ee0a06cd5d64a","modified":1577520163338},{"_id":"themes/cactus/source/lib/font-awesome/css/all.min.css","hash":"703603273f5d5d52eb456d6385e1a68294fbd568","modified":1577521235346},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"f356aa2e4d9b7245985d312d3bfba180f774e3b7","modified":1577521235359},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"b2c74520c3f506efbfefca867918e5ae28bd5222","modified":1577521235375},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.woff","hash":"91daac2bfba5e6a1a15ce44c53eab524d01c7fb0","modified":1577521235358},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.eot","hash":"d4987ee41e0e4142d561f76b8ea8e034c4d5d9d2","modified":1577521235349},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.ttf","hash":"f34ee061900ecd1ed3d3fd9f8f47f4e84c6d56bf","modified":1577521235357},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.woff","hash":"61f40daca6978e6e7ab761e748c2dd9d236c7586","modified":1577521235374},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-regular-400.svg","hash":"1622937e49766e21eacf4ac7065b711f0fe580e1","modified":1577521235361},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.ttf","hash":"91b40a8f284159d9fff81dc522670ef68d562682","modified":1577521235373},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.eot","hash":"be6b63d528286b1be2328d871c9bae95d8d57174","modified":1577521235364},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-BoldItalic.ttf","hash":"b542b9591fbf33925d93f0695b6e123a9f0cfd43","modified":1577520163353},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Italic.ttf","hash":"93ebc5098cf57a32b7b8d297681f31692c09bdfa","modified":1577520163354},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-BoldItalic.ttf","hash":"926035f0156cccf1b0ca507347f39bf9c510f51e","modified":1577520163356},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Italic.ttf","hash":"9d757cc9f928fc83b2133283dd639c12b11d94ad","modified":1577520163356},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Italic.ttf","hash":"9a23c6898b0943bd3d96c04df9a0f66e919451d8","modified":1577520163349},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-BoldItalic.ttf","hash":"b7d24ab1e4fad720f31a2b0cca1904ce1740d846","modified":1577520163347},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Bold.ttf","hash":"58be4b7760e9a84daa81929d046f9a15c4fd1c1a","modified":1577520163351},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Bold.ttf","hash":"f9918fb93d6ab6850f5d38069a999c311af78816","modified":1577520163355},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Regular.ttf","hash":"6c090d6bff3928fbf8a5f4104e58ed7f421aea7c","modified":1577520163350},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGS-Regular.ttf","hash":"de559f8d70d5b1ab2810597bfd0b1b9506f3ef01","modified":1577520163357},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGL-Bold.ttf","hash":"34f7db59f1d023294e69976aa20b7d52b86165a4","modified":1577520163345},{"_id":"themes/cactus/source/lib/meslo-LG/MesloLGM-Regular.ttf","hash":"20ce1fc7ae1254558ca044ae48283faaa58897e5","modified":1577520163354},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-brands-400.svg","hash":"29e6c7e5a4d63d2c9563cd208456cb4f8a357868","modified":1577521235355},{"_id":"themes/cactus/source/lib/font-awesome/webfonts/fa-solid-900.svg","hash":"3a090431fdec61a25ed69b9e6f35a6656bde1595","modified":1577521235371},{"_id":"public/2018/07/25/migrating-weechat-linux-macos/index.html","hash":"90de0f3eb4860c3b632898fccc55c8dc8c440be6","modified":1596178633704},{"_id":"public/2018/07/19/rsync-parallel/index.html","hash":"fa5b3fb7b090e05e53adc61cb7e7df3769df0922","modified":1596178633704},{"_id":"public/2018/06/02/compiling-a-single-module-linux-kernel/index.html","hash":"16569f0abe3e82d132121174b9d731cb4a84bcfb","modified":1596178633785},{"_id":"public/2018/06/02/ezjail-and-network-interfaces/index.html","hash":"8a2b931c1d83974d093e621d2cadab5948c917aa","modified":1596178633785},{"_id":"public/2017/10/29/whatsapp-chat-backup-getting-stuck/index.html","hash":"5aaa68e8d86c1036d3cfc515ee6eaea1dcc0c703","modified":1596178633787},{"_id":"public/2017/10/29/iOS-openvpn-connect-read-length-inconsistency/index.html","hash":"496bb9f6728825753197b3957a0e4482d6adfdad","modified":1596178633787},{"_id":"public/2017/01/19/say-no-to-catkin-make/index.html","hash":"21a093dd083978dcf30d9e90019ef1d657f04852","modified":1596178633787},{"_id":"public/2017/01/16/4chan-parallel-image-downloader/index.html","hash":"30c3f37126916f448e32928952cc0cc7c23264c4","modified":1596178633787},{"_id":"public/archives/index.html","hash":"52bcd8e061deb203b5f04fdcab1c3cb5667e8260","modified":1596178633787},{"_id":"public/archives/page/2/index.html","hash":"f11081ab9f5bd430acaf4d1fa90bab42177e1eaf","modified":1596178633787},{"_id":"public/archives/2017/index.html","hash":"e911292b94215e4f0f564faea397f43d4c855a8c","modified":1596178633787},{"_id":"public/archives/2017/01/index.html","hash":"0b99a75a44caea6cabcc404175ff0066e3ba206a","modified":1596178633787},{"_id":"public/archives/2017/03/index.html","hash":"2bbd3c4d8e43f1768b5a5a6c38561166bc3ac0fa","modified":1596178633787},{"_id":"public/archives/2017/05/index.html","hash":"65cfb88ddc2d11d26ab77b13f441d0ef5786bfd5","modified":1596178633787},{"_id":"public/archives/2017/07/index.html","hash":"1702b79e7d349517d673243b77b09e2196568376","modified":1596178633787},{"_id":"public/archives/2017/10/index.html","hash":"0388cc73d59207ee1a7000d5093a72ab562cc809","modified":1596178633787},{"_id":"public/archives/2018/index.html","hash":"366877876764d264dbee4821c87a61918dd05e1a","modified":1596178633788},{"_id":"public/archives/2018/06/index.html","hash":"fda5e92d3d174d4cb6aa5dc9a0349e6713b1923a","modified":1596178633788},{"_id":"public/archives/2018/07/index.html","hash":"2658d71eadbd2a8f329e793ac48bd580f3d6106b","modified":1596178633788},{"_id":"public/archives/2019/index.html","hash":"ae1b9066662cdd010bff39523c06d23d0a690479","modified":1596178633788},{"_id":"public/archives/2019/04/index.html","hash":"430823fb9df05585aaa0ed7c4bc677978b4375c8","modified":1596178633788},{"_id":"public/archives/2019/05/index.html","hash":"a567de7bc71313f8e7f3402703edc68b24477d7f","modified":1596178633788},{"_id":"public/archives/2019/12/index.html","hash":"78bcea5d3c7d8ee92ca5a093944fbdef48014281","modified":1596178633788},{"_id":"public/index.html","hash":"4506f1e62610bc22228cc841141e1411ca291182","modified":1596178633788},{"_id":"public/page/2/index.html","hash":"0fabc54d3661ee3a07bed43eaa036340a1a3566e","modified":1596178633788},{"_id":"public/2019/12/28/rtorrent-move-on-completion-flood/index.html","hash":"145756ba107b9cc950dfebbb132b1e641dd8a2b0","modified":1596178633788},{"_id":"public/2019/05/13/qemu-vm-wireguard-vpn-tun-tap-networking/index.html","hash":"05d8e09a1471d4ff2fe7ba910cb8552236e3f922","modified":1596178633788},{"_id":"public/2019/05/05/audio-changes-qemu-4-0-ac97-passthrough/index.html","hash":"ff1fb407337c222ac9bfec1d98f671df05b6a8d6","modified":1596178633788},{"_id":"public/2019/05/05/passthrough-disk-performance-zfs/index.html","hash":"4f901e367816fbc53e13cefb09162b70d122a038","modified":1596178633788},{"_id":"public/2019/04/25/rustcon-beijing/index.html","hash":"b75e3b3e26b2642affe48f69aae950142fe0fe6b","modified":1596178633788},{"_id":"public/2018/07/27/running-windows-with-pci-passthrough-on-gentoo-linux/index.html","hash":"98ba45ab1a8d606732867d51cc0a3719950ed4a4","modified":1596178633788},{"_id":"public/2018/07/16/coffee-lake-build-gentoo/index.html","hash":"24c02363c441b752c463bb7aa51db9a1e7233785","modified":1596178633788},{"_id":"public/2017/07/04/notes-on-flashing-the-esp8266-esp-01s/index.html","hash":"4b1efee68007ffae4b71cf428c33c6bc05f55c5f","modified":1596178633788},{"_id":"public/2017/05/09/ros-kinetic-macos-may17/index.html","hash":"8918bd301ef1c0cf5452b3903cb51026c1e6dc4c","modified":1596178633788},{"_id":"public/2017/03/09/sane-sshd-ipfw-defaults/index.html","hash":"41cf94c631447e276d7b9d90222edd6dd46c5ac1","modified":1596178633788},{"_id":"public/archives/2020/index.html","hash":"c40480ae6d428d6c251227936d261f261732a355","modified":1596178633795},{"_id":"public/archives/2020/07/index.html","hash":"eae22c2220f75b50d5fef1ab9abdd6e762766b94","modified":1596178633795},{"_id":"public/tags/passthrough/index.html","hash":"1cdc729cd484a929ca0f785c309b1aa90f5c2c33","modified":1596178633800},{"_id":"public/tags/shell-scripting/index.html","hash":"cec5d841db7691a6d8e88bfb697b36eefd5f9319","modified":1596178633800},{"_id":"public/tags/audio/index.html","hash":"ed31a71e5c9a6c41c8c51e8585a1c00458929e49","modified":1596178633800},{"_id":"public/tags/vm/index.html","hash":"7724b11a0ed61c9cadd1b77075a1bdd64585ea94","modified":1596178633800},{"_id":"public/tags/linux/index.html","hash":"4dfdebcdcd9d917c0bc324ccfcfc801321859603","modified":1596178633800},{"_id":"public/tags/kernel/index.html","hash":"33a93dcda16d227b00d78dd47d83b15aa25ad372","modified":1596178633800},{"_id":"public/tags/freebsd/index.html","hash":"d05fb279da5fa4d44458e4bab098278849727d63","modified":1596178633801},{"_id":"public/tags/ezjail/index.html","hash":"79b4a2eef988e226bc73b35d9ed684ccb0bc46f8","modified":1596178633801},{"_id":"public/tags/networking/index.html","hash":"2047e865c26d625f3996b0347599b248de22c22b","modified":1596178633801},{"_id":"public/tags/esp8266/index.html","hash":"613ec1108d1bbb47886b98c2ec67d5d575247c0b","modified":1596178633801},{"_id":"public/tags/weechat/index.html","hash":"be6c7a17a4e69210a2e0583228e291fbd54ab64d","modified":1596178633801},{"_id":"public/tags/ios-openvpn/index.html","hash":"2e55f41088a96eb8410bf745812937290943cbdc","modified":1596178633801},{"_id":"public/tags/zfs/index.html","hash":"efb94477b9718e15b78be6b11b90a09a690ff280","modified":1596178633801},{"_id":"public/tags/vfio/index.html","hash":"2aae0c63d3abd209e386cb4fa1448fa6591b2d91","modified":1596178633801},{"_id":"public/tags/qemu/index.html","hash":"00ed0d71469b5e285992bcf5d40d506a6f05baa2","modified":1596178633801},{"_id":"public/tags/ros/index.html","hash":"47551e3538b6fb4f2b76820177de2f28ba7ba942","modified":1596178633801},{"_id":"public/tags/wireguard/index.html","hash":"05abd146b5b659ffd51254493f9583c04f557cba","modified":1596178633801},{"_id":"public/tags/rtorrent/index.html","hash":"b116e2cf0f023580fd313113bf1b923911f77c4a","modified":1596178633801},{"_id":"public/tags/flood/index.html","hash":"d9bdd70bc939d096f7dd4a97d73ec7b3df0887cd","modified":1596178633801},{"_id":"public/tags/rust/index.html","hash":"4af4f7cf4394ea343849eddb23c29576fe767cbf","modified":1596178633801},{"_id":"public/tags/bittorrent/index.html","hash":"324d7faaaf23fefe0112e517a944cad02726be2a","modified":1596178633801},{"_id":"public/tags/conference/index.html","hash":"68e6958ed33228ddbfd7b4c38aeadff234e74d59","modified":1596178633801},{"_id":"public/tags/gentoo/index.html","hash":"4612c529050873645b92612bcbffdbdb1c11acaa","modified":1596178633802},{"_id":"public/tags/nvidia/index.html","hash":"c4bf588073d41bcbd84153ae11cb3b4c7b8f9d35","modified":1596178633802},{"_id":"public/tags/pci-passthrough/index.html","hash":"a3b058880a028606c9e92e19ad022e4de52d13b1","modified":1596178633802},{"_id":"public/tags/vpn/index.html","hash":"f4cbd43df3ef2f27885db2f55a2c3849ce72e1d6","modified":1596178633802},{"_id":"public/tags/ios/index.html","hash":"66052c45ca9d506f9b96f7fa075ac6f27fac7dcb","modified":1596178633802},{"_id":"public/2020/07/31/lamp-control-based-on-video-conferencing/index.html","hash":"94ef871ca3724aba6f6f40057446ee6484ae8ca0","modified":1596197680546},{"_id":"public/tags/automation/index.html","hash":"3cef0b4e42b34330d90561c9b5d5ce8df98cdcb1","modified":1596178633803},{"_id":"public/tags/macos/index.html","hash":"112cbb6db78e5e1973b026f9488f2c4d368bb3fa","modified":1596178633803}],"Category":[],"Data":[],"Page":[],"Post":[{"title":"Simple shell function to download images from 4chan threads in parallel","date":"2017-01-15T21:17:51.000Z","author":"alex","_content":"\nThis is an old function that I wrote  a while back to download content from 4chan threads. It stopped working recently since they changed the link format. Fixed it up because I was bored.\n\nIt uses `xargs` to dispatch downloads to threads and uses only commonly used unix tools. If we replace the `\\d` regex with `[0-9]` it'll work with plain `grep` without relying on PCRE.\n\n```sh\nfunction 4get() {\n  curl -k -s $1 | egrep -o \\\n    \"\\/\\/is\\d?\\.4chan\\.org\\/gif\\/\\d+\\.(webm|gif|jpeg|jpg|png)\" | \\\n    sed 's/^/https:/; s/is\\d?\\.4chan\\.org/i\\.4cdn\\.org/' | uniq | \\\n    xargs -n 1 -P 12 curl -# -O\n}\n```\n\nThe script can also be found on [gist](https://gist.github.com/spaghetti-/bd4fcbc6cd3a9b55b02940e78d24fdeb).\n","source":"_posts/4chan-parallel-image-downloader.md","raw":"---\ntitle: Simple shell function to download images from 4chan threads in parallel\ndate: 2017-01-16 05:17:51\nauthor: alex\ntags: shell, scripting\n---\n\nThis is an old function that I wrote  a while back to download content from 4chan threads. It stopped working recently since they changed the link format. Fixed it up because I was bored.\n\nIt uses `xargs` to dispatch downloads to threads and uses only commonly used unix tools. If we replace the `\\d` regex with `[0-9]` it'll work with plain `grep` without relying on PCRE.\n\n```sh\nfunction 4get() {\n  curl -k -s $1 | egrep -o \\\n    \"\\/\\/is\\d?\\.4chan\\.org\\/gif\\/\\d+\\.(webm|gif|jpeg|jpg|png)\" | \\\n    sed 's/^/https:/; s/is\\d?\\.4chan\\.org/i\\.4cdn\\.org/' | uniq | \\\n    xargs -n 1 -P 12 curl -# -O\n}\n```\n\nThe script can also be found on [gist](https://gist.github.com/spaghetti-/bd4fcbc6cd3a9b55b02940e78d24fdeb).\n","slug":"4chan-parallel-image-downloader","published":1,"updated":"2019-12-28T07:55:42.184Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9d00004ol3qklmgq8l","content":"<p>This is an old function that I wrote  a while back to download content from 4chan threads. It stopped working recently since they changed the link format. Fixed it up because I was bored.</p>\n<p>It uses <code>xargs</code> to dispatch downloads to threads and uses only commonly used unix tools. If we replace the <code>\\d</code> regex with <code>[0-9]</code> it’ll work with plain <code>grep</code> without relying on PCRE.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">4get</span></span>() &#123;</span><br><span class=\"line\">  curl -k -s <span class=\"variable\">$1</span> | egrep -o \\</span><br><span class=\"line\">    <span class=\"string\">\"\\/\\/is\\d?\\.4chan\\.org\\/gif\\/\\d+\\.(webm|gif|jpeg|jpg|png)\"</span> | \\</span><br><span class=\"line\">    sed <span class=\"string\">'s/^/https:/; s/is\\d?\\.4chan\\.org/i\\.4cdn\\.org/'</span> | uniq | \\</span><br><span class=\"line\">    xargs -n 1 -P 12 curl -<span class=\"comment\"># -O</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The script can also be found on <a href=\"https://gist.github.com/spaghetti-/bd4fcbc6cd3a9b55b02940e78d24fdeb\" target=\"_blank\" rel=\"noopener\">gist</a>.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>This is an old function that I wrote  a while back to download content from 4chan threads. It stopped working recently since they changed the link format. Fixed it up because I was bored.</p>\n<p>It uses <code>xargs</code> to dispatch downloads to threads and uses only commonly used unix tools. If we replace the <code>\\d</code> regex with <code>[0-9]</code> it’ll work with plain <code>grep</code> without relying on PCRE.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">4get</span></span>() &#123;</span><br><span class=\"line\">  curl -k -s <span class=\"variable\">$1</span> | egrep -o \\</span><br><span class=\"line\">    <span class=\"string\">\"\\/\\/is\\d?\\.4chan\\.org\\/gif\\/\\d+\\.(webm|gif|jpeg|jpg|png)\"</span> | \\</span><br><span class=\"line\">    sed <span class=\"string\">'s/^/https:/; s/is\\d?\\.4chan\\.org/i\\.4cdn\\.org/'</span> | uniq | \\</span><br><span class=\"line\">    xargs -n 1 -P 12 curl -<span class=\"comment\"># -O</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The script can also be found on <a href=\"https://gist.github.com/spaghetti-/bd4fcbc6cd3a9b55b02940e78d24fdeb\" target=\"_blank\" rel=\"noopener\">gist</a>.</p>\n"},{"title":"Changes in qemu 4.0 for passthrough (particularly for pulseaudio + ac97)","date":"2019-05-05T09:02:08.000Z","_content":"\n## Version\n\n```\nQEMU emulator version 4.0.0\n```\n\n```\nInstalled versions:  4.0.0(05:38:52 PM 05/04/2019)(aio alsa bzip2 caps curl fdt filecaps gtk iscsi jpeg ncurses nls opengl pin-upstream-blobs png pulseaudio sdl seccomp usb vhost-net vnc xattr -accessibi\nlity -capstone -debug -glusterfs -gnutls -infiniband -lzo -nfs -numa -python -rbd -sasl -selinux -smartcard -snappy -spice -ssh -static -static-user -systemtap -tci -test -usbredir -vde -virgl -virtfs -vte -x\nen -xfs KERNEL=\"linux -FreeBSD\" PYTHON_TARGETS=\"python2_7 python3_6 -python3_5 -python3_7\" QEMU_SOFTMMU_TARGETS=\"x86_64 -aarch64 -alpha -arm -cris -hppa -i386 -lm32 -m68k -microblaze -microblazeel -mips -mips\n64 -mips64el -mipsel -moxie -nios2 -or1k -ppc -ppc64 -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc64 -tricore -unicore32 -xtensa -xtensaeb\" QEMU_USER_TARGETS=\"-aarch64 -aarch64_be -alpha -arm -armeb -cri\ns -hppa -i386 -m68k -microblaze -microblazeel -mips -mips64 -mips64el -mipsel -mipsn32 -mipsn32el -nios2 -or1k -ppc -ppc64 -ppc64abi32 -ppc64le -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc32plus -sparc6\n4 -tilegx -x86_64 -xtensa -xtensaeb\")\n```\n## Machine Type\n\nTo integrate a few audio patches I upgraded the machine type from 3.0 to 4.0.\nTurns out when you upgrade the machine type you also need `kernel_irqchip=on` or\nthe nvidia driver wont work.\n\n```\n-  -machine pc-q35-3.0,accel=kvm \\\n+  -machine pc-q35-4.0,kernel_irqchip=on,accel=kvm \\\n```\n\n## Audio dev\n\nWith the previous patch I had to do\n\n```\nexport QEMU_AUDIO_DRV=pa\n```\n\nwhich will now cause qemu to abort immediately on launch with `-soundhw ac97`.\nInstead we should do\n\n```\n+  -audiodev pa,id=pa1,server=`pactl info | grep 'Server String' | awk '{print $3}'`\n```\n\nNote how I've to get the pulse socket dynamically from `pactl` on my\nsystemd free Gentoo installation. If it's on a systemd machine it can be\nreplaced with `server=/run/user/1000/pulse/native`.\n\nThanks to /u/spheenik [(reddit announcement)](https://www.reddit.com/r/VFIO/comments/b1crpi/qemu_40_due_soon_might_bring_superb_audio_test_now/) whose audio patches I've been using\nfor a long time.\n","source":"_posts/audio-changes-qemu-4-0-ac97-passthrough.md","raw":"---\ntitle: Changes in qemu 4.0 for passthrough (particularly for pulseaudio + ac97)\ndate: 2019-05-05 17:02:08\ntags:\n  - vm\n  - audio\n  - passthrough\n---\n\n## Version\n\n```\nQEMU emulator version 4.0.0\n```\n\n```\nInstalled versions:  4.0.0(05:38:52 PM 05/04/2019)(aio alsa bzip2 caps curl fdt filecaps gtk iscsi jpeg ncurses nls opengl pin-upstream-blobs png pulseaudio sdl seccomp usb vhost-net vnc xattr -accessibi\nlity -capstone -debug -glusterfs -gnutls -infiniband -lzo -nfs -numa -python -rbd -sasl -selinux -smartcard -snappy -spice -ssh -static -static-user -systemtap -tci -test -usbredir -vde -virgl -virtfs -vte -x\nen -xfs KERNEL=\"linux -FreeBSD\" PYTHON_TARGETS=\"python2_7 python3_6 -python3_5 -python3_7\" QEMU_SOFTMMU_TARGETS=\"x86_64 -aarch64 -alpha -arm -cris -hppa -i386 -lm32 -m68k -microblaze -microblazeel -mips -mips\n64 -mips64el -mipsel -moxie -nios2 -or1k -ppc -ppc64 -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc64 -tricore -unicore32 -xtensa -xtensaeb\" QEMU_USER_TARGETS=\"-aarch64 -aarch64_be -alpha -arm -armeb -cri\ns -hppa -i386 -m68k -microblaze -microblazeel -mips -mips64 -mips64el -mipsel -mipsn32 -mipsn32el -nios2 -or1k -ppc -ppc64 -ppc64abi32 -ppc64le -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc32plus -sparc6\n4 -tilegx -x86_64 -xtensa -xtensaeb\")\n```\n## Machine Type\n\nTo integrate a few audio patches I upgraded the machine type from 3.0 to 4.0.\nTurns out when you upgrade the machine type you also need `kernel_irqchip=on` or\nthe nvidia driver wont work.\n\n```\n-  -machine pc-q35-3.0,accel=kvm \\\n+  -machine pc-q35-4.0,kernel_irqchip=on,accel=kvm \\\n```\n\n## Audio dev\n\nWith the previous patch I had to do\n\n```\nexport QEMU_AUDIO_DRV=pa\n```\n\nwhich will now cause qemu to abort immediately on launch with `-soundhw ac97`.\nInstead we should do\n\n```\n+  -audiodev pa,id=pa1,server=`pactl info | grep 'Server String' | awk '{print $3}'`\n```\n\nNote how I've to get the pulse socket dynamically from `pactl` on my\nsystemd free Gentoo installation. If it's on a systemd machine it can be\nreplaced with `server=/run/user/1000/pulse/native`.\n\nThanks to /u/spheenik [(reddit announcement)](https://www.reddit.com/r/VFIO/comments/b1crpi/qemu_40_due_soon_might_bring_superb_audio_test_now/) whose audio patches I've been using\nfor a long time.\n","slug":"audio-changes-qemu-4-0-ac97-passthrough","published":1,"updated":"2019-12-28T07:55:42.185Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9h00014ol3w7lxp6nv","content":"<h2 id=\"Version\"><a href=\"#Version\" class=\"headerlink\" title=\"Version\"></a>Version</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">QEMU emulator version 4.0.0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Installed versions:  4.0.0(05:38:52 PM 05/04/2019)(aio alsa bzip2 caps curl fdt filecaps gtk iscsi jpeg ncurses nls opengl pin-upstream-blobs png pulseaudio sdl seccomp usb vhost-net vnc xattr -accessibi</span><br><span class=\"line\">lity -capstone -debug -glusterfs -gnutls -infiniband -lzo -nfs -numa -python -rbd -sasl -selinux -smartcard -snappy -spice -ssh -static -static-user -systemtap -tci -test -usbredir -vde -virgl -virtfs -vte -x</span><br><span class=\"line\">en -xfs KERNEL=&quot;linux -FreeBSD&quot; PYTHON_TARGETS=&quot;python2_7 python3_6 -python3_5 -python3_7&quot; QEMU_SOFTMMU_TARGETS=&quot;x86_64 -aarch64 -alpha -arm -cris -hppa -i386 -lm32 -m68k -microblaze -microblazeel -mips -mips</span><br><span class=\"line\">64 -mips64el -mipsel -moxie -nios2 -or1k -ppc -ppc64 -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc64 -tricore -unicore32 -xtensa -xtensaeb&quot; QEMU_USER_TARGETS=&quot;-aarch64 -aarch64_be -alpha -arm -armeb -cri</span><br><span class=\"line\">s -hppa -i386 -m68k -microblaze -microblazeel -mips -mips64 -mips64el -mipsel -mipsn32 -mipsn32el -nios2 -or1k -ppc -ppc64 -ppc64abi32 -ppc64le -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc32plus -sparc6</span><br><span class=\"line\">4 -tilegx -x86_64 -xtensa -xtensaeb&quot;)</span><br></pre></td></tr></table></figure>\n<h2 id=\"Machine-Type\"><a href=\"#Machine-Type\" class=\"headerlink\" title=\"Machine Type\"></a>Machine Type</h2><p>To integrate a few audio patches I upgraded the machine type from 3.0 to 4.0.\nTurns out when you upgrade the machine type you also need <code>kernel_irqchip=on</code> or\nthe nvidia driver wont work.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-  -machine pc-q35-3.0,accel=kvm \\</span><br><span class=\"line\">+  -machine pc-q35-4.0,kernel_irqchip=on,accel=kvm \\</span><br></pre></td></tr></table></figure>\n<h2 id=\"Audio-dev\"><a href=\"#Audio-dev\" class=\"headerlink\" title=\"Audio dev\"></a>Audio dev</h2><p>With the previous patch I had to do</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export QEMU_AUDIO_DRV=pa</span><br></pre></td></tr></table></figure>\n<p>which will now cause qemu to abort immediately on launch with <code>-soundhw ac97</code>.\nInstead we should do</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+  -audiodev pa,id=pa1,server=`pactl info | grep &apos;Server String&apos; | awk &apos;&#123;print $3&#125;&apos;`</span><br></pre></td></tr></table></figure>\n<p>Note how I’ve to get the pulse socket dynamically from <code>pactl</code> on my\nsystemd free Gentoo installation. If it’s on a systemd machine it can be\nreplaced with <code>server=/run/user/1000/pulse/native</code>.</p>\n<p>Thanks to /u/spheenik <a href=\"https://www.reddit.com/r/VFIO/comments/b1crpi/qemu_40_due_soon_might_bring_superb_audio_test_now/\" target=\"_blank\" rel=\"noopener\">(reddit announcement)</a> whose audio patches I’ve been using\nfor a long time.</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Version\"><a href=\"#Version\" class=\"headerlink\" title=\"Version\"></a>Version</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">QEMU emulator version 4.0.0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Installed versions:  4.0.0(05:38:52 PM 05/04/2019)(aio alsa bzip2 caps curl fdt filecaps gtk iscsi jpeg ncurses nls opengl pin-upstream-blobs png pulseaudio sdl seccomp usb vhost-net vnc xattr -accessibi</span><br><span class=\"line\">lity -capstone -debug -glusterfs -gnutls -infiniband -lzo -nfs -numa -python -rbd -sasl -selinux -smartcard -snappy -spice -ssh -static -static-user -systemtap -tci -test -usbredir -vde -virgl -virtfs -vte -x</span><br><span class=\"line\">en -xfs KERNEL=&quot;linux -FreeBSD&quot; PYTHON_TARGETS=&quot;python2_7 python3_6 -python3_5 -python3_7&quot; QEMU_SOFTMMU_TARGETS=&quot;x86_64 -aarch64 -alpha -arm -cris -hppa -i386 -lm32 -m68k -microblaze -microblazeel -mips -mips</span><br><span class=\"line\">64 -mips64el -mipsel -moxie -nios2 -or1k -ppc -ppc64 -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc64 -tricore -unicore32 -xtensa -xtensaeb&quot; QEMU_USER_TARGETS=&quot;-aarch64 -aarch64_be -alpha -arm -armeb -cri</span><br><span class=\"line\">s -hppa -i386 -m68k -microblaze -microblazeel -mips -mips64 -mips64el -mipsel -mipsn32 -mipsn32el -nios2 -or1k -ppc -ppc64 -ppc64abi32 -ppc64le -riscv32 -riscv64 -s390x -sh4 -sh4eb -sparc -sparc32plus -sparc6</span><br><span class=\"line\">4 -tilegx -x86_64 -xtensa -xtensaeb&quot;)</span><br></pre></td></tr></table></figure>\n<h2 id=\"Machine-Type\"><a href=\"#Machine-Type\" class=\"headerlink\" title=\"Machine Type\"></a>Machine Type</h2><p>To integrate a few audio patches I upgraded the machine type from 3.0 to 4.0.\nTurns out when you upgrade the machine type you also need <code>kernel_irqchip=on</code> or\nthe nvidia driver wont work.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-  -machine pc-q35-3.0,accel=kvm \\</span><br><span class=\"line\">+  -machine pc-q35-4.0,kernel_irqchip=on,accel=kvm \\</span><br></pre></td></tr></table></figure>\n<h2 id=\"Audio-dev\"><a href=\"#Audio-dev\" class=\"headerlink\" title=\"Audio dev\"></a>Audio dev</h2><p>With the previous patch I had to do</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export QEMU_AUDIO_DRV=pa</span><br></pre></td></tr></table></figure>\n<p>which will now cause qemu to abort immediately on launch with <code>-soundhw ac97</code>.\nInstead we should do</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+  -audiodev pa,id=pa1,server=`pactl info | grep &apos;Server String&apos; | awk &apos;&#123;print $3&#125;&apos;`</span><br></pre></td></tr></table></figure>\n<p>Note how I’ve to get the pulse socket dynamically from <code>pactl</code> on my\nsystemd free Gentoo installation. If it’s on a systemd machine it can be\nreplaced with <code>server=/run/user/1000/pulse/native</code>.</p>\n<p>Thanks to /u/spheenik <a href=\"https://www.reddit.com/r/VFIO/comments/b1crpi/qemu_40_due_soon_might_bring_superb_audio_test_now/\" target=\"_blank\" rel=\"noopener\">(reddit announcement)</a> whose audio patches I’ve been using\nfor a long time.</p>\n"},{"title":"Compiling a single linux kernel module with matching vermagic","date":"2018-06-02T09:46:46.000Z","_content":"\nI recently got locked out of a server because of configuration mistake and had\nto rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host\nthat booted). My root was running on UFS and as expected Ubuntu does not come\nwith a write enabled UFS kernel module.\n\nI set up a virtual build box on my local machine as it was faster than setting\neverything up on the netboot'd image (plus since it was totally in memory, if\nanything went wrong it'd be best to setup tooling offline). But just in case we\nneed to remember, the dependencies are \n\n```\nlibncurses-dev\nlibssl\nbuild-essentials\nbc\n```\nAfter booting into the Ubuntu 16.04 image, we can then fetch the kernel source \nby doing\n\n```sh\napt-get source linux-image-`uname -r`\n```\n\nThis would install `/usr/src/linux-headers-version` (replace version) with the\nkernel source. Then we need to scp the `Makefile` found in the directory to the\nsame directory on our build box.\n\nWe can then enable `UFS_FS_WRITE=y` in the kernel config. Then call\n\n```\nmake oldconfig\nmake prepare\nmake modules_prepare\nmake M=fs/ufs/ modules\n```\n\nThen the resulting `ufs.ko` can be scp'd back to the server to be loaded. The\nvermagic will match if the same `Makefile` was used across both kernel\ncompilations.\n","source":"_posts/compiling-a-single-module-linux-kernel.md","raw":"---\ntitle: Compiling a single linux kernel module with matching vermagic\ndate: 2018-06-02 17:46:46\ntags: \n  - linux\n  - kernel\n---\n\nI recently got locked out of a server because of configuration mistake and had\nto rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host\nthat booted). My root was running on UFS and as expected Ubuntu does not come\nwith a write enabled UFS kernel module.\n\nI set up a virtual build box on my local machine as it was faster than setting\neverything up on the netboot'd image (plus since it was totally in memory, if\nanything went wrong it'd be best to setup tooling offline). But just in case we\nneed to remember, the dependencies are \n\n```\nlibncurses-dev\nlibssl\nbuild-essentials\nbc\n```\nAfter booting into the Ubuntu 16.04 image, we can then fetch the kernel source \nby doing\n\n```sh\napt-get source linux-image-`uname -r`\n```\n\nThis would install `/usr/src/linux-headers-version` (replace version) with the\nkernel source. Then we need to scp the `Makefile` found in the directory to the\nsame directory on our build box.\n\nWe can then enable `UFS_FS_WRITE=y` in the kernel config. Then call\n\n```\nmake oldconfig\nmake prepare\nmake modules_prepare\nmake M=fs/ufs/ modules\n```\n\nThen the resulting `ufs.ko` can be scp'd back to the server to be loaded. The\nvermagic will match if the same `Makefile` was used across both kernel\ncompilations.\n","slug":"compiling-a-single-module-linux-kernel","published":1,"updated":"2019-12-28T07:55:42.185Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9k00034ol3chan1kpe","content":"<p>I recently got locked out of a server because of configuration mistake and had\nto rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host\nthat booted). My root was running on UFS and as expected Ubuntu does not come\nwith a write enabled UFS kernel module.</p>\n<p>I set up a virtual build box on my local machine as it was faster than setting\neverything up on the netboot’d image (plus since it was totally in memory, if\nanything went wrong it’d be best to setup tooling offline). But just in case we\nneed to remember, the dependencies are </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">libncurses-dev</span><br><span class=\"line\">libssl</span><br><span class=\"line\">build-essentials</span><br><span class=\"line\">bc</span><br></pre></td></tr></table></figure>\n<p>After booting into the Ubuntu 16.04 image, we can then fetch the kernel source \nby doing</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get <span class=\"built_in\">source</span> linux-image-`uname -r`</span><br></pre></td></tr></table></figure>\n<p>This would install <code>/usr/src/linux-headers-version</code> (replace version) with the\nkernel source. Then we need to scp the <code>Makefile</code> found in the directory to the\nsame directory on our build box.</p>\n<p>We can then enable <code>UFS_FS_WRITE=y</code> in the kernel config. Then call</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make oldconfig</span><br><span class=\"line\">make prepare</span><br><span class=\"line\">make modules_prepare</span><br><span class=\"line\">make M=fs/ufs/ modules</span><br></pre></td></tr></table></figure>\n<p>Then the resulting <code>ufs.ko</code> can be scp’d back to the server to be loaded. The\nvermagic will match if the same <code>Makefile</code> was used across both kernel\ncompilations.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I recently got locked out of a server because of configuration mistake and had\nto rescue a FreeBSD server by netbooting Ubuntu (only image provided by the host\nthat booted). My root was running on UFS and as expected Ubuntu does not come\nwith a write enabled UFS kernel module.</p>\n<p>I set up a virtual build box on my local machine as it was faster than setting\neverything up on the netboot’d image (plus since it was totally in memory, if\nanything went wrong it’d be best to setup tooling offline). But just in case we\nneed to remember, the dependencies are </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">libncurses-dev</span><br><span class=\"line\">libssl</span><br><span class=\"line\">build-essentials</span><br><span class=\"line\">bc</span><br></pre></td></tr></table></figure>\n<p>After booting into the Ubuntu 16.04 image, we can then fetch the kernel source \nby doing</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get <span class=\"built_in\">source</span> linux-image-`uname -r`</span><br></pre></td></tr></table></figure>\n<p>This would install <code>/usr/src/linux-headers-version</code> (replace version) with the\nkernel source. Then we need to scp the <code>Makefile</code> found in the directory to the\nsame directory on our build box.</p>\n<p>We can then enable <code>UFS_FS_WRITE=y</code> in the kernel config. Then call</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make oldconfig</span><br><span class=\"line\">make prepare</span><br><span class=\"line\">make modules_prepare</span><br><span class=\"line\">make M=fs/ufs/ modules</span><br></pre></td></tr></table></figure>\n<p>Then the resulting <code>ufs.ko</code> can be scp’d back to the server to be loaded. The\nvermagic will match if the same <code>Makefile</code> was used across both kernel\ncompilations.</p>\n"},{"title":"ezjail and Network Interfaces","date":"2018-06-02T09:31:06.000Z","_content":"\nI was updating and adding a new service to one of my servers when I needed to\nfiddle with ezjail. ezjail, as its name suggests, makes creating and maintaing\njails quite simple. According to the [handbook](https://www.freebsd.org/doc/handbook/jails-ezjail.html) we can create jails by doing\n\n```sh\nezjail-admin create dnsjail 'lo1|127.0.1.1,em0|192.168.1.50'\n```\n\nAfter changing the ip to match your needs obviously, but it fails to mention\nthat if you have a problem with the second part `em0`, which is often your\nexternal interface, `ezjail-admin restart jail` will tear down your default\nroute and all connectivity to the interface. `ezjail` adds aliases to it and I\nam guessing, on tear down it also downs the primary ip.\n\nI've been meaning to add a warning to the handbook when I get some time.\n\nTo prevent mishaps from happening in the future I reccomend onestarting ezjail\nwhen making changes. If youve set (as you do) `ezjail_enable=\"YES\"` in rc.conf,\nthe problem with the external interface will persist through reboots. If you\ndon't have serial console setup on the server you are out of luck without\nrescuing via netboot.\n\nAs it turns out, online.net's FreeBSD rescue images that they provide for rescue\ndon't boot either and you're forced to go with ubuntu which does not come with a\nwrite enabled UFS driver by default. The kernel also compiles by default\ndisallowing force loading kernel modules with vermagic mismatches.\n\nTo get around it, I had to first get the source for the running kernel by doing\n\n```sh\napt-get source linux-image-`uname -r`\n```\nand then by copying over the `Makefile` from `/usr/src/linux-*` to your own\nbuild machine and then compiling the single module with our changes (enabling\nwrite). The module was then copied back to the server and loaded in, which\nallowed us to mound the root as readwrite. rc.conf was then modified and\nrebooted.\n\nMore information on compiling singular kernel modules can be found here.\n","source":"_posts/ezjail-and-network-interfaces.md","raw":"---\ntitle: ezjail and Network Interfaces\ndate: 2018-06-02 17:31:06\ntags: \n  - ezjail\n  - freebsd\n  - networking\n---\n\nI was updating and adding a new service to one of my servers when I needed to\nfiddle with ezjail. ezjail, as its name suggests, makes creating and maintaing\njails quite simple. According to the [handbook](https://www.freebsd.org/doc/handbook/jails-ezjail.html) we can create jails by doing\n\n```sh\nezjail-admin create dnsjail 'lo1|127.0.1.1,em0|192.168.1.50'\n```\n\nAfter changing the ip to match your needs obviously, but it fails to mention\nthat if you have a problem with the second part `em0`, which is often your\nexternal interface, `ezjail-admin restart jail` will tear down your default\nroute and all connectivity to the interface. `ezjail` adds aliases to it and I\nam guessing, on tear down it also downs the primary ip.\n\nI've been meaning to add a warning to the handbook when I get some time.\n\nTo prevent mishaps from happening in the future I reccomend onestarting ezjail\nwhen making changes. If youve set (as you do) `ezjail_enable=\"YES\"` in rc.conf,\nthe problem with the external interface will persist through reboots. If you\ndon't have serial console setup on the server you are out of luck without\nrescuing via netboot.\n\nAs it turns out, online.net's FreeBSD rescue images that they provide for rescue\ndon't boot either and you're forced to go with ubuntu which does not come with a\nwrite enabled UFS driver by default. The kernel also compiles by default\ndisallowing force loading kernel modules with vermagic mismatches.\n\nTo get around it, I had to first get the source for the running kernel by doing\n\n```sh\napt-get source linux-image-`uname -r`\n```\nand then by copying over the `Makefile` from `/usr/src/linux-*` to your own\nbuild machine and then compiling the single module with our changes (enabling\nwrite). The module was then copied back to the server and loaded in, which\nallowed us to mound the root as readwrite. rc.conf was then modified and\nrebooted.\n\nMore information on compiling singular kernel modules can be found here.\n","slug":"ezjail-and-network-interfaces","published":1,"updated":"2019-12-28T07:55:42.185Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9l00044ol3jcpbbfva","content":"<p>I was updating and adding a new service to one of my servers when I needed to\nfiddle with ezjail. ezjail, as its name suggests, makes creating and maintaing\njails quite simple. According to the <a href=\"https://www.freebsd.org/doc/handbook/jails-ezjail.html\" target=\"_blank\" rel=\"noopener\">handbook</a> we can create jails by doing</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ezjail-admin create dnsjail <span class=\"string\">'lo1|127.0.1.1,em0|192.168.1.50'</span></span><br></pre></td></tr></table></figure>\n<p>After changing the ip to match your needs obviously, but it fails to mention\nthat if you have a problem with the second part <code>em0</code>, which is often your\nexternal interface, <code>ezjail-admin restart jail</code> will tear down your default\nroute and all connectivity to the interface. <code>ezjail</code> adds aliases to it and I\nam guessing, on tear down it also downs the primary ip.</p>\n<p>I’ve been meaning to add a warning to the handbook when I get some time.</p>\n<p>To prevent mishaps from happening in the future I reccomend onestarting ezjail\nwhen making changes. If youve set (as you do) <code>ezjail_enable=&quot;YES&quot;</code> in rc.conf,\nthe problem with the external interface will persist through reboots. If you\ndon’t have serial console setup on the server you are out of luck without\nrescuing via netboot.</p>\n<p>As it turns out, online.net’s FreeBSD rescue images that they provide for rescue\ndon’t boot either and you’re forced to go with ubuntu which does not come with a\nwrite enabled UFS driver by default. The kernel also compiles by default\ndisallowing force loading kernel modules with vermagic mismatches.</p>\n<p>To get around it, I had to first get the source for the running kernel by doing</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get <span class=\"built_in\">source</span> linux-image-`uname -r`</span><br></pre></td></tr></table></figure>\n<p>and then by copying over the <code>Makefile</code> from <code>/usr/src/linux-*</code> to your own\nbuild machine and then compiling the single module with our changes (enabling\nwrite). The module was then copied back to the server and loaded in, which\nallowed us to mound the root as readwrite. rc.conf was then modified and\nrebooted.</p>\n<p>More information on compiling singular kernel modules can be found here.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I was updating and adding a new service to one of my servers when I needed to\nfiddle with ezjail. ezjail, as its name suggests, makes creating and maintaing\njails quite simple. According to the <a href=\"https://www.freebsd.org/doc/handbook/jails-ezjail.html\" target=\"_blank\" rel=\"noopener\">handbook</a> we can create jails by doing</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ezjail-admin create dnsjail <span class=\"string\">'lo1|127.0.1.1,em0|192.168.1.50'</span></span><br></pre></td></tr></table></figure>\n<p>After changing the ip to match your needs obviously, but it fails to mention\nthat if you have a problem with the second part <code>em0</code>, which is often your\nexternal interface, <code>ezjail-admin restart jail</code> will tear down your default\nroute and all connectivity to the interface. <code>ezjail</code> adds aliases to it and I\nam guessing, on tear down it also downs the primary ip.</p>\n<p>I’ve been meaning to add a warning to the handbook when I get some time.</p>\n<p>To prevent mishaps from happening in the future I reccomend onestarting ezjail\nwhen making changes. If youve set (as you do) <code>ezjail_enable=&quot;YES&quot;</code> in rc.conf,\nthe problem with the external interface will persist through reboots. If you\ndon’t have serial console setup on the server you are out of luck without\nrescuing via netboot.</p>\n<p>As it turns out, online.net’s FreeBSD rescue images that they provide for rescue\ndon’t boot either and you’re forced to go with ubuntu which does not come with a\nwrite enabled UFS driver by default. The kernel also compiles by default\ndisallowing force loading kernel modules with vermagic mismatches.</p>\n<p>To get around it, I had to first get the source for the running kernel by doing</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get <span class=\"built_in\">source</span> linux-image-`uname -r`</span><br></pre></td></tr></table></figure>\n<p>and then by copying over the <code>Makefile</code> from <code>/usr/src/linux-*</code> to your own\nbuild machine and then compiling the single module with our changes (enabling\nwrite). The module was then copied back to the server and loaded in, which\nallowed us to mound the root as readwrite. rc.conf was then modified and\nrebooted.</p>\n<p>More information on compiling singular kernel modules can be found here.</p>\n"},{"title":"Minor details and fixes for a Coffee Lake build on Gentoo Linux","date":"2018-07-16T06:45:45.000Z","_content":"\nCPU: Intel i7-8700k\n\nCooler: Cryorig H5 Ultimate\n\nMobo: MSI z370 A-pro\n\nRAM: GSkill RipJaws V 16gb @ 3000 MHz\n\nDisk: Samsung EVO 970 M.2 NVMe 250\n\nCase: NZXT H500\n\nGPU: Nvidia 1080 GTX (GALAX, OC SNPR dual fans, white)\n\nOS: Gentoo Linux\n\nCooler installation\n-------------------\n\nThe H5 is tricky to install, preferably watch the youtube installation video\nbefore attempting. Thermal compound is provided, don't get an extra tube unless\nyou need it.\n\nMonitor temps after you install it - mine idles at 22-30C, the room ambient is\n22-25C.\n\nMotherboard specific stuff\n--------------------------\n\nInstallation: the NZXT case does not provide all 8 (?) mounting screws for the\nmobo, but that is OK. When I installed it I slightly bent a catch on the\nbackplate for the IO board, but no biggies.\n\nSave settings and boot is F10.\n\nRAM speed most likely will be detected wrong. It can be changed by going to BIOS\nand to the OC section (toggle advanced with F7). \n\nChange boot mode to UEFI instead of Legacy + UEFI if you are planning on booting\nfrom that.\n\nIOMMU (VT-d feature) is disabled on this board by default. Turn it on in the OC\nsection -> CPU features. This processor supports it.\n\nCaveat: This motherboard does *not* come with A LOT of USB ports, and I can only\nfind 1 host controller. This may be an annoyance if you want to pass an entire\nhost controller through to the guest VM in passthrough.\n\nWhen booting in UEFI mode its supposed to look at `$ESP/EFI` but some\nmanufacturers get it wrong apparently. When doing grub install we need to add\n`--removable`.\n\n```\ngrub-install --target=x86_64-efi --efi-directory=/boot --removable\n```\n\nMotherboard display stuff\n\nAdvanced -> Integrated Graphics Configuration\nInitiate Graphics Adapter -> Set to PEG (PCIe first)\nIGD multi monitor support -> Enable (to enable the i915 chip)\n\n\nSet gentoo-sources to use ~amd64 keyword then emerge to get (at the time of\nwriting) 4.17.6. This will load i915 automatically for the integrated GPU.\n\nIf you are on an older kernel version you need `i915.alpha_support=1` in your\nkernel boot parameters (edit grub.cfg).\n\nNVMe Disk\n---------\n\nBuild in the NVMe driver to the kernel (*not* as a module).\n\n```\nCONFIG_NVME_CORE=y\nCONFIG_BLK_DEV_NVME=y\n```\n\nMore disk\n---------\n\nEnable ZFS. Note that the wiki is slightly out of date \n\njust install zfs-kmod and zfs.\n\n\n```\necho \"=sys-fs/zfs-kmod-9999 **\" >> /etc/portage/package.accept_keywords/zfs-kmod\necho \"=sys-fs/zfs-9999 **\" >> /etc/portage/package.accept_keywords/zfs \n# when upgrading kernel\n# after eselect kernel set n\n# run make prepare in /usr/srx/linux\nenv EXTRA_ECONF='--enable-linux-builtin' \\\n    ebuild /usr/portage/sys-fs/zfs-kmod/zfs-kmod-9999.ebuild clean configure\n(cd /var/tmp/portage/sys-fs/zfs-kmod-9999/work/zfs-kmod-9999/ && ./copy-builtin /usr/src/linux)\n```\n\nThen enable ZFS kernel module `CONFIG_ZFS` and build.\n\nThen rebuild the nvidia driver just in case\n\n`emerge -a @module-rebuild`\n\nCPU Governor\n------------\n\nSet to `performance` and enable the intel pstate driver (default).\n\nSSH\n---\n\nEdit the SSHD config and remove `AcceptEnv`. I always SSH from MacOS machines\nand we do not want to be setting env like `LC_CTYPE=UTF-8` because glibc does not\nsupport that by default.\n\nChange authentication to publickey only, copy key over and restart sshd.\n\n```sh\nssh alex@trixie '>> .ssh/authorized_keys' < id_rsa.pub\n```\n\nCurrent monitor setup\n---------------------\n\n```\n                                +--------------+    +--------------+\n                                |  2560x1440   |    | 2560x1440    |\n                                |  MST on      |    | MST off      |\n                                |  DP1.2       |    |              |\n                                |              |    |              |\n                                +-----+--------+    +----+---------+\n                             mDP in|  |     |DP out      |  DP in\n                                   |  |     |            |\n                                   |  |     |            |\n                                   |  |     |            |\n+------------+DP out               |  |     +------------+\n|  Intel     +---------------------+  |\n|  Onboard   |                        |\n|            |                        |\n+------------+                        |\n                                      |\n+------------+        DP              |\n|            +------------------------+\n| GTX 1080   |\n|            |\n+------------+\n```\n\nIn make.conf when setting `VIDEO_CARDS` set `nvidia intel i965`\n\n\nPlan -\n\n  * When system boots it boots off the 1080 as the boot GPU\n  * Xorg starts on 1080 with i3 as the wm, puts workspace 2 on the second\n  monitor\n  * When we need to unbind, we kill X, start X on i915, workspace 2 moves over\n  * PCIe unbind, rebind into VM\n\n\nCreate an intel xorg config\n\nadded this to startx\n\n```\nif [ -f /tmp/vm.lock ]; then\n        serverargs=\"-config intel.xorg.conf\"\nfi\n```\n\nand intel.xorg.conf\n```\nSection \"Device\"\n        Identifier  \"intel\"\n        Driver      \"modesetting\"\n        BusID       \"PCI:0:2:0\"\nEndSection\n```\n\n# Controlling the displays\n\nInstall ddccontrol to use the DDC channels over DP\n\nthis DOES NOT WORK over nvidia GPUs (modern ones anyway) over DP (but it is\nknown to work over HDMI). \n\nHere's what you need to do: enable i2c support:\n\nhttps://wiki.gentoo.org/wiki/I2C (enable everything in this wiki)\n\nthen run\n\n```\nddccontrol -p -v\n```\n\nto probe\n\nthen for DP\n\n```\nddccontrol -r 0x60 -w 15 dev:/dev/i2c-3 #DP\nddccontrol -r 0x60 -w 16 dev:/dev/i2c-3 #mDP\n```\n\nsource: https://askubuntu.com/questions/860761/ubuntu-command-line-to-change-input-source-on-a-display-monitor\n","source":"_posts/coffee-lake-build-gentoo.md","raw":"---\ntitle: Minor details and fixes for a Coffee Lake build on Gentoo Linux\ndate: 2018-07-16 14:45:45\ntags:\n---\n\nCPU: Intel i7-8700k\n\nCooler: Cryorig H5 Ultimate\n\nMobo: MSI z370 A-pro\n\nRAM: GSkill RipJaws V 16gb @ 3000 MHz\n\nDisk: Samsung EVO 970 M.2 NVMe 250\n\nCase: NZXT H500\n\nGPU: Nvidia 1080 GTX (GALAX, OC SNPR dual fans, white)\n\nOS: Gentoo Linux\n\nCooler installation\n-------------------\n\nThe H5 is tricky to install, preferably watch the youtube installation video\nbefore attempting. Thermal compound is provided, don't get an extra tube unless\nyou need it.\n\nMonitor temps after you install it - mine idles at 22-30C, the room ambient is\n22-25C.\n\nMotherboard specific stuff\n--------------------------\n\nInstallation: the NZXT case does not provide all 8 (?) mounting screws for the\nmobo, but that is OK. When I installed it I slightly bent a catch on the\nbackplate for the IO board, but no biggies.\n\nSave settings and boot is F10.\n\nRAM speed most likely will be detected wrong. It can be changed by going to BIOS\nand to the OC section (toggle advanced with F7). \n\nChange boot mode to UEFI instead of Legacy + UEFI if you are planning on booting\nfrom that.\n\nIOMMU (VT-d feature) is disabled on this board by default. Turn it on in the OC\nsection -> CPU features. This processor supports it.\n\nCaveat: This motherboard does *not* come with A LOT of USB ports, and I can only\nfind 1 host controller. This may be an annoyance if you want to pass an entire\nhost controller through to the guest VM in passthrough.\n\nWhen booting in UEFI mode its supposed to look at `$ESP/EFI` but some\nmanufacturers get it wrong apparently. When doing grub install we need to add\n`--removable`.\n\n```\ngrub-install --target=x86_64-efi --efi-directory=/boot --removable\n```\n\nMotherboard display stuff\n\nAdvanced -> Integrated Graphics Configuration\nInitiate Graphics Adapter -> Set to PEG (PCIe first)\nIGD multi monitor support -> Enable (to enable the i915 chip)\n\n\nSet gentoo-sources to use ~amd64 keyword then emerge to get (at the time of\nwriting) 4.17.6. This will load i915 automatically for the integrated GPU.\n\nIf you are on an older kernel version you need `i915.alpha_support=1` in your\nkernel boot parameters (edit grub.cfg).\n\nNVMe Disk\n---------\n\nBuild in the NVMe driver to the kernel (*not* as a module).\n\n```\nCONFIG_NVME_CORE=y\nCONFIG_BLK_DEV_NVME=y\n```\n\nMore disk\n---------\n\nEnable ZFS. Note that the wiki is slightly out of date \n\njust install zfs-kmod and zfs.\n\n\n```\necho \"=sys-fs/zfs-kmod-9999 **\" >> /etc/portage/package.accept_keywords/zfs-kmod\necho \"=sys-fs/zfs-9999 **\" >> /etc/portage/package.accept_keywords/zfs \n# when upgrading kernel\n# after eselect kernel set n\n# run make prepare in /usr/srx/linux\nenv EXTRA_ECONF='--enable-linux-builtin' \\\n    ebuild /usr/portage/sys-fs/zfs-kmod/zfs-kmod-9999.ebuild clean configure\n(cd /var/tmp/portage/sys-fs/zfs-kmod-9999/work/zfs-kmod-9999/ && ./copy-builtin /usr/src/linux)\n```\n\nThen enable ZFS kernel module `CONFIG_ZFS` and build.\n\nThen rebuild the nvidia driver just in case\n\n`emerge -a @module-rebuild`\n\nCPU Governor\n------------\n\nSet to `performance` and enable the intel pstate driver (default).\n\nSSH\n---\n\nEdit the SSHD config and remove `AcceptEnv`. I always SSH from MacOS machines\nand we do not want to be setting env like `LC_CTYPE=UTF-8` because glibc does not\nsupport that by default.\n\nChange authentication to publickey only, copy key over and restart sshd.\n\n```sh\nssh alex@trixie '>> .ssh/authorized_keys' < id_rsa.pub\n```\n\nCurrent monitor setup\n---------------------\n\n```\n                                +--------------+    +--------------+\n                                |  2560x1440   |    | 2560x1440    |\n                                |  MST on      |    | MST off      |\n                                |  DP1.2       |    |              |\n                                |              |    |              |\n                                +-----+--------+    +----+---------+\n                             mDP in|  |     |DP out      |  DP in\n                                   |  |     |            |\n                                   |  |     |            |\n                                   |  |     |            |\n+------------+DP out               |  |     +------------+\n|  Intel     +---------------------+  |\n|  Onboard   |                        |\n|            |                        |\n+------------+                        |\n                                      |\n+------------+        DP              |\n|            +------------------------+\n| GTX 1080   |\n|            |\n+------------+\n```\n\nIn make.conf when setting `VIDEO_CARDS` set `nvidia intel i965`\n\n\nPlan -\n\n  * When system boots it boots off the 1080 as the boot GPU\n  * Xorg starts on 1080 with i3 as the wm, puts workspace 2 on the second\n  monitor\n  * When we need to unbind, we kill X, start X on i915, workspace 2 moves over\n  * PCIe unbind, rebind into VM\n\n\nCreate an intel xorg config\n\nadded this to startx\n\n```\nif [ -f /tmp/vm.lock ]; then\n        serverargs=\"-config intel.xorg.conf\"\nfi\n```\n\nand intel.xorg.conf\n```\nSection \"Device\"\n        Identifier  \"intel\"\n        Driver      \"modesetting\"\n        BusID       \"PCI:0:2:0\"\nEndSection\n```\n\n# Controlling the displays\n\nInstall ddccontrol to use the DDC channels over DP\n\nthis DOES NOT WORK over nvidia GPUs (modern ones anyway) over DP (but it is\nknown to work over HDMI). \n\nHere's what you need to do: enable i2c support:\n\nhttps://wiki.gentoo.org/wiki/I2C (enable everything in this wiki)\n\nthen run\n\n```\nddccontrol -p -v\n```\n\nto probe\n\nthen for DP\n\n```\nddccontrol -r 0x60 -w 15 dev:/dev/i2c-3 #DP\nddccontrol -r 0x60 -w 16 dev:/dev/i2c-3 #mDP\n```\n\nsource: https://askubuntu.com/questions/860761/ubuntu-command-line-to-change-input-source-on-a-display-monitor\n","slug":"coffee-lake-build-gentoo","published":1,"updated":"2019-12-28T07:55:42.185Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9m00054ol3a9d6od81","content":"<p>CPU: Intel i7-8700k</p>\n<p>Cooler: Cryorig H5 Ultimate</p>\n<p>Mobo: MSI z370 A-pro</p>\n<p>RAM: GSkill RipJaws V 16gb @ 3000 MHz</p>\n<p>Disk: Samsung EVO 970 M.2 NVMe 250</p>\n<p>Case: NZXT H500</p>\n<p>GPU: Nvidia 1080 GTX (GALAX, OC SNPR dual fans, white)</p>\n<p>OS: Gentoo Linux</p>\n<h2 id=\"Cooler-installation\"><a href=\"#Cooler-installation\" class=\"headerlink\" title=\"Cooler installation\"></a>Cooler installation</h2><p>The H5 is tricky to install, preferably watch the youtube installation video\nbefore attempting. Thermal compound is provided, don’t get an extra tube unless\nyou need it.</p>\n<p>Monitor temps after you install it - mine idles at 22-30C, the room ambient is\n22-25C.</p>\n<h2 id=\"Motherboard-specific-stuff\"><a href=\"#Motherboard-specific-stuff\" class=\"headerlink\" title=\"Motherboard specific stuff\"></a>Motherboard specific stuff</h2><p>Installation: the NZXT case does not provide all 8 (?) mounting screws for the\nmobo, but that is OK. When I installed it I slightly bent a catch on the\nbackplate for the IO board, but no biggies.</p>\n<p>Save settings and boot is F10.</p>\n<p>RAM speed most likely will be detected wrong. It can be changed by going to BIOS\nand to the OC section (toggle advanced with F7). </p>\n<p>Change boot mode to UEFI instead of Legacy + UEFI if you are planning on booting\nfrom that.</p>\n<p>IOMMU (VT-d feature) is disabled on this board by default. Turn it on in the OC\nsection -&gt; CPU features. This processor supports it.</p>\n<p>Caveat: This motherboard does <em>not</em> come with A LOT of USB ports, and I can only\nfind 1 host controller. This may be an annoyance if you want to pass an entire\nhost controller through to the guest VM in passthrough.</p>\n<p>When booting in UEFI mode its supposed to look at <code>$ESP/EFI</code> but some\nmanufacturers get it wrong apparently. When doing grub install we need to add\n<code>--removable</code>.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grub-install --target=x86_64-efi --efi-directory=/boot --removable</span><br></pre></td></tr></table></figure>\n<p>Motherboard display stuff</p>\n<p>Advanced -&gt; Integrated Graphics Configuration\nInitiate Graphics Adapter -&gt; Set to PEG (PCIe first)\nIGD multi monitor support -&gt; Enable (to enable the i915 chip)</p>\n<p>Set gentoo-sources to use ~amd64 keyword then emerge to get (at the time of\nwriting) 4.17.6. This will load i915 automatically for the integrated GPU.</p>\n<p>If you are on an older kernel version you need <code>i915.alpha_support=1</code> in your\nkernel boot parameters (edit grub.cfg).</p>\n<h2 id=\"NVMe-Disk\"><a href=\"#NVMe-Disk\" class=\"headerlink\" title=\"NVMe Disk\"></a>NVMe Disk</h2><p>Build in the NVMe driver to the kernel (<em>not</em> as a module).</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CONFIG_NVME_CORE=y</span><br><span class=\"line\">CONFIG_BLK_DEV_NVME=y</span><br></pre></td></tr></table></figure>\n<h2 id=\"More-disk\"><a href=\"#More-disk\" class=\"headerlink\" title=\"More disk\"></a>More disk</h2><p>Enable ZFS. Note that the wiki is slightly out of date </p>\n<p>just install zfs-kmod and zfs.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;=sys-fs/zfs-kmod-9999 **&quot; &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod</span><br><span class=\"line\">echo &quot;=sys-fs/zfs-9999 **&quot; &gt;&gt; /etc/portage/package.accept_keywords/zfs </span><br><span class=\"line\"># when upgrading kernel</span><br><span class=\"line\"># after eselect kernel set n</span><br><span class=\"line\"># run make prepare in /usr/srx/linux</span><br><span class=\"line\">env EXTRA_ECONF=&apos;--enable-linux-builtin&apos; \\</span><br><span class=\"line\">    ebuild /usr/portage/sys-fs/zfs-kmod/zfs-kmod-9999.ebuild clean configure</span><br><span class=\"line\">(cd /var/tmp/portage/sys-fs/zfs-kmod-9999/work/zfs-kmod-9999/ &amp;&amp; ./copy-builtin /usr/src/linux)</span><br></pre></td></tr></table></figure>\n<p>Then enable ZFS kernel module <code>CONFIG_ZFS</code> and build.</p>\n<p>Then rebuild the nvidia driver just in case</p>\n<p><code>emerge -a @module-rebuild</code></p>\n<h2 id=\"CPU-Governor\"><a href=\"#CPU-Governor\" class=\"headerlink\" title=\"CPU Governor\"></a>CPU Governor</h2><p>Set to <code>performance</code> and enable the intel pstate driver (default).</p>\n<h2 id=\"SSH\"><a href=\"#SSH\" class=\"headerlink\" title=\"SSH\"></a>SSH</h2><p>Edit the SSHD config and remove <code>AcceptEnv</code>. I always SSH from MacOS machines\nand we do not want to be setting env like <code>LC_CTYPE=UTF-8</code> because glibc does not\nsupport that by default.</p>\n<p>Change authentication to publickey only, copy key over and restart sshd.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh alex@trixie <span class=\"string\">'&gt;&gt; .ssh/authorized_keys'</span> &lt; id_rsa.pub</span><br></pre></td></tr></table></figure>\n<h2 id=\"Current-monitor-setup\"><a href=\"#Current-monitor-setup\" class=\"headerlink\" title=\"Current monitor setup\"></a>Current monitor setup</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                                +--------------+    +--------------+</span><br><span class=\"line\">                                |  2560x1440   |    | 2560x1440    |</span><br><span class=\"line\">                                |  MST on      |    | MST off      |</span><br><span class=\"line\">                                |  DP1.2       |    |              |</span><br><span class=\"line\">                                |              |    |              |</span><br><span class=\"line\">                                +-----+--------+    +----+---------+</span><br><span class=\"line\">                             mDP in|  |     |DP out      |  DP in</span><br><span class=\"line\">                                   |  |     |            |</span><br><span class=\"line\">                                   |  |     |            |</span><br><span class=\"line\">                                   |  |     |            |</span><br><span class=\"line\">+------------+DP out               |  |     +------------+</span><br><span class=\"line\">|  Intel     +---------------------+  |</span><br><span class=\"line\">|  Onboard   |                        |</span><br><span class=\"line\">|            |                        |</span><br><span class=\"line\">+------------+                        |</span><br><span class=\"line\">                                      |</span><br><span class=\"line\">+------------+        DP              |</span><br><span class=\"line\">|            +------------------------+</span><br><span class=\"line\">| GTX 1080   |</span><br><span class=\"line\">|            |</span><br><span class=\"line\">+------------+</span><br></pre></td></tr></table></figure>\n<p>In make.conf when setting <code>VIDEO_CARDS</code> set <code>nvidia intel i965</code></p>\n<p>Plan -</p>\n<ul>\n<li>When system boots it boots off the 1080 as the boot GPU</li>\n<li>Xorg starts on 1080 with i3 as the wm, puts workspace 2 on the second\nmonitor</li>\n<li>When we need to unbind, we kill X, start X on i915, workspace 2 moves over</li>\n<li>PCIe unbind, rebind into VM</li>\n</ul>\n<p>Create an intel xorg config</p>\n<p>added this to startx</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if [ -f /tmp/vm.lock ]; then</span><br><span class=\"line\">        serverargs=&quot;-config intel.xorg.conf&quot;</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>\n<p>and intel.xorg.conf\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Section &quot;Device&quot;</span><br><span class=\"line\">        Identifier  &quot;intel&quot;</span><br><span class=\"line\">        Driver      &quot;modesetting&quot;</span><br><span class=\"line\">        BusID       &quot;PCI:0:2:0&quot;</span><br><span class=\"line\">EndSection</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"Controlling-the-displays\"><a href=\"#Controlling-the-displays\" class=\"headerlink\" title=\"Controlling the displays\"></a>Controlling the displays</h1><p>Install ddccontrol to use the DDC channels over DP</p>\n<p>this DOES NOT WORK over nvidia GPUs (modern ones anyway) over DP (but it is\nknown to work over HDMI). </p>\n<p>Here’s what you need to do: enable i2c support:</p>\n<p><a href=\"https://wiki.gentoo.org/wiki/I2C\" target=\"_blank\" rel=\"noopener\">https://wiki.gentoo.org/wiki/I2C</a> (enable everything in this wiki)</p>\n<p>then run</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ddccontrol -p -v</span><br></pre></td></tr></table></figure>\n<p>to probe</p>\n<p>then for DP</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ddccontrol -r 0x60 -w 15 dev:/dev/i2c-3 #DP</span><br><span class=\"line\">ddccontrol -r 0x60 -w 16 dev:/dev/i2c-3 #mDP</span><br></pre></td></tr></table></figure>\n<p>source: <a href=\"https://askubuntu.com/questions/860761/ubuntu-command-line-to-change-input-source-on-a-display-monitor\" target=\"_blank\" rel=\"noopener\">https://askubuntu.com/questions/860761/ubuntu-command-line-to-change-input-source-on-a-display-monitor</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>CPU: Intel i7-8700k</p>\n<p>Cooler: Cryorig H5 Ultimate</p>\n<p>Mobo: MSI z370 A-pro</p>\n<p>RAM: GSkill RipJaws V 16gb @ 3000 MHz</p>\n<p>Disk: Samsung EVO 970 M.2 NVMe 250</p>\n<p>Case: NZXT H500</p>\n<p>GPU: Nvidia 1080 GTX (GALAX, OC SNPR dual fans, white)</p>\n<p>OS: Gentoo Linux</p>\n<h2 id=\"Cooler-installation\"><a href=\"#Cooler-installation\" class=\"headerlink\" title=\"Cooler installation\"></a>Cooler installation</h2><p>The H5 is tricky to install, preferably watch the youtube installation video\nbefore attempting. Thermal compound is provided, don’t get an extra tube unless\nyou need it.</p>\n<p>Monitor temps after you install it - mine idles at 22-30C, the room ambient is\n22-25C.</p>\n<h2 id=\"Motherboard-specific-stuff\"><a href=\"#Motherboard-specific-stuff\" class=\"headerlink\" title=\"Motherboard specific stuff\"></a>Motherboard specific stuff</h2><p>Installation: the NZXT case does not provide all 8 (?) mounting screws for the\nmobo, but that is OK. When I installed it I slightly bent a catch on the\nbackplate for the IO board, but no biggies.</p>\n<p>Save settings and boot is F10.</p>\n<p>RAM speed most likely will be detected wrong. It can be changed by going to BIOS\nand to the OC section (toggle advanced with F7). </p>\n<p>Change boot mode to UEFI instead of Legacy + UEFI if you are planning on booting\nfrom that.</p>\n<p>IOMMU (VT-d feature) is disabled on this board by default. Turn it on in the OC\nsection -&gt; CPU features. This processor supports it.</p>\n<p>Caveat: This motherboard does <em>not</em> come with A LOT of USB ports, and I can only\nfind 1 host controller. This may be an annoyance if you want to pass an entire\nhost controller through to the guest VM in passthrough.</p>\n<p>When booting in UEFI mode its supposed to look at <code>$ESP/EFI</code> but some\nmanufacturers get it wrong apparently. When doing grub install we need to add\n<code>--removable</code>.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grub-install --target=x86_64-efi --efi-directory=/boot --removable</span><br></pre></td></tr></table></figure>\n<p>Motherboard display stuff</p>\n<p>Advanced -&gt; Integrated Graphics Configuration\nInitiate Graphics Adapter -&gt; Set to PEG (PCIe first)\nIGD multi monitor support -&gt; Enable (to enable the i915 chip)</p>\n<p>Set gentoo-sources to use ~amd64 keyword then emerge to get (at the time of\nwriting) 4.17.6. This will load i915 automatically for the integrated GPU.</p>\n<p>If you are on an older kernel version you need <code>i915.alpha_support=1</code> in your\nkernel boot parameters (edit grub.cfg).</p>\n<h2 id=\"NVMe-Disk\"><a href=\"#NVMe-Disk\" class=\"headerlink\" title=\"NVMe Disk\"></a>NVMe Disk</h2><p>Build in the NVMe driver to the kernel (<em>not</em> as a module).</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CONFIG_NVME_CORE=y</span><br><span class=\"line\">CONFIG_BLK_DEV_NVME=y</span><br></pre></td></tr></table></figure>\n<h2 id=\"More-disk\"><a href=\"#More-disk\" class=\"headerlink\" title=\"More disk\"></a>More disk</h2><p>Enable ZFS. Note that the wiki is slightly out of date </p>\n<p>just install zfs-kmod and zfs.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;=sys-fs/zfs-kmod-9999 **&quot; &gt;&gt; /etc/portage/package.accept_keywords/zfs-kmod</span><br><span class=\"line\">echo &quot;=sys-fs/zfs-9999 **&quot; &gt;&gt; /etc/portage/package.accept_keywords/zfs </span><br><span class=\"line\"># when upgrading kernel</span><br><span class=\"line\"># after eselect kernel set n</span><br><span class=\"line\"># run make prepare in /usr/srx/linux</span><br><span class=\"line\">env EXTRA_ECONF=&apos;--enable-linux-builtin&apos; \\</span><br><span class=\"line\">    ebuild /usr/portage/sys-fs/zfs-kmod/zfs-kmod-9999.ebuild clean configure</span><br><span class=\"line\">(cd /var/tmp/portage/sys-fs/zfs-kmod-9999/work/zfs-kmod-9999/ &amp;&amp; ./copy-builtin /usr/src/linux)</span><br></pre></td></tr></table></figure>\n<p>Then enable ZFS kernel module <code>CONFIG_ZFS</code> and build.</p>\n<p>Then rebuild the nvidia driver just in case</p>\n<p><code>emerge -a @module-rebuild</code></p>\n<h2 id=\"CPU-Governor\"><a href=\"#CPU-Governor\" class=\"headerlink\" title=\"CPU Governor\"></a>CPU Governor</h2><p>Set to <code>performance</code> and enable the intel pstate driver (default).</p>\n<h2 id=\"SSH\"><a href=\"#SSH\" class=\"headerlink\" title=\"SSH\"></a>SSH</h2><p>Edit the SSHD config and remove <code>AcceptEnv</code>. I always SSH from MacOS machines\nand we do not want to be setting env like <code>LC_CTYPE=UTF-8</code> because glibc does not\nsupport that by default.</p>\n<p>Change authentication to publickey only, copy key over and restart sshd.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh alex@trixie <span class=\"string\">'&gt;&gt; .ssh/authorized_keys'</span> &lt; id_rsa.pub</span><br></pre></td></tr></table></figure>\n<h2 id=\"Current-monitor-setup\"><a href=\"#Current-monitor-setup\" class=\"headerlink\" title=\"Current monitor setup\"></a>Current monitor setup</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">                                +--------------+    +--------------+</span><br><span class=\"line\">                                |  2560x1440   |    | 2560x1440    |</span><br><span class=\"line\">                                |  MST on      |    | MST off      |</span><br><span class=\"line\">                                |  DP1.2       |    |              |</span><br><span class=\"line\">                                |              |    |              |</span><br><span class=\"line\">                                +-----+--------+    +----+---------+</span><br><span class=\"line\">                             mDP in|  |     |DP out      |  DP in</span><br><span class=\"line\">                                   |  |     |            |</span><br><span class=\"line\">                                   |  |     |            |</span><br><span class=\"line\">                                   |  |     |            |</span><br><span class=\"line\">+------------+DP out               |  |     +------------+</span><br><span class=\"line\">|  Intel     +---------------------+  |</span><br><span class=\"line\">|  Onboard   |                        |</span><br><span class=\"line\">|            |                        |</span><br><span class=\"line\">+------------+                        |</span><br><span class=\"line\">                                      |</span><br><span class=\"line\">+------------+        DP              |</span><br><span class=\"line\">|            +------------------------+</span><br><span class=\"line\">| GTX 1080   |</span><br><span class=\"line\">|            |</span><br><span class=\"line\">+------------+</span><br></pre></td></tr></table></figure>\n<p>In make.conf when setting <code>VIDEO_CARDS</code> set <code>nvidia intel i965</code></p>\n<p>Plan -</p>\n<ul>\n<li>When system boots it boots off the 1080 as the boot GPU</li>\n<li>Xorg starts on 1080 with i3 as the wm, puts workspace 2 on the second\nmonitor</li>\n<li>When we need to unbind, we kill X, start X on i915, workspace 2 moves over</li>\n<li>PCIe unbind, rebind into VM</li>\n</ul>\n<p>Create an intel xorg config</p>\n<p>added this to startx</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if [ -f /tmp/vm.lock ]; then</span><br><span class=\"line\">        serverargs=&quot;-config intel.xorg.conf&quot;</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>\n<p>and intel.xorg.conf\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Section &quot;Device&quot;</span><br><span class=\"line\">        Identifier  &quot;intel&quot;</span><br><span class=\"line\">        Driver      &quot;modesetting&quot;</span><br><span class=\"line\">        BusID       &quot;PCI:0:2:0&quot;</span><br><span class=\"line\">EndSection</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"Controlling-the-displays\"><a href=\"#Controlling-the-displays\" class=\"headerlink\" title=\"Controlling the displays\"></a>Controlling the displays</h1><p>Install ddccontrol to use the DDC channels over DP</p>\n<p>this DOES NOT WORK over nvidia GPUs (modern ones anyway) over DP (but it is\nknown to work over HDMI). </p>\n<p>Here’s what you need to do: enable i2c support:</p>\n<p><a href=\"https://wiki.gentoo.org/wiki/I2C\" target=\"_blank\" rel=\"noopener\">https://wiki.gentoo.org/wiki/I2C</a> (enable everything in this wiki)</p>\n<p>then run</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ddccontrol -p -v</span><br></pre></td></tr></table></figure>\n<p>to probe</p>\n<p>then for DP</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ddccontrol -r 0x60 -w 15 dev:/dev/i2c-3 #DP</span><br><span class=\"line\">ddccontrol -r 0x60 -w 16 dev:/dev/i2c-3 #mDP</span><br></pre></td></tr></table></figure>\n<p>source: <a href=\"https://askubuntu.com/questions/860761/ubuntu-command-line-to-change-input-source-on-a-display-monitor\" target=\"_blank\" rel=\"noopener\">https://askubuntu.com/questions/860761/ubuntu-command-line-to-change-input-source-on-a-display-monitor</a></p>\n"},{"title":"Notes on flashing the ESP8266 wifi module (ESP-01S)","date":"2017-07-03T22:10:36.000Z","_content":"\nWriting this down for future reference. I used a Sparkfun FTDI breakout board\nwith selectable voltage level set to 3.3v. Pinout\n\n```\nTXD <-> TX (I suspect wrong labelling)\nRXD <-> RX\nVCC <-> 3v3\nGND <-> GND\n        IO0 pulled low\n        IO2 pulled high\n```\n\nKeep the reset pin connected to a wire for easy resetting. \n\nInstall `esptool.py` via `pip install esptool` and then when the ESP8266 is set\nto flash mode (IO0 low IO2 high) we can then try to connect at 115200 baud.\n\n```\nesptool.py --port /dev/tty.usbmodem1421 --baud 115200 read_mac\n```\n\nI flashed v2.1.0 of the NON OS SDK which can be obtained\n[here](https://github.com/espressif/ESP8266_NONOS_SDK/releases). \n\nFlash details\n\n```\nboot_v1.7.bin @ 0x0\nat\\512+512\\user1.1024.new.2.bin @ 0x01\nesp_init_data_default.bin 0xfc000\nblank.bin @ 0xfe000 0x7e000 0xfb000 0xfb000\n```\n\nSPI crystal frequency of 26MHz, speed 40MHz, 8Mbit flash size, QIO flash.\n\nThe firmware sets default baudrate to `1152000`. This was confusing for me because I'm\nused to working with serial devices and I just assumed it was `115200` (a more\nstandard baudrate). Use a serial monitor that can connect on that baudrate and\nthen change the default by typing\n\n```\nAT #for testing\nAT+GMR #for testing\nAT+UART_DEF=9600,8,1,0,0\n```\n\nNow you can use minicom again but you have to remember to press ctrl M ctrl J to\nsend CRLF like so\n\n```\nAT^M^J\n```\n\n\n","source":"_posts/notes-on-flashing-the-esp8266-esp-01s.md","raw":"---\ntitle: Notes on flashing the ESP8266 wifi module (ESP-01S)\ndate: 2017-07-04 06:10:36\ntags: esp8266\n---\n\nWriting this down for future reference. I used a Sparkfun FTDI breakout board\nwith selectable voltage level set to 3.3v. Pinout\n\n```\nTXD <-> TX (I suspect wrong labelling)\nRXD <-> RX\nVCC <-> 3v3\nGND <-> GND\n        IO0 pulled low\n        IO2 pulled high\n```\n\nKeep the reset pin connected to a wire for easy resetting. \n\nInstall `esptool.py` via `pip install esptool` and then when the ESP8266 is set\nto flash mode (IO0 low IO2 high) we can then try to connect at 115200 baud.\n\n```\nesptool.py --port /dev/tty.usbmodem1421 --baud 115200 read_mac\n```\n\nI flashed v2.1.0 of the NON OS SDK which can be obtained\n[here](https://github.com/espressif/ESP8266_NONOS_SDK/releases). \n\nFlash details\n\n```\nboot_v1.7.bin @ 0x0\nat\\512+512\\user1.1024.new.2.bin @ 0x01\nesp_init_data_default.bin 0xfc000\nblank.bin @ 0xfe000 0x7e000 0xfb000 0xfb000\n```\n\nSPI crystal frequency of 26MHz, speed 40MHz, 8Mbit flash size, QIO flash.\n\nThe firmware sets default baudrate to `1152000`. This was confusing for me because I'm\nused to working with serial devices and I just assumed it was `115200` (a more\nstandard baudrate). Use a serial monitor that can connect on that baudrate and\nthen change the default by typing\n\n```\nAT #for testing\nAT+GMR #for testing\nAT+UART_DEF=9600,8,1,0,0\n```\n\nNow you can use minicom again but you have to remember to press ctrl M ctrl J to\nsend CRLF like so\n\n```\nAT^M^J\n```\n\n\n","slug":"notes-on-flashing-the-esp8266-esp-01s","published":1,"updated":"2019-12-28T07:55:42.186Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9n00084ol38lfkb5dg","content":"<p>Writing this down for future reference. I used a Sparkfun FTDI breakout board\nwith selectable voltage level set to 3.3v. Pinout</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TXD &lt;-&gt; TX (I suspect wrong labelling)</span><br><span class=\"line\">RXD &lt;-&gt; RX</span><br><span class=\"line\">VCC &lt;-&gt; 3v3</span><br><span class=\"line\">GND &lt;-&gt; GND</span><br><span class=\"line\">        IO0 pulled low</span><br><span class=\"line\">        IO2 pulled high</span><br></pre></td></tr></table></figure>\n<p>Keep the reset pin connected to a wire for easy resetting. </p>\n<p>Install <code>esptool.py</code> via <code>pip install esptool</code> and then when the ESP8266 is set\nto flash mode (IO0 low IO2 high) we can then try to connect at 115200 baud.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">esptool.py --port /dev/tty.usbmodem1421 --baud 115200 read_mac</span><br></pre></td></tr></table></figure>\n<p>I flashed v2.1.0 of the NON OS SDK which can be obtained\n<a href=\"https://github.com/espressif/ESP8266_NONOS_SDK/releases\" target=\"_blank\" rel=\"noopener\">here</a>. </p>\n<p>Flash details</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_v1.7.bin @ 0x0</span><br><span class=\"line\">at\\512+512\\user1.1024.new.2.bin @ 0x01</span><br><span class=\"line\">esp_init_data_default.bin 0xfc000</span><br><span class=\"line\">blank.bin @ 0xfe000 0x7e000 0xfb000 0xfb000</span><br></pre></td></tr></table></figure>\n<p>SPI crystal frequency of 26MHz, speed 40MHz, 8Mbit flash size, QIO flash.</p>\n<p>The firmware sets default baudrate to <code>1152000</code>. This was confusing for me because I’m\nused to working with serial devices and I just assumed it was <code>115200</code> (a more\nstandard baudrate). Use a serial monitor that can connect on that baudrate and\nthen change the default by typing</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AT #for testing</span><br><span class=\"line\">AT+GMR #for testing</span><br><span class=\"line\">AT+UART_DEF=9600,8,1,0,0</span><br></pre></td></tr></table></figure>\n<p>Now you can use minicom again but you have to remember to press ctrl M ctrl J to\nsend CRLF like so</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AT^M^J</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<p>Writing this down for future reference. I used a Sparkfun FTDI breakout board\nwith selectable voltage level set to 3.3v. Pinout</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TXD &lt;-&gt; TX (I suspect wrong labelling)</span><br><span class=\"line\">RXD &lt;-&gt; RX</span><br><span class=\"line\">VCC &lt;-&gt; 3v3</span><br><span class=\"line\">GND &lt;-&gt; GND</span><br><span class=\"line\">        IO0 pulled low</span><br><span class=\"line\">        IO2 pulled high</span><br></pre></td></tr></table></figure>\n<p>Keep the reset pin connected to a wire for easy resetting. </p>\n<p>Install <code>esptool.py</code> via <code>pip install esptool</code> and then when the ESP8266 is set\nto flash mode (IO0 low IO2 high) we can then try to connect at 115200 baud.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">esptool.py --port /dev/tty.usbmodem1421 --baud 115200 read_mac</span><br></pre></td></tr></table></figure>\n<p>I flashed v2.1.0 of the NON OS SDK which can be obtained\n<a href=\"https://github.com/espressif/ESP8266_NONOS_SDK/releases\" target=\"_blank\" rel=\"noopener\">here</a>. </p>\n<p>Flash details</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">boot_v1.7.bin @ 0x0</span><br><span class=\"line\">at\\512+512\\user1.1024.new.2.bin @ 0x01</span><br><span class=\"line\">esp_init_data_default.bin 0xfc000</span><br><span class=\"line\">blank.bin @ 0xfe000 0x7e000 0xfb000 0xfb000</span><br></pre></td></tr></table></figure>\n<p>SPI crystal frequency of 26MHz, speed 40MHz, 8Mbit flash size, QIO flash.</p>\n<p>The firmware sets default baudrate to <code>1152000</code>. This was confusing for me because I’m\nused to working with serial devices and I just assumed it was <code>115200</code> (a more\nstandard baudrate). Use a serial monitor that can connect on that baudrate and\nthen change the default by typing</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AT #for testing</span><br><span class=\"line\">AT+GMR #for testing</span><br><span class=\"line\">AT+UART_DEF=9600,8,1,0,0</span><br></pre></td></tr></table></figure>\n<p>Now you can use minicom again but you have to remember to press ctrl M ctrl J to\nsend CRLF like so</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AT^M^J</span><br></pre></td></tr></table></figure>\n"},{"title":"Automatically turning on a lamp when in a video meeting","date":"2020-07-31T06:15:04.000Z","_content":"\nI've been working from home for a long time now (ever since COVID-19) and one of\nthe complaints I've had is that I sit facing away from a window (monitors and\nwebcam facing the window). This means my colleagues get a really dark view of my\nface after auto brightness accounts for the window or my ceiling lights.\n\nTo fix this, I bought a cheap IKEA TERTIAL lamp[0] which retails for 20 bucks,\nand aimed it at the wall in front of me to diffuse the light. I used a spare\nPhillips Hue bulb that I had lying around giving me easy controls from Apple\nHome.\n\n![bulb](https://i.imgur.com/3ka27KB.jpg)\n\nThat's still too many actions for my liking because I'd have to open up\ncontrol center, go to Home, and turn on the light. Not to mention doing the same\nthing one my meeting is over.\n\nIt's pretty straightforward to automate this, we need to\n\n* detect if the webcam is enabled\n* (in my case) setup a proxy over another computer to avoid storing creds on my\n  corp laptop\n* control the light over the Hue bridge using its API\n\nDetecting if the webcam is enabled is surprisingly easy. All the links on Google\npoint to checking for processing using `AppleCamera` or `VDC` but I don't think\nthat works anymore (at least, it does not work for me on Catalina). Instead,\nwe'll use the `Console.app` program or the command line equivalent `log` that\ncomes built-in to MacOS.\n\nDetecting webcam use\n--------------------\n\n```sh\nsudo log show --predicate 'subsystem == \"com.apple.VDCAssistant\" && \\\n    eventMessage CONTAINS[c] \"kCameraStream\"' --last 1m --no-debug --no-pager \\\n    --style compact | tail -n +2)\n\n#or\nlog stream ... # streaming is better to generate events\n```\n\nwhich tells us if events like `kCameraStreamStart` and `kCameraStreamStop`\noccur, which seems to occur each time the camera starts and stops. Note that\nthis command does not seem to work as a normal, unpriviledged user and instead,\nroot access. There's probably a way to work around this, but this is a hack\n*cough* short term solution *cough*.\n\nControlling lights over the Hue bridge with it's API is relatively\nstraightforward, we just need to get a token from the hue developer portal. Once\nyou have the token you can then control the light with a simple `PUT` query like\nso:\n\n```sh\n#!/bin/zsh\n\n# This script runs on the middleman host\n\nTOKEN=your_token_here\nBULB_ID=7\n\nread M\nif [ \"$M\" = \"bulb:on\" ]; then\n  curl -X PUT -H \"Content-Type: application/json\" -d '{\"on\": true}' \\\n    http://${HUE_HUB_IP}/api/${TOKEN}/lights/${BULB_ID}/state\nelif [ \"$M\" = \"bulb:off\" ]; then\n  curl -X PUT -H \"Content-Type: application/json\" -d '{\"on\": false}' \\\n    http://${HUE_HUB_IP}/api/${TOKEN}/lights/${BULB_ID}/state\nfi\necho\n```\n\nI have made the script read for events like `bulb:on` from stdin that'll be then\nused to toggle the state.\n\nProxying the command\n--------------------\n\nI keep this running on a personal computer in my household and expose it over a\nTCP port with socat. It's kept daemonized with start-stop-daemon and OpenRC.\n\n```sh\n#!/sbin/openrc-run\n\ndepend() {\n        need net\n}\n\nstart() {\n        ebegin \"Starting bulb control\"\n        start-stop-daemon -S -m -p ${MEET_PIDFILE} -u alex --quiet --background \\\n          socat -- -u tcp-l:6338,reuseaddr,fork system:/home/alex/.homebridge/meet.sh\n        eend $?\n}\n\nstop() {\n        ebegin \"Stopping bulb control\"\n        kill -- -`cat ${MEET_PIDFILE}`\n\n        rm ${MEET_PIDFILE}\n        eend $?\n}\n```\n\nEach time there's anything sent to tcp:6338 it runs the script which then\ncontrols the bulb. With this, all the corp laptop sees is a string sent to a\nlocal computer using netcat.\n\nTying it all together\n---------------------\n\n(this section is slightly updated, to remove the use of cron)\n\n~~The script to detect the webcam state is put in the root users crontab on the\nlaptop. It then sends the appropriate string to the proxy script to toggle the\nphysical state of the bulb.~~\n\nThe script to detect the status of the webcam uses `log stream` instead of `log\nshow`, which eliminates the need for a minutely cron. 60 seconds without a lamp\nis still quite a noticeable delay in a meeting. Using the stream, it's put in a\nscript as so\n\n```sh\n#!/bin/bash\n\nwhile read S; do\n        if echo \"$S\" | grep -q \"kCameraStreamStop\"; then\n                echo \"bulb:off\" | nc trixie.local 6338\n        elif echo \"$S\" | grep -q \"kCameraStreamStart\"; then\n                echo \"bulb:on\" | nc trixie.local 6338\n        fi\ndone < <(log stream --predicate 'subsystem == \"com.apple.VDCAssistant\" && \\\n         eventMessage CONTAINS[c] \"kCameraStream\"' --no-debug --style compact)\n```\n\nand launched using `launchd`.  The launch daemon is dumped into\n`/Library/LaunchDaemons/` as `com.alex.bulb`.\n\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n        <dict>\n                <key>Label</key>\n                <string>com.alex.bulb</string>\n                <key>Program</key>\n                <string>/path/to/script.sh</string>\n                <key>RunAtLoad</key>\n                <true/>\n        </dict>\n</plist>\n```\n\nIt can then be launched with `launchctl load com.alex.bulb` and `launchctl start\n...`.\n\nThe user experience is pretty good, I hop on a call with Google\nMeet, which enables the camera, which triggers the lamp, and which automatically\nturns it off after I'm done.\n\n\n\nRef\n---\n[0] https://www.ikea.com/sg/en/p/tertial-work-lamp-dark-grey-50355395/\n\n[1] https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/ScheduledJobs.html#//apple_ref/doc/uid/10000172i-CH1-SW3\n","source":"_posts/lamp-control-based-on-video-conferencing.md","raw":"---\ntitle: Automatically turning on a lamp when in a video meeting\ndate: 2020-07-31 14:15:04\ntags:\n  - automation\n  - macos\n---\n\nI've been working from home for a long time now (ever since COVID-19) and one of\nthe complaints I've had is that I sit facing away from a window (monitors and\nwebcam facing the window). This means my colleagues get a really dark view of my\nface after auto brightness accounts for the window or my ceiling lights.\n\nTo fix this, I bought a cheap IKEA TERTIAL lamp[0] which retails for 20 bucks,\nand aimed it at the wall in front of me to diffuse the light. I used a spare\nPhillips Hue bulb that I had lying around giving me easy controls from Apple\nHome.\n\n![bulb](https://i.imgur.com/3ka27KB.jpg)\n\nThat's still too many actions for my liking because I'd have to open up\ncontrol center, go to Home, and turn on the light. Not to mention doing the same\nthing one my meeting is over.\n\nIt's pretty straightforward to automate this, we need to\n\n* detect if the webcam is enabled\n* (in my case) setup a proxy over another computer to avoid storing creds on my\n  corp laptop\n* control the light over the Hue bridge using its API\n\nDetecting if the webcam is enabled is surprisingly easy. All the links on Google\npoint to checking for processing using `AppleCamera` or `VDC` but I don't think\nthat works anymore (at least, it does not work for me on Catalina). Instead,\nwe'll use the `Console.app` program or the command line equivalent `log` that\ncomes built-in to MacOS.\n\nDetecting webcam use\n--------------------\n\n```sh\nsudo log show --predicate 'subsystem == \"com.apple.VDCAssistant\" && \\\n    eventMessage CONTAINS[c] \"kCameraStream\"' --last 1m --no-debug --no-pager \\\n    --style compact | tail -n +2)\n\n#or\nlog stream ... # streaming is better to generate events\n```\n\nwhich tells us if events like `kCameraStreamStart` and `kCameraStreamStop`\noccur, which seems to occur each time the camera starts and stops. Note that\nthis command does not seem to work as a normal, unpriviledged user and instead,\nroot access. There's probably a way to work around this, but this is a hack\n*cough* short term solution *cough*.\n\nControlling lights over the Hue bridge with it's API is relatively\nstraightforward, we just need to get a token from the hue developer portal. Once\nyou have the token you can then control the light with a simple `PUT` query like\nso:\n\n```sh\n#!/bin/zsh\n\n# This script runs on the middleman host\n\nTOKEN=your_token_here\nBULB_ID=7\n\nread M\nif [ \"$M\" = \"bulb:on\" ]; then\n  curl -X PUT -H \"Content-Type: application/json\" -d '{\"on\": true}' \\\n    http://${HUE_HUB_IP}/api/${TOKEN}/lights/${BULB_ID}/state\nelif [ \"$M\" = \"bulb:off\" ]; then\n  curl -X PUT -H \"Content-Type: application/json\" -d '{\"on\": false}' \\\n    http://${HUE_HUB_IP}/api/${TOKEN}/lights/${BULB_ID}/state\nfi\necho\n```\n\nI have made the script read for events like `bulb:on` from stdin that'll be then\nused to toggle the state.\n\nProxying the command\n--------------------\n\nI keep this running on a personal computer in my household and expose it over a\nTCP port with socat. It's kept daemonized with start-stop-daemon and OpenRC.\n\n```sh\n#!/sbin/openrc-run\n\ndepend() {\n        need net\n}\n\nstart() {\n        ebegin \"Starting bulb control\"\n        start-stop-daemon -S -m -p ${MEET_PIDFILE} -u alex --quiet --background \\\n          socat -- -u tcp-l:6338,reuseaddr,fork system:/home/alex/.homebridge/meet.sh\n        eend $?\n}\n\nstop() {\n        ebegin \"Stopping bulb control\"\n        kill -- -`cat ${MEET_PIDFILE}`\n\n        rm ${MEET_PIDFILE}\n        eend $?\n}\n```\n\nEach time there's anything sent to tcp:6338 it runs the script which then\ncontrols the bulb. With this, all the corp laptop sees is a string sent to a\nlocal computer using netcat.\n\nTying it all together\n---------------------\n\n(this section is slightly updated, to remove the use of cron)\n\n~~The script to detect the webcam state is put in the root users crontab on the\nlaptop. It then sends the appropriate string to the proxy script to toggle the\nphysical state of the bulb.~~\n\nThe script to detect the status of the webcam uses `log stream` instead of `log\nshow`, which eliminates the need for a minutely cron. 60 seconds without a lamp\nis still quite a noticeable delay in a meeting. Using the stream, it's put in a\nscript as so\n\n```sh\n#!/bin/bash\n\nwhile read S; do\n        if echo \"$S\" | grep -q \"kCameraStreamStop\"; then\n                echo \"bulb:off\" | nc trixie.local 6338\n        elif echo \"$S\" | grep -q \"kCameraStreamStart\"; then\n                echo \"bulb:on\" | nc trixie.local 6338\n        fi\ndone < <(log stream --predicate 'subsystem == \"com.apple.VDCAssistant\" && \\\n         eventMessage CONTAINS[c] \"kCameraStream\"' --no-debug --style compact)\n```\n\nand launched using `launchd`.  The launch daemon is dumped into\n`/Library/LaunchDaemons/` as `com.alex.bulb`.\n\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n        <dict>\n                <key>Label</key>\n                <string>com.alex.bulb</string>\n                <key>Program</key>\n                <string>/path/to/script.sh</string>\n                <key>RunAtLoad</key>\n                <true/>\n        </dict>\n</plist>\n```\n\nIt can then be launched with `launchctl load com.alex.bulb` and `launchctl start\n...`.\n\nThe user experience is pretty good, I hop on a call with Google\nMeet, which enables the camera, which triggers the lamp, and which automatically\nturns it off after I'm done.\n\n\n\nRef\n---\n[0] https://www.ikea.com/sg/en/p/tertial-work-lamp-dark-grey-50355395/\n\n[1] https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/ScheduledJobs.html#//apple_ref/doc/uid/10000172i-CH1-SW3\n","slug":"lamp-control-based-on-video-conferencing","published":1,"updated":"2020-07-31T12:14:35.011Z","_id":"ckd9v0x9o00094ol3rjz9gwcr","comments":1,"layout":"post","photos":[],"link":"","content":"<p>I’ve been working from home for a long time now (ever since COVID-19) and one of\nthe complaints I’ve had is that I sit facing away from a window (monitors and\nwebcam facing the window). This means my colleagues get a really dark view of my\nface after auto brightness accounts for the window or my ceiling lights.</p>\n<p>To fix this, I bought a cheap IKEA TERTIAL lamp[0] which retails for 20 bucks,\nand aimed it at the wall in front of me to diffuse the light. I used a spare\nPhillips Hue bulb that I had lying around giving me easy controls from Apple\nHome.</p>\n<p><img src=\"https://i.imgur.com/3ka27KB.jpg\" alt=\"bulb\"></p>\n<p>That’s still too many actions for my liking because I’d have to open up\ncontrol center, go to Home, and turn on the light. Not to mention doing the same\nthing one my meeting is over.</p>\n<p>It’s pretty straightforward to automate this, we need to</p>\n<ul>\n<li>detect if the webcam is enabled</li>\n<li>(in my case) setup a proxy over another computer to avoid storing creds on my\ncorp laptop</li>\n<li>control the light over the Hue bridge using its API</li>\n</ul>\n<p>Detecting if the webcam is enabled is surprisingly easy. All the links on Google\npoint to checking for processing using <code>AppleCamera</code> or <code>VDC</code> but I don’t think\nthat works anymore (at least, it does not work for me on Catalina). Instead,\nwe’ll use the <code>Console.app</code> program or the command line equivalent <code>log</code> that\ncomes built-in to MacOS.</p>\n<h2 id=\"Detecting-webcam-use\"><a href=\"#Detecting-webcam-use\" class=\"headerlink\" title=\"Detecting webcam use\"></a>Detecting webcam use</h2><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">log</span> show --predicate <span class=\"string\">'subsystem == \"com.apple.VDCAssistant\" &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">    eventMessage CONTAINS[c] \"kCameraStream\"'</span> --last 1m --no-debug --no-pager \\</span><br><span class=\"line\">    --style compact | tail -n +2)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#or</span></span><br><span class=\"line\"><span class=\"built_in\">log</span> stream ... <span class=\"comment\"># streaming is better to generate events</span></span><br></pre></td></tr></table></figure>\n<p>which tells us if events like <code>kCameraStreamStart</code> and <code>kCameraStreamStop</code>\noccur, which seems to occur each time the camera starts and stops. Note that\nthis command does not seem to work as a normal, unpriviledged user and instead,\nroot access. There’s probably a way to work around this, but this is a hack\n<em>cough</em> short term solution <em>cough</em>.</p>\n<p>Controlling lights over the Hue bridge with it’s API is relatively\nstraightforward, we just need to get a token from the hue developer portal. Once\nyou have the token you can then control the light with a simple <code>PUT</code> query like\nso:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/zsh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script runs on the middleman host</span></span><br><span class=\"line\"></span><br><span class=\"line\">TOKEN=your_token_here</span><br><span class=\"line\">BULB_ID=7</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">read</span> M</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$M</span>\"</span> = <span class=\"string\">\"bulb:on\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  curl -X PUT -H <span class=\"string\">\"Content-Type: application/json\"</span> -d <span class=\"string\">'&#123;\"on\": true&#125;'</span> \\</span><br><span class=\"line\">    http://<span class=\"variable\">$&#123;HUE_HUB_IP&#125;</span>/api/<span class=\"variable\">$&#123;TOKEN&#125;</span>/lights/<span class=\"variable\">$&#123;BULB_ID&#125;</span>/state</span><br><span class=\"line\"><span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$M</span>\"</span> = <span class=\"string\">\"bulb:off\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  curl -X PUT -H <span class=\"string\">\"Content-Type: application/json\"</span> -d <span class=\"string\">'&#123;\"on\": false&#125;'</span> \\</span><br><span class=\"line\">    http://<span class=\"variable\">$&#123;HUE_HUB_IP&#125;</span>/api/<span class=\"variable\">$&#123;TOKEN&#125;</span>/lights/<span class=\"variable\">$&#123;BULB_ID&#125;</span>/state</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br></pre></td></tr></table></figure>\n<p>I have made the script read for events like <code>bulb:on</code> from stdin that’ll be then\nused to toggle the state.</p>\n<h2 id=\"Proxying-the-command\"><a href=\"#Proxying-the-command\" class=\"headerlink\" title=\"Proxying the command\"></a>Proxying the command</h2><p>I keep this running on a personal computer in my household and expose it over a\nTCP port with socat. It’s kept daemonized with start-stop-daemon and OpenRC.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/sbin/openrc-run</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">depend</span></span>() &#123;</span><br><span class=\"line\">        need net</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">start</span></span>() &#123;</span><br><span class=\"line\">        ebegin <span class=\"string\">\"Starting bulb control\"</span></span><br><span class=\"line\">        start-stop-daemon -S -m -p <span class=\"variable\">$&#123;MEET_PIDFILE&#125;</span> -u alex --quiet --background \\</span><br><span class=\"line\">          socat -- -u tcp<span class=\"_\">-l</span>:6338,reuseaddr,fork system:/home/alex/.homebridge/meet.sh</span><br><span class=\"line\">        eend $?</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">stop</span></span>() &#123;</span><br><span class=\"line\">        ebegin <span class=\"string\">\"Stopping bulb control\"</span></span><br><span class=\"line\">        <span class=\"built_in\">kill</span> -- -`cat <span class=\"variable\">$&#123;MEET_PIDFILE&#125;</span>`</span><br><span class=\"line\"></span><br><span class=\"line\">        rm <span class=\"variable\">$&#123;MEET_PIDFILE&#125;</span></span><br><span class=\"line\">        eend $?</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Each time there’s anything sent to tcp:6338 it runs the script which then\ncontrols the bulb. With this, all the corp laptop sees is a string sent to a\nlocal computer using netcat.</p>\n<h2 id=\"Tying-it-all-together\"><a href=\"#Tying-it-all-together\" class=\"headerlink\" title=\"Tying it all together\"></a>Tying it all together</h2><p>(this section is slightly updated, to remove the use of cron)</p>\n<p><del>The script to detect the webcam state is put in the root users crontab on the\nlaptop. It then sends the appropriate string to the proxy script to toggle the\nphysical state of the bulb.</del></p>\n<p>The script to detect the status of the webcam uses <code>log stream</code> instead of <code>log\nshow</code>, which eliminates the need for a minutely cron. 60 seconds without a lamp\nis still quite a noticeable delay in a meeting. Using the stream, it’s put in a\nscript as so</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"built_in\">read</span> S; <span class=\"keyword\">do</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$S</span>\"</span> | grep -q <span class=\"string\">\"kCameraStreamStop\"</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">\"bulb:off\"</span> | nc trixie.local 6338</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$S</span>\"</span> | grep -q <span class=\"string\">\"kCameraStreamStart\"</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">\"bulb:on\"</span> | nc trixie.local 6338</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span> &lt; &lt;(<span class=\"built_in\">log</span> stream --predicate <span class=\"string\">'subsystem == \"com.apple.VDCAssistant\" &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">         eventMessage CONTAINS[c] \"kCameraStream\"'</span> --no-debug --style compact)</span><br></pre></td></tr></table></figure>\n<p>and launched using <code>launchd</code>.  The launch daemon is dumped into\n<code>/Library/LaunchDaemons/</code> as <code>com.alex.bulb</code>.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plist</span> <span class=\"attr\">version</span>=<span class=\"string\">\"1.0\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>Label<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>com.alex.bulb<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>Program<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/path/to/script.sh<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>RunAtLoad<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">true</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>It can then be launched with <code>launchctl load com.alex.bulb</code> and <code>launchctl start\n...</code>.</p>\n<p>The user experience is pretty good, I hop on a call with Google\nMeet, which enables the camera, which triggers the lamp, and which automatically\nturns it off after I’m done.</p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><p>[0] <a href=\"https://www.ikea.com/sg/en/p/tertial-work-lamp-dark-grey-50355395/\" target=\"_blank\" rel=\"noopener\">https://www.ikea.com/sg/en/p/tertial-work-lamp-dark-grey-50355395/</a></p>\n<p>[1] <a href=\"https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/ScheduledJobs.html#//apple_ref/doc/uid/10000172i-CH1-SW3\" target=\"_blank\" rel=\"noopener\">https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/ScheduledJobs.html#//apple_ref/doc/uid/10000172i-CH1-SW3</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>I’ve been working from home for a long time now (ever since COVID-19) and one of\nthe complaints I’ve had is that I sit facing away from a window (monitors and\nwebcam facing the window). This means my colleagues get a really dark view of my\nface after auto brightness accounts for the window or my ceiling lights.</p>\n<p>To fix this, I bought a cheap IKEA TERTIAL lamp[0] which retails for 20 bucks,\nand aimed it at the wall in front of me to diffuse the light. I used a spare\nPhillips Hue bulb that I had lying around giving me easy controls from Apple\nHome.</p>\n<p><img src=\"https://i.imgur.com/3ka27KB.jpg\" alt=\"bulb\"></p>\n<p>That’s still too many actions for my liking because I’d have to open up\ncontrol center, go to Home, and turn on the light. Not to mention doing the same\nthing one my meeting is over.</p>\n<p>It’s pretty straightforward to automate this, we need to</p>\n<ul>\n<li>detect if the webcam is enabled</li>\n<li>(in my case) setup a proxy over another computer to avoid storing creds on my\ncorp laptop</li>\n<li>control the light over the Hue bridge using its API</li>\n</ul>\n<p>Detecting if the webcam is enabled is surprisingly easy. All the links on Google\npoint to checking for processing using <code>AppleCamera</code> or <code>VDC</code> but I don’t think\nthat works anymore (at least, it does not work for me on Catalina). Instead,\nwe’ll use the <code>Console.app</code> program or the command line equivalent <code>log</code> that\ncomes built-in to MacOS.</p>\n<h2 id=\"Detecting-webcam-use\"><a href=\"#Detecting-webcam-use\" class=\"headerlink\" title=\"Detecting webcam use\"></a>Detecting webcam use</h2><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">log</span> show --predicate <span class=\"string\">'subsystem == \"com.apple.VDCAssistant\" &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">    eventMessage CONTAINS[c] \"kCameraStream\"'</span> --last 1m --no-debug --no-pager \\</span><br><span class=\"line\">    --style compact | tail -n +2)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#or</span></span><br><span class=\"line\"><span class=\"built_in\">log</span> stream ... <span class=\"comment\"># streaming is better to generate events</span></span><br></pre></td></tr></table></figure>\n<p>which tells us if events like <code>kCameraStreamStart</code> and <code>kCameraStreamStop</code>\noccur, which seems to occur each time the camera starts and stops. Note that\nthis command does not seem to work as a normal, unpriviledged user and instead,\nroot access. There’s probably a way to work around this, but this is a hack\n<em>cough</em> short term solution <em>cough</em>.</p>\n<p>Controlling lights over the Hue bridge with it’s API is relatively\nstraightforward, we just need to get a token from the hue developer portal. Once\nyou have the token you can then control the light with a simple <code>PUT</code> query like\nso:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/zsh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script runs on the middleman host</span></span><br><span class=\"line\"></span><br><span class=\"line\">TOKEN=your_token_here</span><br><span class=\"line\">BULB_ID=7</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">read</span> M</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">\"<span class=\"variable\">$M</span>\"</span> = <span class=\"string\">\"bulb:on\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  curl -X PUT -H <span class=\"string\">\"Content-Type: application/json\"</span> -d <span class=\"string\">'&#123;\"on\": true&#125;'</span> \\</span><br><span class=\"line\">    http://<span class=\"variable\">$&#123;HUE_HUB_IP&#125;</span>/api/<span class=\"variable\">$&#123;TOKEN&#125;</span>/lights/<span class=\"variable\">$&#123;BULB_ID&#125;</span>/state</span><br><span class=\"line\"><span class=\"keyword\">elif</span> [ <span class=\"string\">\"<span class=\"variable\">$M</span>\"</span> = <span class=\"string\">\"bulb:off\"</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  curl -X PUT -H <span class=\"string\">\"Content-Type: application/json\"</span> -d <span class=\"string\">'&#123;\"on\": false&#125;'</span> \\</span><br><span class=\"line\">    http://<span class=\"variable\">$&#123;HUE_HUB_IP&#125;</span>/api/<span class=\"variable\">$&#123;TOKEN&#125;</span>/lights/<span class=\"variable\">$&#123;BULB_ID&#125;</span>/state</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br></pre></td></tr></table></figure>\n<p>I have made the script read for events like <code>bulb:on</code> from stdin that’ll be then\nused to toggle the state.</p>\n<h2 id=\"Proxying-the-command\"><a href=\"#Proxying-the-command\" class=\"headerlink\" title=\"Proxying the command\"></a>Proxying the command</h2><p>I keep this running on a personal computer in my household and expose it over a\nTCP port with socat. It’s kept daemonized with start-stop-daemon and OpenRC.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/sbin/openrc-run</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">depend</span></span>() &#123;</span><br><span class=\"line\">        need net</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">start</span></span>() &#123;</span><br><span class=\"line\">        ebegin <span class=\"string\">\"Starting bulb control\"</span></span><br><span class=\"line\">        start-stop-daemon -S -m -p <span class=\"variable\">$&#123;MEET_PIDFILE&#125;</span> -u alex --quiet --background \\</span><br><span class=\"line\">          socat -- -u tcp<span class=\"_\">-l</span>:6338,reuseaddr,fork system:/home/alex/.homebridge/meet.sh</span><br><span class=\"line\">        eend $?</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">stop</span></span>() &#123;</span><br><span class=\"line\">        ebegin <span class=\"string\">\"Stopping bulb control\"</span></span><br><span class=\"line\">        <span class=\"built_in\">kill</span> -- -`cat <span class=\"variable\">$&#123;MEET_PIDFILE&#125;</span>`</span><br><span class=\"line\"></span><br><span class=\"line\">        rm <span class=\"variable\">$&#123;MEET_PIDFILE&#125;</span></span><br><span class=\"line\">        eend $?</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Each time there’s anything sent to tcp:6338 it runs the script which then\ncontrols the bulb. With this, all the corp laptop sees is a string sent to a\nlocal computer using netcat.</p>\n<h2 id=\"Tying-it-all-together\"><a href=\"#Tying-it-all-together\" class=\"headerlink\" title=\"Tying it all together\"></a>Tying it all together</h2><p>(this section is slightly updated, to remove the use of cron)</p>\n<p><del>The script to detect the webcam state is put in the root users crontab on the\nlaptop. It then sends the appropriate string to the proxy script to toggle the\nphysical state of the bulb.</del></p>\n<p>The script to detect the status of the webcam uses <code>log stream</code> instead of <code>log\nshow</code>, which eliminates the need for a minutely cron. 60 seconds without a lamp\nis still quite a noticeable delay in a meeting. Using the stream, it’s put in a\nscript as so</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"built_in\">read</span> S; <span class=\"keyword\">do</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$S</span>\"</span> | grep -q <span class=\"string\">\"kCameraStreamStop\"</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">\"bulb:off\"</span> | nc trixie.local 6338</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$S</span>\"</span> | grep -q <span class=\"string\">\"kCameraStreamStart\"</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">\"bulb:on\"</span> | nc trixie.local 6338</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span> &lt; &lt;(<span class=\"built_in\">log</span> stream --predicate <span class=\"string\">'subsystem == \"com.apple.VDCAssistant\" &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"string\">         eventMessage CONTAINS[c] \"kCameraStream\"'</span> --no-debug --style compact)</span><br></pre></td></tr></table></figure>\n<p>and launched using <code>launchd</code>.  The launch daemon is dumped into\n<code>/Library/LaunchDaemons/</code> as <code>com.alex.bulb</code>.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plist</span> <span class=\"attr\">version</span>=<span class=\"string\">\"1.0\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>Label<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>com.alex.bulb<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>Program<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/path/to/script.sh<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>RunAtLoad<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">true</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>It can then be launched with <code>launchctl load com.alex.bulb</code> and <code>launchctl start\n...</code>.</p>\n<p>The user experience is pretty good, I hop on a call with Google\nMeet, which enables the camera, which triggers the lamp, and which automatically\nturns it off after I’m done.</p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><p>[0] <a href=\"https://www.ikea.com/sg/en/p/tertial-work-lamp-dark-grey-50355395/\" target=\"_blank\" rel=\"noopener\">https://www.ikea.com/sg/en/p/tertial-work-lamp-dark-grey-50355395/</a></p>\n<p>[1] <a href=\"https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/ScheduledJobs.html#//apple_ref/doc/uid/10000172i-CH1-SW3\" target=\"_blank\" rel=\"noopener\">https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/ScheduledJobs.html#//apple_ref/doc/uid/10000172i-CH1-SW3</a></p>\n"},{"title":"iOS OpenVPN Connect Error - read length inconsistency","date":"2017-10-29T11:46:31.000Z","_content":"\nIf you've had the same error as what's described \n[here](https://forums.openvpn.net/viewtopic.php?t=18197), then it just means\nthat you have to insert the given key files inline into the configuration.\n\nThe error usually gets cut off as well in portrait mode so it looks like this:\n\n```\nProfile error : read length inconsistency: /var/mobile..\n```\n\nUsually with Tunnelblick you just bundle the `ca.crt`, `client.key` and\n`client.crt` into a folder and rename it as `server_name.tblk` but that will not\nwork for OpenVPN connect.\n\nInstead do this\n\n```\n#ca ca.crt\n<ca>\n-----BEGIN CERTIFICATE-----\n.\n.\n</ca>\n```\n\nAnd so on.\n\n\n","source":"_posts/iOS-openvpn-connect-read-length-inconsistency.md","raw":"---\ntitle: iOS OpenVPN Connect Error - read length inconsistency\ndate: 2017-10-29 19:46:31\ntags: ios, openvpn\n---\n\nIf you've had the same error as what's described \n[here](https://forums.openvpn.net/viewtopic.php?t=18197), then it just means\nthat you have to insert the given key files inline into the configuration.\n\nThe error usually gets cut off as well in portrait mode so it looks like this:\n\n```\nProfile error : read length inconsistency: /var/mobile..\n```\n\nUsually with Tunnelblick you just bundle the `ca.crt`, `client.key` and\n`client.crt` into a folder and rename it as `server_name.tblk` but that will not\nwork for OpenVPN connect.\n\nInstead do this\n\n```\n#ca ca.crt\n<ca>\n-----BEGIN CERTIFICATE-----\n.\n.\n</ca>\n```\n\nAnd so on.\n\n\n","slug":"iOS-openvpn-connect-read-length-inconsistency","published":1,"updated":"2019-12-28T07:55:42.186Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9p000b4ol35r6wyhin","content":"<p>If you’ve had the same error as what’s described \n<a href=\"https://forums.openvpn.net/viewtopic.php?t=18197\" target=\"_blank\" rel=\"noopener\">here</a>, then it just means\nthat you have to insert the given key files inline into the configuration.</p>\n<p>The error usually gets cut off as well in portrait mode so it looks like this:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Profile error : read length inconsistency: /var/mobile..</span><br></pre></td></tr></table></figure>\n<p>Usually with Tunnelblick you just bundle the <code>ca.crt</code>, <code>client.key</code> and\n<code>client.crt</code> into a folder and rename it as <code>server_name.tblk</code> but that will not\nwork for OpenVPN connect.</p>\n<p>Instead do this</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#ca ca.crt</span><br><span class=\"line\">&lt;ca&gt;</span><br><span class=\"line\">-----BEGIN CERTIFICATE-----</span><br><span class=\"line\">.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;/ca&gt;</span><br></pre></td></tr></table></figure>\n<p>And so on.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>If you’ve had the same error as what’s described \n<a href=\"https://forums.openvpn.net/viewtopic.php?t=18197\" target=\"_blank\" rel=\"noopener\">here</a>, then it just means\nthat you have to insert the given key files inline into the configuration.</p>\n<p>The error usually gets cut off as well in portrait mode so it looks like this:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Profile error : read length inconsistency: /var/mobile..</span><br></pre></td></tr></table></figure>\n<p>Usually with Tunnelblick you just bundle the <code>ca.crt</code>, <code>client.key</code> and\n<code>client.crt</code> into a folder and rename it as <code>server_name.tblk</code> but that will not\nwork for OpenVPN connect.</p>\n<p>Instead do this</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#ca ca.crt</span><br><span class=\"line\">&lt;ca&gt;</span><br><span class=\"line\">-----BEGIN CERTIFICATE-----</span><br><span class=\"line\">.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;/ca&gt;</span><br></pre></td></tr></table></figure>\n<p>And so on.</p>\n"},{"title":"Migrating weechat configuration from Linux to MacOS (and vice versa)","date":"2018-07-25T06:29:13.000Z","_content":"\nIf you are using SSL, the weechat will refuse to connect because the location of\nthe ca file is different on MacOS and Linux (`weechat.network.gnutls_ca_file`).\n\nOn MacOS you can set (for homebrew users)\n\n```\n/set weechat.network.gnutls_ca_file \"/usr/local/etc/openssl/cert.pem\"\n```\n\nAnd on Linux\n\n```\n/set weechat.network.gnutls_ca_file \"/etc/ssl/certs/ca-certificates.crt\"\n```\n\nAnd you should be good to go.\n","source":"_posts/migrating-weechat-linux-macos.md","raw":"---\ntitle: Migrating weechat configuration from Linux to MacOS (and vice versa)\ndate: 2018-07-25 14:29:13\ntags: weechat\n---\n\nIf you are using SSL, the weechat will refuse to connect because the location of\nthe ca file is different on MacOS and Linux (`weechat.network.gnutls_ca_file`).\n\nOn MacOS you can set (for homebrew users)\n\n```\n/set weechat.network.gnutls_ca_file \"/usr/local/etc/openssl/cert.pem\"\n```\n\nAnd on Linux\n\n```\n/set weechat.network.gnutls_ca_file \"/etc/ssl/certs/ca-certificates.crt\"\n```\n\nAnd you should be good to go.\n","slug":"migrating-weechat-linux-macos","published":1,"updated":"2019-12-28T07:55:42.186Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9q000c4ol3yh7n6uky","content":"<p>If you are using SSL, the weechat will refuse to connect because the location of\nthe ca file is different on MacOS and Linux (<code>weechat.network.gnutls_ca_file</code>).</p>\n<p>On MacOS you can set (for homebrew users)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/set weechat.network.gnutls_ca_file &quot;/usr/local/etc/openssl/cert.pem&quot;</span><br></pre></td></tr></table></figure>\n<p>And on Linux</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/set weechat.network.gnutls_ca_file &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br></pre></td></tr></table></figure>\n<p>And you should be good to go.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>If you are using SSL, the weechat will refuse to connect because the location of\nthe ca file is different on MacOS and Linux (<code>weechat.network.gnutls_ca_file</code>).</p>\n<p>On MacOS you can set (for homebrew users)</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/set weechat.network.gnutls_ca_file &quot;/usr/local/etc/openssl/cert.pem&quot;</span><br></pre></td></tr></table></figure>\n<p>And on Linux</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/set weechat.network.gnutls_ca_file &quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><br></pre></td></tr></table></figure>\n<p>And you should be good to go.</p>\n"},{"title":"Tuning VM disk performance for a passthrough setup (host on zfs)","date":"2019-05-05T08:06:49.000Z","_content":"\nThe entirety of this post is thanks to /u/mercenary_sysadmin on\nreddit [(post 1)](https://www.reddit.com/r/zfs/comments/8sbq0y/seeking_advice_for_zfs_layout_for_mixed/e0y8hay/) [(post 2, with benchmarks)](https://www.reddit.com/r/zfs/comments/4oa4xb/how_do_you_configure_virtmanager_to_use_zfs_zvol/d4bofw9/).\nPlenty of beers on me if you see this and are ever in Singapore.\n\nCliffnotes version for me to remember:\n\n### Gaming VM\n\n```\nzfs set recordsize=16K\nqemu-img create -f qcow2 games.qcow2 500G -o cluster_size=16K\n# zfs set compression=lz4 # already inherited\nzfs set atime=off tank/vm\n```\n\nHere's a benchmark from CrystalDiskMark with the above created image:\n\n\n![](https://i.imgur.com/rIR0qbn.png)\n\n\nDisk is attached to the VM as:\n\n```\n-device virtio-scsi-pci,id=scsi0 \\\n-device scsi-hd,bus=scsi0.0,drive=rootfs \\\n-drive id=rootfs,file=/tank/vm/games.qcow2,id=disk,format=qcow2,if=none\n```\n\n### Photography\n\n```\nzfs set recordsize=1M\nzfs set atime=off tank/photos\nzfs set xattr=sa tank/photos\n```\n","source":"_posts/passthrough-disk-performance-zfs.md","raw":"---\ntitle: Tuning VM disk performance for a passthrough setup (host on zfs)\ndate: 2019-05-05 16:06:49\ntags:\n  - zfs\n  - vm\n  - vfio\n  - passthrough\n---\n\nThe entirety of this post is thanks to /u/mercenary_sysadmin on\nreddit [(post 1)](https://www.reddit.com/r/zfs/comments/8sbq0y/seeking_advice_for_zfs_layout_for_mixed/e0y8hay/) [(post 2, with benchmarks)](https://www.reddit.com/r/zfs/comments/4oa4xb/how_do_you_configure_virtmanager_to_use_zfs_zvol/d4bofw9/).\nPlenty of beers on me if you see this and are ever in Singapore.\n\nCliffnotes version for me to remember:\n\n### Gaming VM\n\n```\nzfs set recordsize=16K\nqemu-img create -f qcow2 games.qcow2 500G -o cluster_size=16K\n# zfs set compression=lz4 # already inherited\nzfs set atime=off tank/vm\n```\n\nHere's a benchmark from CrystalDiskMark with the above created image:\n\n\n![](https://i.imgur.com/rIR0qbn.png)\n\n\nDisk is attached to the VM as:\n\n```\n-device virtio-scsi-pci,id=scsi0 \\\n-device scsi-hd,bus=scsi0.0,drive=rootfs \\\n-drive id=rootfs,file=/tank/vm/games.qcow2,id=disk,format=qcow2,if=none\n```\n\n### Photography\n\n```\nzfs set recordsize=1M\nzfs set atime=off tank/photos\nzfs set xattr=sa tank/photos\n```\n","slug":"passthrough-disk-performance-zfs","published":1,"updated":"2019-12-28T07:55:42.186Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9r000e4ol3lnis36wa","content":"<p>The entirety of this post is thanks to /u/mercenary_sysadmin on\nreddit <a href=\"https://www.reddit.com/r/zfs/comments/8sbq0y/seeking_advice_for_zfs_layout_for_mixed/e0y8hay/\" target=\"_blank\" rel=\"noopener\">(post 1)</a> <a href=\"https://www.reddit.com/r/zfs/comments/4oa4xb/how_do_you_configure_virtmanager_to_use_zfs_zvol/d4bofw9/\" target=\"_blank\" rel=\"noopener\">(post 2, with benchmarks)</a>.\nPlenty of beers on me if you see this and are ever in Singapore.</p>\n<p>Cliffnotes version for me to remember:</p>\n<h3 id=\"Gaming-VM\"><a href=\"#Gaming-VM\" class=\"headerlink\" title=\"Gaming VM\"></a>Gaming VM</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zfs set recordsize=16K</span><br><span class=\"line\">qemu-img create -f qcow2 games.qcow2 500G -o cluster_size=16K</span><br><span class=\"line\"># zfs set compression=lz4 # already inherited</span><br><span class=\"line\">zfs set atime=off tank/vm</span><br></pre></td></tr></table></figure>\n<p>Here’s a benchmark from CrystalDiskMark with the above created image:</p>\n<p><img src=\"https://i.imgur.com/rIR0qbn.png\" alt></p>\n<p>Disk is attached to the VM as:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-device virtio-scsi-pci,id=scsi0 \\</span><br><span class=\"line\">-device scsi-hd,bus=scsi0.0,drive=rootfs \\</span><br><span class=\"line\">-drive id=rootfs,file=/tank/vm/games.qcow2,id=disk,format=qcow2,if=none</span><br></pre></td></tr></table></figure>\n<h3 id=\"Photography\"><a href=\"#Photography\" class=\"headerlink\" title=\"Photography\"></a>Photography</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zfs set recordsize=1M</span><br><span class=\"line\">zfs set atime=off tank/photos</span><br><span class=\"line\">zfs set xattr=sa tank/photos</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<p>The entirety of this post is thanks to /u/mercenary_sysadmin on\nreddit <a href=\"https://www.reddit.com/r/zfs/comments/8sbq0y/seeking_advice_for_zfs_layout_for_mixed/e0y8hay/\" target=\"_blank\" rel=\"noopener\">(post 1)</a> <a href=\"https://www.reddit.com/r/zfs/comments/4oa4xb/how_do_you_configure_virtmanager_to_use_zfs_zvol/d4bofw9/\" target=\"_blank\" rel=\"noopener\">(post 2, with benchmarks)</a>.\nPlenty of beers on me if you see this and are ever in Singapore.</p>\n<p>Cliffnotes version for me to remember:</p>\n<h3 id=\"Gaming-VM\"><a href=\"#Gaming-VM\" class=\"headerlink\" title=\"Gaming VM\"></a>Gaming VM</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zfs set recordsize=16K</span><br><span class=\"line\">qemu-img create -f qcow2 games.qcow2 500G -o cluster_size=16K</span><br><span class=\"line\"># zfs set compression=lz4 # already inherited</span><br><span class=\"line\">zfs set atime=off tank/vm</span><br></pre></td></tr></table></figure>\n<p>Here’s a benchmark from CrystalDiskMark with the above created image:</p>\n<p><img src=\"https://i.imgur.com/rIR0qbn.png\" alt></p>\n<p>Disk is attached to the VM as:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-device virtio-scsi-pci,id=scsi0 \\</span><br><span class=\"line\">-device scsi-hd,bus=scsi0.0,drive=rootfs \\</span><br><span class=\"line\">-drive id=rootfs,file=/tank/vm/games.qcow2,id=disk,format=qcow2,if=none</span><br></pre></td></tr></table></figure>\n<h3 id=\"Photography\"><a href=\"#Photography\" class=\"headerlink\" title=\"Photography\"></a>Photography</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zfs set recordsize=1M</span><br><span class=\"line\">zfs set atime=off tank/photos</span><br><span class=\"line\">zfs set xattr=sa tank/photos</span><br></pre></td></tr></table></figure>\n"},{"title":"ROS Kinetic Installation on MacOS (Homebrew, as of May '17)","date":"2017-05-09T07:05:20.000Z","_content":"\nEvery now and again I nuke my ROS installation and build from scratch because of\ndependencies getting updated/my usecase changing. I prefer to have two\ninstallations of ROS on my system these days. Jade, for stability and feature\nmatching with my platforms and Kinetic for testing and submitting patches on. I\nmanage both in an `eselect`esque way (it's a tool found on Gentoo Linux for\nmanaging versions via symlinks).\n\n```\nsudo mkdir /opt/kinetic\nsudo mkdir /opt/jade\nsudo chown -R `whoami`:staff /opt/kinetic /opt/jade\nln -s /opt/kinetic/install /opt/ros/kinetic # or jade\n```\n\nOpenCV3\n-------\n\nHomebrew uses an outdated brew contrib release which does not have CMake fixes\nfor the freetype contrib module. Install it with `--HEAD`:\n\n```\nbrew install opencv3 --with-python --with-eigen --c++11 --with-contrib \\\n  --with-ffmpeg --with-tbb --with-qt --with-non-free --without-test --HEAD\n```\n\nNote: takes around 20 minutes to compile.\n\nAFAIK, Jade still uses OpenCV2 while Kinetic has migrated to CV3. To build\n`cv_bridge` do \n\n```\nbrew ln opencv3 --force\n```\n\nThis may cause a problem with Jade stuff, so unlink and relink opencv2 if need\nbe. Homebrew warns about this when you try to install opencv3.\n\nQt\n--\n\n```\necho 'export PATH=\"/usr/local/opt/qt/bin:$PATH\"' >> ~/.zshrc\n```\n\nOther than that, there were absolutely no errors involved in compiling the\ndesktop version of kinetic on MacOS. Wonderful. Easiest it's ever been really.\n\n","source":"_posts/ros-kinetic-macos-may17.md","raw":"---\ntitle: ROS Kinetic Installation on MacOS (Homebrew, as of May '17)\ndate: 2017-05-09 15:05:20\ntags: ros\n---\n\nEvery now and again I nuke my ROS installation and build from scratch because of\ndependencies getting updated/my usecase changing. I prefer to have two\ninstallations of ROS on my system these days. Jade, for stability and feature\nmatching with my platforms and Kinetic for testing and submitting patches on. I\nmanage both in an `eselect`esque way (it's a tool found on Gentoo Linux for\nmanaging versions via symlinks).\n\n```\nsudo mkdir /opt/kinetic\nsudo mkdir /opt/jade\nsudo chown -R `whoami`:staff /opt/kinetic /opt/jade\nln -s /opt/kinetic/install /opt/ros/kinetic # or jade\n```\n\nOpenCV3\n-------\n\nHomebrew uses an outdated brew contrib release which does not have CMake fixes\nfor the freetype contrib module. Install it with `--HEAD`:\n\n```\nbrew install opencv3 --with-python --with-eigen --c++11 --with-contrib \\\n  --with-ffmpeg --with-tbb --with-qt --with-non-free --without-test --HEAD\n```\n\nNote: takes around 20 minutes to compile.\n\nAFAIK, Jade still uses OpenCV2 while Kinetic has migrated to CV3. To build\n`cv_bridge` do \n\n```\nbrew ln opencv3 --force\n```\n\nThis may cause a problem with Jade stuff, so unlink and relink opencv2 if need\nbe. Homebrew warns about this when you try to install opencv3.\n\nQt\n--\n\n```\necho 'export PATH=\"/usr/local/opt/qt/bin:$PATH\"' >> ~/.zshrc\n```\n\nOther than that, there were absolutely no errors involved in compiling the\ndesktop version of kinetic on MacOS. Wonderful. Easiest it's ever been really.\n\n","slug":"ros-kinetic-macos-may17","published":1,"updated":"2019-12-28T07:55:42.186Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9t000f4ol3142wkpeo","content":"<p>Every now and again I nuke my ROS installation and build from scratch because of\ndependencies getting updated/my usecase changing. I prefer to have two\ninstallations of ROS on my system these days. Jade, for stability and feature\nmatching with my platforms and Kinetic for testing and submitting patches on. I\nmanage both in an <code>eselect</code>esque way (it’s a tool found on Gentoo Linux for\nmanaging versions via symlinks).</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mkdir /opt/kinetic</span><br><span class=\"line\">sudo mkdir /opt/jade</span><br><span class=\"line\">sudo chown -R `whoami`:staff /opt/kinetic /opt/jade</span><br><span class=\"line\">ln -s /opt/kinetic/install /opt/ros/kinetic # or jade</span><br></pre></td></tr></table></figure>\n<h2 id=\"OpenCV3\"><a href=\"#OpenCV3\" class=\"headerlink\" title=\"OpenCV3\"></a>OpenCV3</h2><p>Homebrew uses an outdated brew contrib release which does not have CMake fixes\nfor the freetype contrib module. Install it with <code>--HEAD</code>:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install opencv3 --with-python --with-eigen --c++11 --with-contrib \\</span><br><span class=\"line\">  --with-ffmpeg --with-tbb --with-qt --with-non-free --without-test --HEAD</span><br></pre></td></tr></table></figure>\n<p>Note: takes around 20 minutes to compile.</p>\n<p>AFAIK, Jade still uses OpenCV2 while Kinetic has migrated to CV3. To build\n<code>cv_bridge</code> do </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew ln opencv3 --force</span><br></pre></td></tr></table></figure>\n<p>This may cause a problem with Jade stuff, so unlink and relink opencv2 if need\nbe. Homebrew warns about this when you try to install opencv3.</p>\n<h2 id=\"Qt\"><a href=\"#Qt\" class=\"headerlink\" title=\"Qt\"></a>Qt</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &apos;export PATH=&quot;/usr/local/opt/qt/bin:$PATH&quot;&apos; &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure>\n<p>Other than that, there were absolutely no errors involved in compiling the\ndesktop version of kinetic on MacOS. Wonderful. Easiest it’s ever been really.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Every now and again I nuke my ROS installation and build from scratch because of\ndependencies getting updated/my usecase changing. I prefer to have two\ninstallations of ROS on my system these days. Jade, for stability and feature\nmatching with my platforms and Kinetic for testing and submitting patches on. I\nmanage both in an <code>eselect</code>esque way (it’s a tool found on Gentoo Linux for\nmanaging versions via symlinks).</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mkdir /opt/kinetic</span><br><span class=\"line\">sudo mkdir /opt/jade</span><br><span class=\"line\">sudo chown -R `whoami`:staff /opt/kinetic /opt/jade</span><br><span class=\"line\">ln -s /opt/kinetic/install /opt/ros/kinetic # or jade</span><br></pre></td></tr></table></figure>\n<h2 id=\"OpenCV3\"><a href=\"#OpenCV3\" class=\"headerlink\" title=\"OpenCV3\"></a>OpenCV3</h2><p>Homebrew uses an outdated brew contrib release which does not have CMake fixes\nfor the freetype contrib module. Install it with <code>--HEAD</code>:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install opencv3 --with-python --with-eigen --c++11 --with-contrib \\</span><br><span class=\"line\">  --with-ffmpeg --with-tbb --with-qt --with-non-free --without-test --HEAD</span><br></pre></td></tr></table></figure>\n<p>Note: takes around 20 minutes to compile.</p>\n<p>AFAIK, Jade still uses OpenCV2 while Kinetic has migrated to CV3. To build\n<code>cv_bridge</code> do </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew ln opencv3 --force</span><br></pre></td></tr></table></figure>\n<p>This may cause a problem with Jade stuff, so unlink and relink opencv2 if need\nbe. Homebrew warns about this when you try to install opencv3.</p>\n<h2 id=\"Qt\"><a href=\"#Qt\" class=\"headerlink\" title=\"Qt\"></a>Qt</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &apos;export PATH=&quot;/usr/local/opt/qt/bin:$PATH&quot;&apos; &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure>\n<p>Other than that, there were absolutely no errors involved in compiling the\ndesktop version of kinetic on MacOS. Wonderful. Easiest it’s ever been really.</p>\n"},{"title":"Setting up TUN/TAP networking for QEMU VM's (and bonus wireguard)","date":"2019-05-13T09:44:18.000Z","_content":"\nI needed to setup a VM that could _only_ have connectivity through a\nspecific wireguard endpoint. Previoiusly, the VM was using user mode networking\n(SLiRP) which required no setup. I asked around on IRC and was told that\nlibvirt takes care of that stuff for you so most folks don't care - but I\nalready have a few VM's and am not ready for black magic or XML. I will\neventually have to move them, I suppose. Windows VMs don't take kindly to even\nthe slightest of parameter changes, so if there's a tool that takes the\ncommandline flags and generates the XML, that'd be awesome.\n\nIf you really need SLiRP networking (user mode) to work and want to route\nthrough wireguard, you could consider using network namespaces to achieve the\nsame result. I like the flexibility offered by the TAP setup that lets my host\nand LAN devices interfact with the VM in a much more _normal_ way (subjective).\n\n## Network Setup\n\n### Diagram\n```\n     bridge masters\n\n  +--------+   +--------+\n  | vm0    |   |  vm1   |\n  +---+----+   +---+----+\n      |            |\n+-----+------------+-----+   +-------------+   +----------+\n|         br0            |   |     wg0     |   |   eth0   |\n|     10.0.3.0/24        |   | 10.0.0.1/24 |   |          |\n+------------------------+   +-------------+   +----------+\n```\n\n`vm0` and `vm1` are TUN devices.\n\nCaveat: Not all traffic in the host is routed through the wireguard interface so\nwe need some `ip -4 rule` usage to route.\n\n### Wireguard\n\nThis is the most straightforward so let's get it out of the way. You need the\nkernel module loaded.\n\n```sh\n# modprobe wireguard\nip link add dev wg0 type wireguard\nip addr add 10.0.0.2/24 dev wg0\nwg set wg0 private-key\nwg set wg0 peer PUBLIC_KEY_HERE allowed-ips 0.0.0.0/0 endpoint stty.io:port\nip link set up dev wg0\n```\n\nAnd on the \"server\" do the same, but with some modifications\n\n```sh\nwg set wg0 peer PUBLIC_KEY_HERE allowed-ips 10.0.0.2/32, 10.0.3.0/24\niptables -A FORWARD -i wg0 -j ACCEPT\niptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE\n```\n\nYou'd also need to enable IP forwarding\n\n```sh\nsudo sysctl -w net.ipv4.ip_forward=1\n```\n\nNotice how we've allowed the bridge's ip range in allowed-ips. Bridge setup\ntime:\n\n\n### Bridge and TUN devices\n\nIf you need to run qemu without requiring root user, setup a group `netdev` and\nadd yourself to it. Logout and login to take effect. `id` must report that your\nuser is in `netdev` before you proceed. Also create a new udev rule\n\n```\nKERNEL==\"tun\", GROUP=\"netdev\", MODE=\"0660\", OPTIONS+=\"static_node=net/tun\"\n```\n\nto configure your TUN devices to use the group. I put mine in\n`/etc/udev/rules.d/10-qemu.rules` along with some other stuff for passthrough.\n\nYour kernel needs \"Universal TUN/TAP devices\" enabled.\n\nFor the bridge:\n```sh\nip link add br0 type bridge\nip addr add 10.0.3.0/24 dev br0\nip link set up dev br0\n```\n\nFor a DHCP server we can use `dnsmasq`\n\n```sh\nsudo dnsmasq --interface=br0 --bind-interfaces --dhcp-range=10.0.3.0,10.0.3.255\n```\n\nFor the VM's adapters\n\n```sh\nip tuntap add vm0 mode tap group netdev\nip link set vm0 up\nip link set vm0 master br0\n```\n\n### QEMU Parameters\n\n```sh\n-device virtio-net-pci,netdev=vm0 \\\n-netdev tap,id=vm0,ifname=vm0,script=no \\\n```\n\nImportant points\n\n* instead of `virtio-net-pci` you can use anything else like `e1000` which has\ninbuilt drivers in windows. I installed it manually from the driver disk\nprovided by Red Hat.\n* `script=no` is important, else QEMU tries to init a new adapter itself and\nthat required superuser\n* if `ifname=vm0` is not provided `script=` doesn't work because qemu doesn't\nknow which adapter to configure and it'll try to run anyway.\n\nYou'll get an error saying qemu can't configure the device which looks\nsuspiciously like you didn't setup your permissions correctly, but it's not.\n\n\nAt this point your VM should boot and the network adapter should recieve an IP\naddress from dnsmasq.\n\n### Routing and Internet Connectivity\n\nLike I mentioned before, the host does not have a default route through the\nwireguard endpoint. We only want traffic from the bridge, or even, specific VMs\nto go through the endpoint.\n\n```sh\nip route add default via 10.0.0.1 dev wg0 priority 1 table 1\nip rule add from 10.0.3.0/24 priority 1 lookup 1\n```\n\nThis should be sufficient to do policy based routing from the VM to the internet\nand to the host. You should verify this by pinging from within the VM and from\nthe host.\n\n## Thanks to\n\nDocumentation found on the [kvm website](https://www.linux-kvm.org/page/Networking)\nand IRC users grawity, tds and others.\n","source":"_posts/qemu-vm-wireguard-vpn-tun-tap-networking.md","raw":"---\ntitle: Setting up TUN/TAP networking for QEMU VM's (and bonus wireguard)\ndate: 2019-05-13 17:44:18\ntags:\n  - qemu\n  - passthrough\n  - vpn\n  - wireguard\n  - networking\n---\n\nI needed to setup a VM that could _only_ have connectivity through a\nspecific wireguard endpoint. Previoiusly, the VM was using user mode networking\n(SLiRP) which required no setup. I asked around on IRC and was told that\nlibvirt takes care of that stuff for you so most folks don't care - but I\nalready have a few VM's and am not ready for black magic or XML. I will\neventually have to move them, I suppose. Windows VMs don't take kindly to even\nthe slightest of parameter changes, so if there's a tool that takes the\ncommandline flags and generates the XML, that'd be awesome.\n\nIf you really need SLiRP networking (user mode) to work and want to route\nthrough wireguard, you could consider using network namespaces to achieve the\nsame result. I like the flexibility offered by the TAP setup that lets my host\nand LAN devices interfact with the VM in a much more _normal_ way (subjective).\n\n## Network Setup\n\n### Diagram\n```\n     bridge masters\n\n  +--------+   +--------+\n  | vm0    |   |  vm1   |\n  +---+----+   +---+----+\n      |            |\n+-----+------------+-----+   +-------------+   +----------+\n|         br0            |   |     wg0     |   |   eth0   |\n|     10.0.3.0/24        |   | 10.0.0.1/24 |   |          |\n+------------------------+   +-------------+   +----------+\n```\n\n`vm0` and `vm1` are TUN devices.\n\nCaveat: Not all traffic in the host is routed through the wireguard interface so\nwe need some `ip -4 rule` usage to route.\n\n### Wireguard\n\nThis is the most straightforward so let's get it out of the way. You need the\nkernel module loaded.\n\n```sh\n# modprobe wireguard\nip link add dev wg0 type wireguard\nip addr add 10.0.0.2/24 dev wg0\nwg set wg0 private-key\nwg set wg0 peer PUBLIC_KEY_HERE allowed-ips 0.0.0.0/0 endpoint stty.io:port\nip link set up dev wg0\n```\n\nAnd on the \"server\" do the same, but with some modifications\n\n```sh\nwg set wg0 peer PUBLIC_KEY_HERE allowed-ips 10.0.0.2/32, 10.0.3.0/24\niptables -A FORWARD -i wg0 -j ACCEPT\niptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE\n```\n\nYou'd also need to enable IP forwarding\n\n```sh\nsudo sysctl -w net.ipv4.ip_forward=1\n```\n\nNotice how we've allowed the bridge's ip range in allowed-ips. Bridge setup\ntime:\n\n\n### Bridge and TUN devices\n\nIf you need to run qemu without requiring root user, setup a group `netdev` and\nadd yourself to it. Logout and login to take effect. `id` must report that your\nuser is in `netdev` before you proceed. Also create a new udev rule\n\n```\nKERNEL==\"tun\", GROUP=\"netdev\", MODE=\"0660\", OPTIONS+=\"static_node=net/tun\"\n```\n\nto configure your TUN devices to use the group. I put mine in\n`/etc/udev/rules.d/10-qemu.rules` along with some other stuff for passthrough.\n\nYour kernel needs \"Universal TUN/TAP devices\" enabled.\n\nFor the bridge:\n```sh\nip link add br0 type bridge\nip addr add 10.0.3.0/24 dev br0\nip link set up dev br0\n```\n\nFor a DHCP server we can use `dnsmasq`\n\n```sh\nsudo dnsmasq --interface=br0 --bind-interfaces --dhcp-range=10.0.3.0,10.0.3.255\n```\n\nFor the VM's adapters\n\n```sh\nip tuntap add vm0 mode tap group netdev\nip link set vm0 up\nip link set vm0 master br0\n```\n\n### QEMU Parameters\n\n```sh\n-device virtio-net-pci,netdev=vm0 \\\n-netdev tap,id=vm0,ifname=vm0,script=no \\\n```\n\nImportant points\n\n* instead of `virtio-net-pci` you can use anything else like `e1000` which has\ninbuilt drivers in windows. I installed it manually from the driver disk\nprovided by Red Hat.\n* `script=no` is important, else QEMU tries to init a new adapter itself and\nthat required superuser\n* if `ifname=vm0` is not provided `script=` doesn't work because qemu doesn't\nknow which adapter to configure and it'll try to run anyway.\n\nYou'll get an error saying qemu can't configure the device which looks\nsuspiciously like you didn't setup your permissions correctly, but it's not.\n\n\nAt this point your VM should boot and the network adapter should recieve an IP\naddress from dnsmasq.\n\n### Routing and Internet Connectivity\n\nLike I mentioned before, the host does not have a default route through the\nwireguard endpoint. We only want traffic from the bridge, or even, specific VMs\nto go through the endpoint.\n\n```sh\nip route add default via 10.0.0.1 dev wg0 priority 1 table 1\nip rule add from 10.0.3.0/24 priority 1 lookup 1\n```\n\nThis should be sufficient to do policy based routing from the VM to the internet\nand to the host. You should verify this by pinging from within the VM and from\nthe host.\n\n## Thanks to\n\nDocumentation found on the [kvm website](https://www.linux-kvm.org/page/Networking)\nand IRC users grawity, tds and others.\n","slug":"qemu-vm-wireguard-vpn-tun-tap-networking","published":1,"updated":"2019-12-28T07:55:42.186Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9v000h4ol32vmgp07p","content":"<p>I needed to setup a VM that could <em>only</em> have connectivity through a\nspecific wireguard endpoint. Previoiusly, the VM was using user mode networking\n(SLiRP) which required no setup. I asked around on IRC and was told that\nlibvirt takes care of that stuff for you so most folks don’t care - but I\nalready have a few VM’s and am not ready for black magic or XML. I will\neventually have to move them, I suppose. Windows VMs don’t take kindly to even\nthe slightest of parameter changes, so if there’s a tool that takes the\ncommandline flags and generates the XML, that’d be awesome.</p>\n<p>If you really need SLiRP networking (user mode) to work and want to route\nthrough wireguard, you could consider using network namespaces to achieve the\nsame result. I like the flexibility offered by the TAP setup that lets my host\nand LAN devices interfact with the VM in a much more <em>normal</em> way (subjective).</p>\n<h2 id=\"Network-Setup\"><a href=\"#Network-Setup\" class=\"headerlink\" title=\"Network Setup\"></a>Network Setup</h2><h3 id=\"Diagram\"><a href=\"#Diagram\" class=\"headerlink\" title=\"Diagram\"></a>Diagram</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">     bridge masters</span><br><span class=\"line\"></span><br><span class=\"line\">  +--------+   +--------+</span><br><span class=\"line\">  | vm0    |   |  vm1   |</span><br><span class=\"line\">  +---+----+   +---+----+</span><br><span class=\"line\">      |            |</span><br><span class=\"line\">+-----+------------+-----+   +-------------+   +----------+</span><br><span class=\"line\">|         br0            |   |     wg0     |   |   eth0   |</span><br><span class=\"line\">|     10.0.3.0/24        |   | 10.0.0.1/24 |   |          |</span><br><span class=\"line\">+------------------------+   +-------------+   +----------+</span><br></pre></td></tr></table></figure>\n<p><code>vm0</code> and <code>vm1</code> are TUN devices.</p>\n<p>Caveat: Not all traffic in the host is routed through the wireguard interface so\nwe need some <code>ip -4 rule</code> usage to route.</p>\n<h3 id=\"Wireguard\"><a href=\"#Wireguard\" class=\"headerlink\" title=\"Wireguard\"></a>Wireguard</h3><p>This is the most straightforward so let’s get it out of the way. You need the\nkernel module loaded.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># modprobe wireguard</span></span><br><span class=\"line\">ip link add dev wg0 <span class=\"built_in\">type</span> wireguard</span><br><span class=\"line\">ip addr add 10.0.0.2/24 dev wg0</span><br><span class=\"line\">wg <span class=\"built_in\">set</span> wg0 private-key</span><br><span class=\"line\">wg <span class=\"built_in\">set</span> wg0 peer PUBLIC_KEY_HERE allowed-ips 0.0.0.0/0 endpoint stty.io:port</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> up dev wg0</span><br></pre></td></tr></table></figure>\n<p>And on the “server” do the same, but with some modifications</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wg <span class=\"built_in\">set</span> wg0 peer PUBLIC_KEY_HERE allowed-ips 10.0.0.2/32, 10.0.3.0/24</span><br><span class=\"line\">iptables -A FORWARD -i wg0 -j ACCEPT</span><br><span class=\"line\">iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>\n<p>You’d also need to enable IP forwarding</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure>\n<p>Notice how we’ve allowed the bridge’s ip range in allowed-ips. Bridge setup\ntime:</p>\n<h3 id=\"Bridge-and-TUN-devices\"><a href=\"#Bridge-and-TUN-devices\" class=\"headerlink\" title=\"Bridge and TUN devices\"></a>Bridge and TUN devices</h3><p>If you need to run qemu without requiring root user, setup a group <code>netdev</code> and\nadd yourself to it. Logout and login to take effect. <code>id</code> must report that your\nuser is in <code>netdev</code> before you proceed. Also create a new udev rule</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KERNEL==&quot;tun&quot;, GROUP=&quot;netdev&quot;, MODE=&quot;0660&quot;, OPTIONS+=&quot;static_node=net/tun&quot;</span><br></pre></td></tr></table></figure>\n<p>to configure your TUN devices to use the group. I put mine in\n<code>/etc/udev/rules.d/10-qemu.rules</code> along with some other stuff for passthrough.</p>\n<p>Your kernel needs “Universal TUN/TAP devices” enabled.</p>\n<p>For the bridge:\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip link add br0 <span class=\"built_in\">type</span> bridge</span><br><span class=\"line\">ip addr add 10.0.3.0/24 dev br0</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> up dev br0</span><br></pre></td></tr></table></figure></p>\n<p>For a DHCP server we can use <code>dnsmasq</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dnsmasq --interface=br0 --<span class=\"built_in\">bind</span>-interfaces --dhcp-range=10.0.3.0,10.0.3.255</span><br></pre></td></tr></table></figure>\n<p>For the VM’s adapters</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip tuntap add vm0 mode tap group netdev</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> vm0 up</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> vm0 master br0</span><br></pre></td></tr></table></figure>\n<h3 id=\"QEMU-Parameters\"><a href=\"#QEMU-Parameters\" class=\"headerlink\" title=\"QEMU Parameters\"></a>QEMU Parameters</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-device virtio-net-pci,netdev=vm0 \\</span><br><span class=\"line\">-netdev tap,id=vm0,ifname=vm0,script=no \\</span><br></pre></td></tr></table></figure>\n<p>Important points</p>\n<ul>\n<li>instead of <code>virtio-net-pci</code> you can use anything else like <code>e1000</code> which has\ninbuilt drivers in windows. I installed it manually from the driver disk\nprovided by Red Hat.</li>\n<li><code>script=no</code> is important, else QEMU tries to init a new adapter itself and\nthat required superuser</li>\n<li>if <code>ifname=vm0</code> is not provided <code>script=</code> doesn’t work because qemu doesn’t\nknow which adapter to configure and it’ll try to run anyway.</li>\n</ul>\n<p>You’ll get an error saying qemu can’t configure the device which looks\nsuspiciously like you didn’t setup your permissions correctly, but it’s not.</p>\n<p>At this point your VM should boot and the network adapter should recieve an IP\naddress from dnsmasq.</p>\n<h3 id=\"Routing-and-Internet-Connectivity\"><a href=\"#Routing-and-Internet-Connectivity\" class=\"headerlink\" title=\"Routing and Internet Connectivity\"></a>Routing and Internet Connectivity</h3><p>Like I mentioned before, the host does not have a default route through the\nwireguard endpoint. We only want traffic from the bridge, or even, specific VMs\nto go through the endpoint.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip route add default via 10.0.0.1 dev wg0 priority 1 table 1</span><br><span class=\"line\">ip rule add from 10.0.3.0/24 priority 1 lookup 1</span><br></pre></td></tr></table></figure>\n<p>This should be sufficient to do policy based routing from the VM to the internet\nand to the host. You should verify this by pinging from within the VM and from\nthe host.</p>\n<h2 id=\"Thanks-to\"><a href=\"#Thanks-to\" class=\"headerlink\" title=\"Thanks to\"></a>Thanks to</h2><p>Documentation found on the <a href=\"https://www.linux-kvm.org/page/Networking\" target=\"_blank\" rel=\"noopener\">kvm website</a>\nand IRC users grawity, tds and others.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I needed to setup a VM that could <em>only</em> have connectivity through a\nspecific wireguard endpoint. Previoiusly, the VM was using user mode networking\n(SLiRP) which required no setup. I asked around on IRC and was told that\nlibvirt takes care of that stuff for you so most folks don’t care - but I\nalready have a few VM’s and am not ready for black magic or XML. I will\neventually have to move them, I suppose. Windows VMs don’t take kindly to even\nthe slightest of parameter changes, so if there’s a tool that takes the\ncommandline flags and generates the XML, that’d be awesome.</p>\n<p>If you really need SLiRP networking (user mode) to work and want to route\nthrough wireguard, you could consider using network namespaces to achieve the\nsame result. I like the flexibility offered by the TAP setup that lets my host\nand LAN devices interfact with the VM in a much more <em>normal</em> way (subjective).</p>\n<h2 id=\"Network-Setup\"><a href=\"#Network-Setup\" class=\"headerlink\" title=\"Network Setup\"></a>Network Setup</h2><h3 id=\"Diagram\"><a href=\"#Diagram\" class=\"headerlink\" title=\"Diagram\"></a>Diagram</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">     bridge masters</span><br><span class=\"line\"></span><br><span class=\"line\">  +--------+   +--------+</span><br><span class=\"line\">  | vm0    |   |  vm1   |</span><br><span class=\"line\">  +---+----+   +---+----+</span><br><span class=\"line\">      |            |</span><br><span class=\"line\">+-----+------------+-----+   +-------------+   +----------+</span><br><span class=\"line\">|         br0            |   |     wg0     |   |   eth0   |</span><br><span class=\"line\">|     10.0.3.0/24        |   | 10.0.0.1/24 |   |          |</span><br><span class=\"line\">+------------------------+   +-------------+   +----------+</span><br></pre></td></tr></table></figure>\n<p><code>vm0</code> and <code>vm1</code> are TUN devices.</p>\n<p>Caveat: Not all traffic in the host is routed through the wireguard interface so\nwe need some <code>ip -4 rule</code> usage to route.</p>\n<h3 id=\"Wireguard\"><a href=\"#Wireguard\" class=\"headerlink\" title=\"Wireguard\"></a>Wireguard</h3><p>This is the most straightforward so let’s get it out of the way. You need the\nkernel module loaded.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># modprobe wireguard</span></span><br><span class=\"line\">ip link add dev wg0 <span class=\"built_in\">type</span> wireguard</span><br><span class=\"line\">ip addr add 10.0.0.2/24 dev wg0</span><br><span class=\"line\">wg <span class=\"built_in\">set</span> wg0 private-key</span><br><span class=\"line\">wg <span class=\"built_in\">set</span> wg0 peer PUBLIC_KEY_HERE allowed-ips 0.0.0.0/0 endpoint stty.io:port</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> up dev wg0</span><br></pre></td></tr></table></figure>\n<p>And on the “server” do the same, but with some modifications</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wg <span class=\"built_in\">set</span> wg0 peer PUBLIC_KEY_HERE allowed-ips 10.0.0.2/32, 10.0.3.0/24</span><br><span class=\"line\">iptables -A FORWARD -i wg0 -j ACCEPT</span><br><span class=\"line\">iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>\n<p>You’d also need to enable IP forwarding</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure>\n<p>Notice how we’ve allowed the bridge’s ip range in allowed-ips. Bridge setup\ntime:</p>\n<h3 id=\"Bridge-and-TUN-devices\"><a href=\"#Bridge-and-TUN-devices\" class=\"headerlink\" title=\"Bridge and TUN devices\"></a>Bridge and TUN devices</h3><p>If you need to run qemu without requiring root user, setup a group <code>netdev</code> and\nadd yourself to it. Logout and login to take effect. <code>id</code> must report that your\nuser is in <code>netdev</code> before you proceed. Also create a new udev rule</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KERNEL==&quot;tun&quot;, GROUP=&quot;netdev&quot;, MODE=&quot;0660&quot;, OPTIONS+=&quot;static_node=net/tun&quot;</span><br></pre></td></tr></table></figure>\n<p>to configure your TUN devices to use the group. I put mine in\n<code>/etc/udev/rules.d/10-qemu.rules</code> along with some other stuff for passthrough.</p>\n<p>Your kernel needs “Universal TUN/TAP devices” enabled.</p>\n<p>For the bridge:\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip link add br0 <span class=\"built_in\">type</span> bridge</span><br><span class=\"line\">ip addr add 10.0.3.0/24 dev br0</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> up dev br0</span><br></pre></td></tr></table></figure></p>\n<p>For a DHCP server we can use <code>dnsmasq</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dnsmasq --interface=br0 --<span class=\"built_in\">bind</span>-interfaces --dhcp-range=10.0.3.0,10.0.3.255</span><br></pre></td></tr></table></figure>\n<p>For the VM’s adapters</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip tuntap add vm0 mode tap group netdev</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> vm0 up</span><br><span class=\"line\">ip link <span class=\"built_in\">set</span> vm0 master br0</span><br></pre></td></tr></table></figure>\n<h3 id=\"QEMU-Parameters\"><a href=\"#QEMU-Parameters\" class=\"headerlink\" title=\"QEMU Parameters\"></a>QEMU Parameters</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-device virtio-net-pci,netdev=vm0 \\</span><br><span class=\"line\">-netdev tap,id=vm0,ifname=vm0,script=no \\</span><br></pre></td></tr></table></figure>\n<p>Important points</p>\n<ul>\n<li>instead of <code>virtio-net-pci</code> you can use anything else like <code>e1000</code> which has\ninbuilt drivers in windows. I installed it manually from the driver disk\nprovided by Red Hat.</li>\n<li><code>script=no</code> is important, else QEMU tries to init a new adapter itself and\nthat required superuser</li>\n<li>if <code>ifname=vm0</code> is not provided <code>script=</code> doesn’t work because qemu doesn’t\nknow which adapter to configure and it’ll try to run anyway.</li>\n</ul>\n<p>You’ll get an error saying qemu can’t configure the device which looks\nsuspiciously like you didn’t setup your permissions correctly, but it’s not.</p>\n<p>At this point your VM should boot and the network adapter should recieve an IP\naddress from dnsmasq.</p>\n<h3 id=\"Routing-and-Internet-Connectivity\"><a href=\"#Routing-and-Internet-Connectivity\" class=\"headerlink\" title=\"Routing and Internet Connectivity\"></a>Routing and Internet Connectivity</h3><p>Like I mentioned before, the host does not have a default route through the\nwireguard endpoint. We only want traffic from the bridge, or even, specific VMs\nto go through the endpoint.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip route add default via 10.0.0.1 dev wg0 priority 1 table 1</span><br><span class=\"line\">ip rule add from 10.0.3.0/24 priority 1 lookup 1</span><br></pre></td></tr></table></figure>\n<p>This should be sufficient to do policy based routing from the VM to the internet\nand to the host. You should verify this by pinging from within the VM and from\nthe host.</p>\n<h2 id=\"Thanks-to\"><a href=\"#Thanks-to\" class=\"headerlink\" title=\"Thanks to\"></a>Thanks to</h2><p>Documentation found on the <a href=\"https://www.linux-kvm.org/page/Networking\" target=\"_blank\" rel=\"noopener\">kvm website</a>\nand IRC users grawity, tds and others.</p>\n"},{"title":"Parallel rsync","date":"2018-07-19T10:21:24.000Z","_content":"\nNote: This post is outdated. I don't saturate my link at home because of\nbandwidth delay product[0]. I knew this at the point of writing the post, but I\ncould never get my calculated theoritical speed (even considering bdp). It was\nmost probably because I did not consider the number of hops between me and the\nserver when doing the calculations.\n\nI removed the extra steps to parallelize rsync like so\n```sh\nssh root@bifrost.wg find -L /var/media/dir \\\n      -type f -printf '%P\\\\0' | \\\n      parallel -0 --no-run-if-empty rsync -avrRsz --progress \\\n      root@bifrost.wg:\"/var/media/dir/{}\" /tank/tv/dir\n```\n\n[0] https://en.wikipedia.org/wiki/Bandwidth-delay_product\n\nOriginal post:\n\nNot sure if its because of my ISP packet shaping or otherwise, but single\nconnections never saturate my 1gbps link at home. I needed to move a lot of\nmusic files off a server back to a new storage pool so:\n\n* first make a list of files\n```sh\nfind /zroot/DATA/music/ -type f -name \"*.flac\" \\\n       -exec dirname \"{}\" \\; | uniq\n```\n\n* split it into 12 parts\n```\nsplit -l N list\n```\n\n* use xargs to parallel rsync\n```sh\nfind . -name \"xa*\" -print0 | xargs -0 -I{} -n 1 -P12 rsync -avzr \\\n       --no-links --quiet --files-from={} alex@host:/ /tank/music/\n```\n\nThis gets me on average 25MB/s as opposed to 2MB/s on single threaded rsync.\n","source":"_posts/rsync-parallel.md","raw":"---\ntitle: Parallel rsync\ndate: 2018-07-19 18:21:24\ntags:\n---\n\nNote: This post is outdated. I don't saturate my link at home because of\nbandwidth delay product[0]. I knew this at the point of writing the post, but I\ncould never get my calculated theoritical speed (even considering bdp). It was\nmost probably because I did not consider the number of hops between me and the\nserver when doing the calculations.\n\nI removed the extra steps to parallelize rsync like so\n```sh\nssh root@bifrost.wg find -L /var/media/dir \\\n      -type f -printf '%P\\\\0' | \\\n      parallel -0 --no-run-if-empty rsync -avrRsz --progress \\\n      root@bifrost.wg:\"/var/media/dir/{}\" /tank/tv/dir\n```\n\n[0] https://en.wikipedia.org/wiki/Bandwidth-delay_product\n\nOriginal post:\n\nNot sure if its because of my ISP packet shaping or otherwise, but single\nconnections never saturate my 1gbps link at home. I needed to move a lot of\nmusic files off a server back to a new storage pool so:\n\n* first make a list of files\n```sh\nfind /zroot/DATA/music/ -type f -name \"*.flac\" \\\n       -exec dirname \"{}\" \\; | uniq\n```\n\n* split it into 12 parts\n```\nsplit -l N list\n```\n\n* use xargs to parallel rsync\n```sh\nfind . -name \"xa*\" -print0 | xargs -0 -I{} -n 1 -P12 rsync -avzr \\\n       --no-links --quiet --files-from={} alex@host:/ /tank/music/\n```\n\nThis gets me on average 25MB/s as opposed to 2MB/s on single threaded rsync.\n","slug":"rsync-parallel","published":1,"updated":"2020-06-25T05:51:12.631Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9w000j4ol3rb57kz0w","content":"<p>Note: This post is outdated. I don’t saturate my link at home because of\nbandwidth delay product[0]. I knew this at the point of writing the post, but I\ncould never get my calculated theoritical speed (even considering bdp). It was\nmost probably because I did not consider the number of hops between me and the\nserver when doing the calculations.</p>\n<p>I removed the extra steps to parallelize rsync like so\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh root@bifrost.wg find -L /var/media/dir \\</span><br><span class=\"line\">      -<span class=\"built_in\">type</span> f -<span class=\"built_in\">printf</span> <span class=\"string\">'%P\\\\0'</span> | \\</span><br><span class=\"line\">      parallel -0 --no-run-if-empty rsync -avrRsz --progress \\</span><br><span class=\"line\">      root@bifrost.wg:<span class=\"string\">\"/var/media/dir/&#123;&#125;\"</span> /tank/tv/dir</span><br></pre></td></tr></table></figure></p>\n<p>[0] <a href=\"https://en.wikipedia.org/wiki/Bandwidth-delay_product\" target=\"_blank\" rel=\"noopener\">https://en.wikipedia.org/wiki/Bandwidth-delay_product</a></p>\n<p>Original post:</p>\n<p>Not sure if its because of my ISP packet shaping or otherwise, but single\nconnections never saturate my 1gbps link at home. I needed to move a lot of\nmusic files off a server back to a new storage pool so:</p>\n<ul>\n<li><p>first make a list of files</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find /zroot/DATA/music/ -<span class=\"built_in\">type</span> f -name <span class=\"string\">\"*.flac\"</span> \\</span><br><span class=\"line\">       -<span class=\"built_in\">exec</span> dirname <span class=\"string\">\"&#123;&#125;\"</span> \\; | uniq</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>split it into 12 parts</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">split -l N list</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>use xargs to parallel rsync</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find . -name <span class=\"string\">\"xa*\"</span> -print0 | xargs -0 -I&#123;&#125; -n 1 -P12 rsync -avzr \\</span><br><span class=\"line\">       --no-links --quiet --files-from=&#123;&#125; alex@host:/ /tank/music/</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>This gets me on average 25MB/s as opposed to 2MB/s on single threaded rsync.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Note: This post is outdated. I don’t saturate my link at home because of\nbandwidth delay product[0]. I knew this at the point of writing the post, but I\ncould never get my calculated theoritical speed (even considering bdp). It was\nmost probably because I did not consider the number of hops between me and the\nserver when doing the calculations.</p>\n<p>I removed the extra steps to parallelize rsync like so\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh root@bifrost.wg find -L /var/media/dir \\</span><br><span class=\"line\">      -<span class=\"built_in\">type</span> f -<span class=\"built_in\">printf</span> <span class=\"string\">'%P\\\\0'</span> | \\</span><br><span class=\"line\">      parallel -0 --no-run-if-empty rsync -avrRsz --progress \\</span><br><span class=\"line\">      root@bifrost.wg:<span class=\"string\">\"/var/media/dir/&#123;&#125;\"</span> /tank/tv/dir</span><br></pre></td></tr></table></figure></p>\n<p>[0] <a href=\"https://en.wikipedia.org/wiki/Bandwidth-delay_product\" target=\"_blank\" rel=\"noopener\">https://en.wikipedia.org/wiki/Bandwidth-delay_product</a></p>\n<p>Original post:</p>\n<p>Not sure if its because of my ISP packet shaping or otherwise, but single\nconnections never saturate my 1gbps link at home. I needed to move a lot of\nmusic files off a server back to a new storage pool so:</p>\n<ul>\n<li><p>first make a list of files</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find /zroot/DATA/music/ -<span class=\"built_in\">type</span> f -name <span class=\"string\">\"*.flac\"</span> \\</span><br><span class=\"line\">       -<span class=\"built_in\">exec</span> dirname <span class=\"string\">\"&#123;&#125;\"</span> \\; | uniq</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>split it into 12 parts</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">split -l N list</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>use xargs to parallel rsync</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find . -name <span class=\"string\">\"xa*\"</span> -print0 | xargs -0 -I&#123;&#125; -n 1 -P12 rsync -avzr \\</span><br><span class=\"line\">       --no-links --quiet --files-from=&#123;&#125; alex@host:/ /tank/music/</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>This gets me on average 25MB/s as opposed to 2MB/s on single threaded rsync.</p>\n"},{"title":"rtorrent + flood - Moving completed files out to a different directory","date":"2019-12-28T08:24:10.000Z","_content":"\nZFS is known to have performance overheads caused by the 16KB read/write of\nrandom blocks by bittorrent[0]. One way of avoiding this fragmentation is by\nmoving files from a dataset that is made specifically for staging to another\nthat can hold the files better for sequential I/O (for example, downloading them\noff the server).\n\nThe Arch wiki has a section on this[1] that works for vanilla rtorrent, I\nassume. I manage rtorrent by using flood[2], an excellent web based UI. It does\nnot use the watch directories AFAIK so this part\n\n```\nschedule2 = watch_directory_1,10,10,\"load.start=/home/user/torrents/watch/*.torrent,d.custom1.set=/home/user/torrents/complete\"\n```\n\nis not useful anymore. Instead we can just define the path directly\n\n```\nmethod.insert = d.move_to_complete, simple, \"d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,-u,$argument.0=,$argument.1=; d.save_full_session=\"\nmethod.set_key = event.download.finished,move_complete,\"d.move_to_complete=$d.data_path=,/your/path/here/\"\n```\n\nIf you are running rtorrent in a container (as I am, an alpine container\nparticularly) then `mv -u` may not work if you're using the binary provided by\nbusybox instead of the one from coreutils that you're familiar with. Change it\nup\n\n```\nmethod.insert = d.move_to_complete, simple, \"d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,$argument.0=,$argument.1=; d.save_full_session=\"\nmethod.set_key = event.download.finished,move_complete,\"d.move_to_complete=$d.data_path=,/your/path/here/\"\n```\n\n\n[0] http://open-zfs.org/wiki/Performance_tuning#Bit_Torrent\n\n[1] https://wiki.archlinux.org/index.php/RTorrent#Manage_completed_files\n\n[2] https://github.com/Flood-UI/flood\n","source":"_posts/rtorrent-move-on-completion-flood.md","raw":"---\ntitle: rtorrent + flood - Moving completed files out to a different directory\ndate: 2019-12-28 16:24:10\ntags:\n  - rtorrent\n  - flood\n  - bittorrent\n  - zfs\n---\n\nZFS is known to have performance overheads caused by the 16KB read/write of\nrandom blocks by bittorrent[0]. One way of avoiding this fragmentation is by\nmoving files from a dataset that is made specifically for staging to another\nthat can hold the files better for sequential I/O (for example, downloading them\noff the server).\n\nThe Arch wiki has a section on this[1] that works for vanilla rtorrent, I\nassume. I manage rtorrent by using flood[2], an excellent web based UI. It does\nnot use the watch directories AFAIK so this part\n\n```\nschedule2 = watch_directory_1,10,10,\"load.start=/home/user/torrents/watch/*.torrent,d.custom1.set=/home/user/torrents/complete\"\n```\n\nis not useful anymore. Instead we can just define the path directly\n\n```\nmethod.insert = d.move_to_complete, simple, \"d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,-u,$argument.0=,$argument.1=; d.save_full_session=\"\nmethod.set_key = event.download.finished,move_complete,\"d.move_to_complete=$d.data_path=,/your/path/here/\"\n```\n\nIf you are running rtorrent in a container (as I am, an alpine container\nparticularly) then `mv -u` may not work if you're using the binary provided by\nbusybox instead of the one from coreutils that you're familiar with. Change it\nup\n\n```\nmethod.insert = d.move_to_complete, simple, \"d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,$argument.0=,$argument.1=; d.save_full_session=\"\nmethod.set_key = event.download.finished,move_complete,\"d.move_to_complete=$d.data_path=,/your/path/here/\"\n```\n\n\n[0] http://open-zfs.org/wiki/Performance_tuning#Bit_Torrent\n\n[1] https://wiki.archlinux.org/index.php/RTorrent#Manage_completed_files\n\n[2] https://github.com/Flood-UI/flood\n","slug":"rtorrent-move-on-completion-flood","published":1,"updated":"2019-12-28T08:29:45.807Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9x000l4ol3ga898cfe","content":"<p>ZFS is known to have performance overheads caused by the 16KB read/write of\nrandom blocks by bittorrent[0]. One way of avoiding this fragmentation is by\nmoving files from a dataset that is made specifically for staging to another\nthat can hold the files better for sequential I/O (for example, downloading them\noff the server).</p>\n<p>The Arch wiki has a section on this[1] that works for vanilla rtorrent, I\nassume. I manage rtorrent by using flood[2], an excellent web based UI. It does\nnot use the watch directories AFAIK so this part</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schedule2 = watch_directory_1,10,10,&quot;load.start=/home/user/torrents/watch/*.torrent,d.custom1.set=/home/user/torrents/complete&quot;</span><br></pre></td></tr></table></figure>\n<p>is not useful anymore. Instead we can just define the path directly</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">method.insert = d.move_to_complete, simple, &quot;d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,-u,$argument.0=,$argument.1=; d.save_full_session=&quot;</span><br><span class=\"line\">method.set_key = event.download.finished,move_complete,&quot;d.move_to_complete=$d.data_path=,/your/path/here/&quot;</span><br></pre></td></tr></table></figure>\n<p>If you are running rtorrent in a container (as I am, an alpine container\nparticularly) then <code>mv -u</code> may not work if you’re using the binary provided by\nbusybox instead of the one from coreutils that you’re familiar with. Change it\nup</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">method.insert = d.move_to_complete, simple, &quot;d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,$argument.0=,$argument.1=; d.save_full_session=&quot;</span><br><span class=\"line\">method.set_key = event.download.finished,move_complete,&quot;d.move_to_complete=$d.data_path=,/your/path/here/&quot;</span><br></pre></td></tr></table></figure>\n<p>[0] <a href=\"http://open-zfs.org/wiki/Performance_tuning#Bit_Torrent\" target=\"_blank\" rel=\"noopener\">http://open-zfs.org/wiki/Performance_tuning#Bit_Torrent</a></p>\n<p>[1] <a href=\"https://wiki.archlinux.org/index.php/RTorrent#Manage_completed_files\" target=\"_blank\" rel=\"noopener\">https://wiki.archlinux.org/index.php/RTorrent#Manage_completed_files</a></p>\n<p>[2] <a href=\"https://github.com/Flood-UI/flood\" target=\"_blank\" rel=\"noopener\">https://github.com/Flood-UI/flood</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>ZFS is known to have performance overheads caused by the 16KB read/write of\nrandom blocks by bittorrent[0]. One way of avoiding this fragmentation is by\nmoving files from a dataset that is made specifically for staging to another\nthat can hold the files better for sequential I/O (for example, downloading them\noff the server).</p>\n<p>The Arch wiki has a section on this[1] that works for vanilla rtorrent, I\nassume. I manage rtorrent by using flood[2], an excellent web based UI. It does\nnot use the watch directories AFAIK so this part</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schedule2 = watch_directory_1,10,10,&quot;load.start=/home/user/torrents/watch/*.torrent,d.custom1.set=/home/user/torrents/complete&quot;</span><br></pre></td></tr></table></figure>\n<p>is not useful anymore. Instead we can just define the path directly</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">method.insert = d.move_to_complete, simple, &quot;d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,-u,$argument.0=,$argument.1=; d.save_full_session=&quot;</span><br><span class=\"line\">method.set_key = event.download.finished,move_complete,&quot;d.move_to_complete=$d.data_path=,/your/path/here/&quot;</span><br></pre></td></tr></table></figure>\n<p>If you are running rtorrent in a container (as I am, an alpine container\nparticularly) then <code>mv -u</code> may not work if you’re using the binary provided by\nbusybox instead of the one from coreutils that you’re familiar with. Change it\nup</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">method.insert = d.move_to_complete, simple, &quot;d.directory.set=$argument.1=; execute=mkdir,-p,$argument.1=; execute=mv,$argument.0=,$argument.1=; d.save_full_session=&quot;</span><br><span class=\"line\">method.set_key = event.download.finished,move_complete,&quot;d.move_to_complete=$d.data_path=,/your/path/here/&quot;</span><br></pre></td></tr></table></figure>\n<p>[0] <a href=\"http://open-zfs.org/wiki/Performance_tuning#Bit_Torrent\" target=\"_blank\" rel=\"noopener\">http://open-zfs.org/wiki/Performance_tuning#Bit_Torrent</a></p>\n<p>[1] <a href=\"https://wiki.archlinux.org/index.php/RTorrent#Manage_completed_files\" target=\"_blank\" rel=\"noopener\">https://wiki.archlinux.org/index.php/RTorrent#Manage_completed_files</a></p>\n<p>[2] <a href=\"https://github.com/Flood-UI/flood\" target=\"_blank\" rel=\"noopener\">https://github.com/Flood-UI/flood</a></p>\n"},{"title":"Rustcon Asia 2019 - Beijing","date":"2019-04-25T08:01:13.000Z","_content":"\nI recently attended [Rustcon Asia 2019](https://rustcon.asia) in Beijing, China\nand these are my thoughts on the experience from the point of view of a\n\n* newbie to Rust\n* non Chinese speaker\n\nthe latter of which is not really important.\n\n## TL;DR/Summary\n\nThe conference was a great opportunity to learn more about Rust in the\nworkplaces and the kind of workloads it was being put through. Custom derives\nand higher order concepts that I am not familiar with were broken in (just on\nthe top).\n\nMajority of the talks were in Chinese but it was very follow-able for a non\nChinese speaker because of the live translation. The live translation does of\ncourse lose a lot of the tone and humor, but it got the job done. When the\nspeakers were using slides in Chinese, it was *very very* hard to follow along\neven with the translation. At the very least, I'd like to have received an\nEnglish copy of the slides that I can refer to.\n\nI appreciated the helpful and kind nature of everyone at the conference. It felt\nwelcoming. A small improvement that I'd like to suggest for future organizers is\nto start maybe an hour later (10 AM local time) and to provide\ncoffee at the venue!\n\n## Rust\n\nI'm new to Rust but I come from a C++ and Python and (naively) Haskell\nbackground which makes the language sufficiently interesting to follow. It\ncombines some of the best features that I like, is a statically typed, compiled\nlanguage that *I* can grok in my head. I am highlighting it because there are\neasier to grok languages that I can't get my head around because it's different\nfrom the *way I think*.\n\nI also come from a Robotics background doing underwater and surface robotics,\nwhich is an area in which C++ is king. Rust can (and should) be the default\nchoice for the safety it provides (critical when working around people and\nexpensive installations such as oil and gas pipelines) and performance.\n\nArmed with my curiosity and interest to learn more applications and ideas from\nfellow Rust developers, I left for Beijing.\n\n## Conference\n\nThe conference had talks for two days which began at 8 AM (first talk being at\n9 AM) which is kinda *really* early. Nick Cameron's talk on making rust\nergonomic gave an insight to what the core team thinks and was a great starter\ntalk. Some of the other talks that I found interesting were\n\n### Implementing a secp256k1 library in pure Rust\n\nWhich gave an introduction to elliptic curves: in math, and then in Rust. Math\nbeing an universal language gives the audience a way to relate quickly to what's\nhappening in the Rust code even if you're not familiar with the higher level\nconcepts in the language.\n\n### How Rust taught me to think about systems\n\nEntertaining - made you think back to when you were struggling with the borrow\nchecker (not that I'm not right now but to a lesser degree) and the language in\ngeneral. For the new-er folks, the speakers adventures give a solid start on how\nto reference library files, check for types and trace lifetimes.\n\n### Improving web app with Rust and WASM\n\nAn introduction to plugging in Rust compiled down to WASM for web developers and\na case study in which it was immediately useful to a client. The speaker used\nwasm to program a real time renderer for dentists to showcase teeth\nmodifications based on parameters provided from the JS layer.\n\nThe talk could have been improved a bit by providing absolute reference times\nwhen comparing performance across JS and WASM and by providing a debugging\nmethodology.\n\n### Cargo meets Autotools\n\nI'm interested in build systems and package managers and I'm opinionated about\nthem. I use portage as a daily driver and I'm familiar with CMake and autotools.\nHaving autotools is a godsend for deployments that don't need cargo installed\n(not distributed by default by distributions amongst other issues) and so is\nCMake. There are folks who are about to distribute libraries with deb and rpm.\n\nSome specifics about LTO, and differences mentioned in the talk between the\nfinal product with autotools vs CMake was not very clear to me though.\n\n### Distributed Actor System in Rust\n\nA very well done talk with a real world use case that I'm tackling as well. A\ndistributed actor system that's not Akka and is build in-house by Alibaba for\ntheir use case. Preserving types when sending messages and ensuring consistency\nwhen compiling and rolling out were some of the topics that was talked\nabout. The speaker was eloquent (even to a non Chinese speaker) and the talk was\nunderstandable even to a newbie. Awesome!\n\n### Be Fearless Using Rust in Production\n\nA talk about using Rust to replace an in house image stitcher from NodeJS. The\nslides gave a clear idea of the kind of workload that was implemented and it's\nsomething that I myself will first prototype in ImageMagick and then dump on C++\n(OpenCV3). Using Rust seemed to have paid off, with impressive QPS being handled\nby the same set of servers.\n\nThe talk also spoke about how difficult it was to get the company to approve\nusing Rust (at all) but they came around after an engineer used his own time to\nprototype the solution.\n\nAddition stuff that I'd have liked from the talk\n\n* Rust bindings for OpenCV\n* Benchmarks with an implementation in C++\n\n### Misc\n\nI wasn't too impressed with the talk about _how to learn rust efficiently_\nbecause it was more about learning than it was about learning Rust. I suppose\njust a mismatch on expectations and style of learning.\n\n## Workshops\n\nI did not attend the workshops because I had to get an expensive visa to enter\nChina. The time was better spent exploring the wonderful city of Beijing and\nits delicious food.\n","source":"_posts/rustcon-beijing.md","raw":"---\ntitle: Rustcon Asia 2019 - Beijing\ndate: 2019-04-25 16:01:13\ntags:\n - rust\n - conference\n---\n\nI recently attended [Rustcon Asia 2019](https://rustcon.asia) in Beijing, China\nand these are my thoughts on the experience from the point of view of a\n\n* newbie to Rust\n* non Chinese speaker\n\nthe latter of which is not really important.\n\n## TL;DR/Summary\n\nThe conference was a great opportunity to learn more about Rust in the\nworkplaces and the kind of workloads it was being put through. Custom derives\nand higher order concepts that I am not familiar with were broken in (just on\nthe top).\n\nMajority of the talks were in Chinese but it was very follow-able for a non\nChinese speaker because of the live translation. The live translation does of\ncourse lose a lot of the tone and humor, but it got the job done. When the\nspeakers were using slides in Chinese, it was *very very* hard to follow along\neven with the translation. At the very least, I'd like to have received an\nEnglish copy of the slides that I can refer to.\n\nI appreciated the helpful and kind nature of everyone at the conference. It felt\nwelcoming. A small improvement that I'd like to suggest for future organizers is\nto start maybe an hour later (10 AM local time) and to provide\ncoffee at the venue!\n\n## Rust\n\nI'm new to Rust but I come from a C++ and Python and (naively) Haskell\nbackground which makes the language sufficiently interesting to follow. It\ncombines some of the best features that I like, is a statically typed, compiled\nlanguage that *I* can grok in my head. I am highlighting it because there are\neasier to grok languages that I can't get my head around because it's different\nfrom the *way I think*.\n\nI also come from a Robotics background doing underwater and surface robotics,\nwhich is an area in which C++ is king. Rust can (and should) be the default\nchoice for the safety it provides (critical when working around people and\nexpensive installations such as oil and gas pipelines) and performance.\n\nArmed with my curiosity and interest to learn more applications and ideas from\nfellow Rust developers, I left for Beijing.\n\n## Conference\n\nThe conference had talks for two days which began at 8 AM (first talk being at\n9 AM) which is kinda *really* early. Nick Cameron's talk on making rust\nergonomic gave an insight to what the core team thinks and was a great starter\ntalk. Some of the other talks that I found interesting were\n\n### Implementing a secp256k1 library in pure Rust\n\nWhich gave an introduction to elliptic curves: in math, and then in Rust. Math\nbeing an universal language gives the audience a way to relate quickly to what's\nhappening in the Rust code even if you're not familiar with the higher level\nconcepts in the language.\n\n### How Rust taught me to think about systems\n\nEntertaining - made you think back to when you were struggling with the borrow\nchecker (not that I'm not right now but to a lesser degree) and the language in\ngeneral. For the new-er folks, the speakers adventures give a solid start on how\nto reference library files, check for types and trace lifetimes.\n\n### Improving web app with Rust and WASM\n\nAn introduction to plugging in Rust compiled down to WASM for web developers and\na case study in which it was immediately useful to a client. The speaker used\nwasm to program a real time renderer for dentists to showcase teeth\nmodifications based on parameters provided from the JS layer.\n\nThe talk could have been improved a bit by providing absolute reference times\nwhen comparing performance across JS and WASM and by providing a debugging\nmethodology.\n\n### Cargo meets Autotools\n\nI'm interested in build systems and package managers and I'm opinionated about\nthem. I use portage as a daily driver and I'm familiar with CMake and autotools.\nHaving autotools is a godsend for deployments that don't need cargo installed\n(not distributed by default by distributions amongst other issues) and so is\nCMake. There are folks who are about to distribute libraries with deb and rpm.\n\nSome specifics about LTO, and differences mentioned in the talk between the\nfinal product with autotools vs CMake was not very clear to me though.\n\n### Distributed Actor System in Rust\n\nA very well done talk with a real world use case that I'm tackling as well. A\ndistributed actor system that's not Akka and is build in-house by Alibaba for\ntheir use case. Preserving types when sending messages and ensuring consistency\nwhen compiling and rolling out were some of the topics that was talked\nabout. The speaker was eloquent (even to a non Chinese speaker) and the talk was\nunderstandable even to a newbie. Awesome!\n\n### Be Fearless Using Rust in Production\n\nA talk about using Rust to replace an in house image stitcher from NodeJS. The\nslides gave a clear idea of the kind of workload that was implemented and it's\nsomething that I myself will first prototype in ImageMagick and then dump on C++\n(OpenCV3). Using Rust seemed to have paid off, with impressive QPS being handled\nby the same set of servers.\n\nThe talk also spoke about how difficult it was to get the company to approve\nusing Rust (at all) but they came around after an engineer used his own time to\nprototype the solution.\n\nAddition stuff that I'd have liked from the talk\n\n* Rust bindings for OpenCV\n* Benchmarks with an implementation in C++\n\n### Misc\n\nI wasn't too impressed with the talk about _how to learn rust efficiently_\nbecause it was more about learning than it was about learning Rust. I suppose\njust a mismatch on expectations and style of learning.\n\n## Workshops\n\nI did not attend the workshops because I had to get an expensive visa to enter\nChina. The time was better spent exploring the wonderful city of Beijing and\nits delicious food.\n","slug":"rustcon-beijing","published":1,"updated":"2019-12-28T07:55:42.187Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9y000o4ol3x7yg9rvo","content":"<p>I recently attended <a href=\"https://rustcon.asia\" target=\"_blank\" rel=\"noopener\">Rustcon Asia 2019</a> in Beijing, China\nand these are my thoughts on the experience from the point of view of a</p>\n<ul>\n<li>newbie to Rust</li>\n<li>non Chinese speaker</li>\n</ul>\n<p>the latter of which is not really important.</p>\n<h2 id=\"TL-DR-Summary\"><a href=\"#TL-DR-Summary\" class=\"headerlink\" title=\"TL;DR/Summary\"></a>TL;DR/Summary</h2><p>The conference was a great opportunity to learn more about Rust in the\nworkplaces and the kind of workloads it was being put through. Custom derives\nand higher order concepts that I am not familiar with were broken in (just on\nthe top).</p>\n<p>Majority of the talks were in Chinese but it was very follow-able for a non\nChinese speaker because of the live translation. The live translation does of\ncourse lose a lot of the tone and humor, but it got the job done. When the\nspeakers were using slides in Chinese, it was <em>very very</em> hard to follow along\neven with the translation. At the very least, I’d like to have received an\nEnglish copy of the slides that I can refer to.</p>\n<p>I appreciated the helpful and kind nature of everyone at the conference. It felt\nwelcoming. A small improvement that I’d like to suggest for future organizers is\nto start maybe an hour later (10 AM local time) and to provide\ncoffee at the venue!</p>\n<h2 id=\"Rust\"><a href=\"#Rust\" class=\"headerlink\" title=\"Rust\"></a>Rust</h2><p>I’m new to Rust but I come from a C++ and Python and (naively) Haskell\nbackground which makes the language sufficiently interesting to follow. It\ncombines some of the best features that I like, is a statically typed, compiled\nlanguage that <em>I</em> can grok in my head. I am highlighting it because there are\neasier to grok languages that I can’t get my head around because it’s different\nfrom the <em>way I think</em>.</p>\n<p>I also come from a Robotics background doing underwater and surface robotics,\nwhich is an area in which C++ is king. Rust can (and should) be the default\nchoice for the safety it provides (critical when working around people and\nexpensive installations such as oil and gas pipelines) and performance.</p>\n<p>Armed with my curiosity and interest to learn more applications and ideas from\nfellow Rust developers, I left for Beijing.</p>\n<h2 id=\"Conference\"><a href=\"#Conference\" class=\"headerlink\" title=\"Conference\"></a>Conference</h2><p>The conference had talks for two days which began at 8 AM (first talk being at\n9 AM) which is kinda <em>really</em> early. Nick Cameron’s talk on making rust\nergonomic gave an insight to what the core team thinks and was a great starter\ntalk. Some of the other talks that I found interesting were</p>\n<h3 id=\"Implementing-a-secp256k1-library-in-pure-Rust\"><a href=\"#Implementing-a-secp256k1-library-in-pure-Rust\" class=\"headerlink\" title=\"Implementing a secp256k1 library in pure Rust\"></a>Implementing a secp256k1 library in pure Rust</h3><p>Which gave an introduction to elliptic curves: in math, and then in Rust. Math\nbeing an universal language gives the audience a way to relate quickly to what’s\nhappening in the Rust code even if you’re not familiar with the higher level\nconcepts in the language.</p>\n<h3 id=\"How-Rust-taught-me-to-think-about-systems\"><a href=\"#How-Rust-taught-me-to-think-about-systems\" class=\"headerlink\" title=\"How Rust taught me to think about systems\"></a>How Rust taught me to think about systems</h3><p>Entertaining - made you think back to when you were struggling with the borrow\nchecker (not that I’m not right now but to a lesser degree) and the language in\ngeneral. For the new-er folks, the speakers adventures give a solid start on how\nto reference library files, check for types and trace lifetimes.</p>\n<h3 id=\"Improving-web-app-with-Rust-and-WASM\"><a href=\"#Improving-web-app-with-Rust-and-WASM\" class=\"headerlink\" title=\"Improving web app with Rust and WASM\"></a>Improving web app with Rust and WASM</h3><p>An introduction to plugging in Rust compiled down to WASM for web developers and\na case study in which it was immediately useful to a client. The speaker used\nwasm to program a real time renderer for dentists to showcase teeth\nmodifications based on parameters provided from the JS layer.</p>\n<p>The talk could have been improved a bit by providing absolute reference times\nwhen comparing performance across JS and WASM and by providing a debugging\nmethodology.</p>\n<h3 id=\"Cargo-meets-Autotools\"><a href=\"#Cargo-meets-Autotools\" class=\"headerlink\" title=\"Cargo meets Autotools\"></a>Cargo meets Autotools</h3><p>I’m interested in build systems and package managers and I’m opinionated about\nthem. I use portage as a daily driver and I’m familiar with CMake and autotools.\nHaving autotools is a godsend for deployments that don’t need cargo installed\n(not distributed by default by distributions amongst other issues) and so is\nCMake. There are folks who are about to distribute libraries with deb and rpm.</p>\n<p>Some specifics about LTO, and differences mentioned in the talk between the\nfinal product with autotools vs CMake was not very clear to me though.</p>\n<h3 id=\"Distributed-Actor-System-in-Rust\"><a href=\"#Distributed-Actor-System-in-Rust\" class=\"headerlink\" title=\"Distributed Actor System in Rust\"></a>Distributed Actor System in Rust</h3><p>A very well done talk with a real world use case that I’m tackling as well. A\ndistributed actor system that’s not Akka and is build in-house by Alibaba for\ntheir use case. Preserving types when sending messages and ensuring consistency\nwhen compiling and rolling out were some of the topics that was talked\nabout. The speaker was eloquent (even to a non Chinese speaker) and the talk was\nunderstandable even to a newbie. Awesome!</p>\n<h3 id=\"Be-Fearless-Using-Rust-in-Production\"><a href=\"#Be-Fearless-Using-Rust-in-Production\" class=\"headerlink\" title=\"Be Fearless Using Rust in Production\"></a>Be Fearless Using Rust in Production</h3><p>A talk about using Rust to replace an in house image stitcher from NodeJS. The\nslides gave a clear idea of the kind of workload that was implemented and it’s\nsomething that I myself will first prototype in ImageMagick and then dump on C++\n(OpenCV3). Using Rust seemed to have paid off, with impressive QPS being handled\nby the same set of servers.</p>\n<p>The talk also spoke about how difficult it was to get the company to approve\nusing Rust (at all) but they came around after an engineer used his own time to\nprototype the solution.</p>\n<p>Addition stuff that I’d have liked from the talk</p>\n<ul>\n<li>Rust bindings for OpenCV</li>\n<li>Benchmarks with an implementation in C++</li>\n</ul>\n<h3 id=\"Misc\"><a href=\"#Misc\" class=\"headerlink\" title=\"Misc\"></a>Misc</h3><p>I wasn’t too impressed with the talk about <em>how to learn rust efficiently</em>\nbecause it was more about learning than it was about learning Rust. I suppose\njust a mismatch on expectations and style of learning.</p>\n<h2 id=\"Workshops\"><a href=\"#Workshops\" class=\"headerlink\" title=\"Workshops\"></a>Workshops</h2><p>I did not attend the workshops because I had to get an expensive visa to enter\nChina. The time was better spent exploring the wonderful city of Beijing and\nits delicious food.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I recently attended <a href=\"https://rustcon.asia\" target=\"_blank\" rel=\"noopener\">Rustcon Asia 2019</a> in Beijing, China\nand these are my thoughts on the experience from the point of view of a</p>\n<ul>\n<li>newbie to Rust</li>\n<li>non Chinese speaker</li>\n</ul>\n<p>the latter of which is not really important.</p>\n<h2 id=\"TL-DR-Summary\"><a href=\"#TL-DR-Summary\" class=\"headerlink\" title=\"TL;DR/Summary\"></a>TL;DR/Summary</h2><p>The conference was a great opportunity to learn more about Rust in the\nworkplaces and the kind of workloads it was being put through. Custom derives\nand higher order concepts that I am not familiar with were broken in (just on\nthe top).</p>\n<p>Majority of the talks were in Chinese but it was very follow-able for a non\nChinese speaker because of the live translation. The live translation does of\ncourse lose a lot of the tone and humor, but it got the job done. When the\nspeakers were using slides in Chinese, it was <em>very very</em> hard to follow along\neven with the translation. At the very least, I’d like to have received an\nEnglish copy of the slides that I can refer to.</p>\n<p>I appreciated the helpful and kind nature of everyone at the conference. It felt\nwelcoming. A small improvement that I’d like to suggest for future organizers is\nto start maybe an hour later (10 AM local time) and to provide\ncoffee at the venue!</p>\n<h2 id=\"Rust\"><a href=\"#Rust\" class=\"headerlink\" title=\"Rust\"></a>Rust</h2><p>I’m new to Rust but I come from a C++ and Python and (naively) Haskell\nbackground which makes the language sufficiently interesting to follow. It\ncombines some of the best features that I like, is a statically typed, compiled\nlanguage that <em>I</em> can grok in my head. I am highlighting it because there are\neasier to grok languages that I can’t get my head around because it’s different\nfrom the <em>way I think</em>.</p>\n<p>I also come from a Robotics background doing underwater and surface robotics,\nwhich is an area in which C++ is king. Rust can (and should) be the default\nchoice for the safety it provides (critical when working around people and\nexpensive installations such as oil and gas pipelines) and performance.</p>\n<p>Armed with my curiosity and interest to learn more applications and ideas from\nfellow Rust developers, I left for Beijing.</p>\n<h2 id=\"Conference\"><a href=\"#Conference\" class=\"headerlink\" title=\"Conference\"></a>Conference</h2><p>The conference had talks for two days which began at 8 AM (first talk being at\n9 AM) which is kinda <em>really</em> early. Nick Cameron’s talk on making rust\nergonomic gave an insight to what the core team thinks and was a great starter\ntalk. Some of the other talks that I found interesting were</p>\n<h3 id=\"Implementing-a-secp256k1-library-in-pure-Rust\"><a href=\"#Implementing-a-secp256k1-library-in-pure-Rust\" class=\"headerlink\" title=\"Implementing a secp256k1 library in pure Rust\"></a>Implementing a secp256k1 library in pure Rust</h3><p>Which gave an introduction to elliptic curves: in math, and then in Rust. Math\nbeing an universal language gives the audience a way to relate quickly to what’s\nhappening in the Rust code even if you’re not familiar with the higher level\nconcepts in the language.</p>\n<h3 id=\"How-Rust-taught-me-to-think-about-systems\"><a href=\"#How-Rust-taught-me-to-think-about-systems\" class=\"headerlink\" title=\"How Rust taught me to think about systems\"></a>How Rust taught me to think about systems</h3><p>Entertaining - made you think back to when you were struggling with the borrow\nchecker (not that I’m not right now but to a lesser degree) and the language in\ngeneral. For the new-er folks, the speakers adventures give a solid start on how\nto reference library files, check for types and trace lifetimes.</p>\n<h3 id=\"Improving-web-app-with-Rust-and-WASM\"><a href=\"#Improving-web-app-with-Rust-and-WASM\" class=\"headerlink\" title=\"Improving web app with Rust and WASM\"></a>Improving web app with Rust and WASM</h3><p>An introduction to plugging in Rust compiled down to WASM for web developers and\na case study in which it was immediately useful to a client. The speaker used\nwasm to program a real time renderer for dentists to showcase teeth\nmodifications based on parameters provided from the JS layer.</p>\n<p>The talk could have been improved a bit by providing absolute reference times\nwhen comparing performance across JS and WASM and by providing a debugging\nmethodology.</p>\n<h3 id=\"Cargo-meets-Autotools\"><a href=\"#Cargo-meets-Autotools\" class=\"headerlink\" title=\"Cargo meets Autotools\"></a>Cargo meets Autotools</h3><p>I’m interested in build systems and package managers and I’m opinionated about\nthem. I use portage as a daily driver and I’m familiar with CMake and autotools.\nHaving autotools is a godsend for deployments that don’t need cargo installed\n(not distributed by default by distributions amongst other issues) and so is\nCMake. There are folks who are about to distribute libraries with deb and rpm.</p>\n<p>Some specifics about LTO, and differences mentioned in the talk between the\nfinal product with autotools vs CMake was not very clear to me though.</p>\n<h3 id=\"Distributed-Actor-System-in-Rust\"><a href=\"#Distributed-Actor-System-in-Rust\" class=\"headerlink\" title=\"Distributed Actor System in Rust\"></a>Distributed Actor System in Rust</h3><p>A very well done talk with a real world use case that I’m tackling as well. A\ndistributed actor system that’s not Akka and is build in-house by Alibaba for\ntheir use case. Preserving types when sending messages and ensuring consistency\nwhen compiling and rolling out were some of the topics that was talked\nabout. The speaker was eloquent (even to a non Chinese speaker) and the talk was\nunderstandable even to a newbie. Awesome!</p>\n<h3 id=\"Be-Fearless-Using-Rust-in-Production\"><a href=\"#Be-Fearless-Using-Rust-in-Production\" class=\"headerlink\" title=\"Be Fearless Using Rust in Production\"></a>Be Fearless Using Rust in Production</h3><p>A talk about using Rust to replace an in house image stitcher from NodeJS. The\nslides gave a clear idea of the kind of workload that was implemented and it’s\nsomething that I myself will first prototype in ImageMagick and then dump on C++\n(OpenCV3). Using Rust seemed to have paid off, with impressive QPS being handled\nby the same set of servers.</p>\n<p>The talk also spoke about how difficult it was to get the company to approve\nusing Rust (at all) but they came around after an engineer used his own time to\nprototype the solution.</p>\n<p>Addition stuff that I’d have liked from the talk</p>\n<ul>\n<li>Rust bindings for OpenCV</li>\n<li>Benchmarks with an implementation in C++</li>\n</ul>\n<h3 id=\"Misc\"><a href=\"#Misc\" class=\"headerlink\" title=\"Misc\"></a>Misc</h3><p>I wasn’t too impressed with the talk about <em>how to learn rust efficiently</em>\nbecause it was more about learning than it was about learning Rust. I suppose\njust a mismatch on expectations and style of learning.</p>\n<h2 id=\"Workshops\"><a href=\"#Workshops\" class=\"headerlink\" title=\"Workshops\"></a>Workshops</h2><p>I did not attend the workshops because I had to get an expensive visa to enter\nChina. The time was better spent exploring the wonderful city of Beijing and\nits delicious food.</p>\n"},{"title":"Bootstrap sane defaults for sshd and ipfw","date":"2017-03-09T09:34:54.000Z","author":"alex","_content":"\nI often find myself spawning random DigitalOcean FreeBSD\ndroplets for prototyping web services. Just because they are temporary does not\nmean that they should not have secure defaults however. Here's a short script\nthat sets up `sshd` as well as initializes the `ipfw` firewall.\n\nFor AWS instances we're better off using VPC with sane security groups to do our\nfirewalling for us.\n\nIt can be run using\n\n```sh\nssh user@host 'sh -s' < script\n```\n\nIt disables password authentication and allows only public key based\nauthentication, disables root login, limits retries. As for ipfw, it only allows\ntcp in on port 22 by default. \n\n```sh\n#!/bin/sh\n\nhead -1 ~/.ssh/authorized_keys | ssh-keygen -l -f - > /dev/null 2>&1\n\nif [ $? != 0 ];\nthen\n  echo \"invalid public key found in authorized_keys, exiting..\"\n  exit\nfi\n\ncp /etc/ssh/sshd_config ~/sshd_config.bak\n\nsudo tee /etc/ssh/sshd_config <<EOF\nPort 22\nSyslogFacility AUTH\nLogLevel INFO\nLoginGraceTime 2m\nStrictModes yes\nMaxAuthTries 6\nMaxSessions 10\nRSAAuthentication yes\nPubkeyAuthentication yes\nAuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2\nPasswordAuthentication no\nPermitEmptyPasswords no\nSubsystem       sftp    /usr/libexec/sftp-server\nPermitRootLogin no\nEOF\n\nsudo tee -a /etc/rc.conf <<EOF\nfirewall_enable=\"YES\"\nfirewall_quiet=\"YES\"\nfirewall_type=\"workstation\"\nfirewall_myservices=\"22/tcp\"\nfirewall_allowservices=\"any\"\nfirewall_logdeny=\"YES\"\nEOF\n\nsudo service sshd restart\nsudo service ipfw start\n```\n\nA maintained version of this script can be found on\n[gist](https://gist.github.com/spaghetti-/40896fb8f6cdc56851f894291d149ae5).\n\nThe blog syntax highlighter seems to remove newlines from the source.\n","source":"_posts/sane-sshd-ipfw-defaults.md","raw":"---\ntitle: Bootstrap sane defaults for sshd and ipfw\ndate: 2017-03-09 17:34:54\ntags: freebsd\nauthor: alex\n---\n\nI often find myself spawning random DigitalOcean FreeBSD\ndroplets for prototyping web services. Just because they are temporary does not\nmean that they should not have secure defaults however. Here's a short script\nthat sets up `sshd` as well as initializes the `ipfw` firewall.\n\nFor AWS instances we're better off using VPC with sane security groups to do our\nfirewalling for us.\n\nIt can be run using\n\n```sh\nssh user@host 'sh -s' < script\n```\n\nIt disables password authentication and allows only public key based\nauthentication, disables root login, limits retries. As for ipfw, it only allows\ntcp in on port 22 by default. \n\n```sh\n#!/bin/sh\n\nhead -1 ~/.ssh/authorized_keys | ssh-keygen -l -f - > /dev/null 2>&1\n\nif [ $? != 0 ];\nthen\n  echo \"invalid public key found in authorized_keys, exiting..\"\n  exit\nfi\n\ncp /etc/ssh/sshd_config ~/sshd_config.bak\n\nsudo tee /etc/ssh/sshd_config <<EOF\nPort 22\nSyslogFacility AUTH\nLogLevel INFO\nLoginGraceTime 2m\nStrictModes yes\nMaxAuthTries 6\nMaxSessions 10\nRSAAuthentication yes\nPubkeyAuthentication yes\nAuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2\nPasswordAuthentication no\nPermitEmptyPasswords no\nSubsystem       sftp    /usr/libexec/sftp-server\nPermitRootLogin no\nEOF\n\nsudo tee -a /etc/rc.conf <<EOF\nfirewall_enable=\"YES\"\nfirewall_quiet=\"YES\"\nfirewall_type=\"workstation\"\nfirewall_myservices=\"22/tcp\"\nfirewall_allowservices=\"any\"\nfirewall_logdeny=\"YES\"\nEOF\n\nsudo service sshd restart\nsudo service ipfw start\n```\n\nA maintained version of this script can be found on\n[gist](https://gist.github.com/spaghetti-/40896fb8f6cdc56851f894291d149ae5).\n\nThe blog syntax highlighter seems to remove newlines from the source.\n","slug":"sane-sshd-ipfw-defaults","published":1,"updated":"2019-12-28T07:55:42.188Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0x9z000p4ol30b6j0xt6","content":"<p>I often find myself spawning random DigitalOcean FreeBSD\ndroplets for prototyping web services. Just because they are temporary does not\nmean that they should not have secure defaults however. Here’s a short script\nthat sets up <code>sshd</code> as well as initializes the <code>ipfw</code> firewall.</p>\n<p>For AWS instances we’re better off using VPC with sane security groups to do our\nfirewalling for us.</p>\n<p>It can be run using</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh user@host <span class=\"string\">'sh -s'</span> &lt; script</span><br></pre></td></tr></table></figure>\n<p>It disables password authentication and allows only public key based\nauthentication, disables root login, limits retries. As for ipfw, it only allows\ntcp in on port 22 by default. </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\">head -1 ~/.ssh/authorized_keys | ssh-keygen -l -f - &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? != 0 ];</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"invalid public key found in authorized_keys, exiting..\"</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">cp /etc/ssh/sshd_config ~/sshd_config.bak</span><br><span class=\"line\"></span><br><span class=\"line\">sudo tee /etc/ssh/sshd_config &lt;&lt;EOF</span><br><span class=\"line\">Port 22</span><br><span class=\"line\">SyslogFacility AUTH</span><br><span class=\"line\">LogLevel INFO</span><br><span class=\"line\">LoginGraceTime 2m</span><br><span class=\"line\">StrictModes yes</span><br><span class=\"line\">MaxAuthTries 6</span><br><span class=\"line\">MaxSessions 10</span><br><span class=\"line\">RSAAuthentication yes</span><br><span class=\"line\">PubkeyAuthentication yes</span><br><span class=\"line\">AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2</span><br><span class=\"line\">PasswordAuthentication no</span><br><span class=\"line\">PermitEmptyPasswords no</span><br><span class=\"line\">Subsystem       sftp    /usr/libexec/sftp-server</span><br><span class=\"line\">PermitRootLogin no</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sudo tee -a /etc/rc.conf &lt;&lt;EOF</span><br><span class=\"line\">firewall_enable=<span class=\"string\">\"YES\"</span></span><br><span class=\"line\">firewall_quiet=<span class=\"string\">\"YES\"</span></span><br><span class=\"line\">firewall_type=<span class=\"string\">\"workstation\"</span></span><br><span class=\"line\">firewall_myservices=<span class=\"string\">\"22/tcp\"</span></span><br><span class=\"line\">firewall_allowservices=<span class=\"string\">\"any\"</span></span><br><span class=\"line\">firewall_logdeny=<span class=\"string\">\"YES\"</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sudo service sshd restart</span><br><span class=\"line\">sudo service ipfw start</span><br></pre></td></tr></table></figure>\n<p>A maintained version of this script can be found on\n<a href=\"https://gist.github.com/spaghetti-/40896fb8f6cdc56851f894291d149ae5\" target=\"_blank\" rel=\"noopener\">gist</a>.</p>\n<p>The blog syntax highlighter seems to remove newlines from the source.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I often find myself spawning random DigitalOcean FreeBSD\ndroplets for prototyping web services. Just because they are temporary does not\nmean that they should not have secure defaults however. Here’s a short script\nthat sets up <code>sshd</code> as well as initializes the <code>ipfw</code> firewall.</p>\n<p>For AWS instances we’re better off using VPC with sane security groups to do our\nfirewalling for us.</p>\n<p>It can be run using</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh user@host <span class=\"string\">'sh -s'</span> &lt; script</span><br></pre></td></tr></table></figure>\n<p>It disables password authentication and allows only public key based\nauthentication, disables root login, limits retries. As for ipfw, it only allows\ntcp in on port 22 by default. </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\">head -1 ~/.ssh/authorized_keys | ssh-keygen -l -f - &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? != 0 ];</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"invalid public key found in authorized_keys, exiting..\"</span></span><br><span class=\"line\">  <span class=\"built_in\">exit</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">cp /etc/ssh/sshd_config ~/sshd_config.bak</span><br><span class=\"line\"></span><br><span class=\"line\">sudo tee /etc/ssh/sshd_config &lt;&lt;EOF</span><br><span class=\"line\">Port 22</span><br><span class=\"line\">SyslogFacility AUTH</span><br><span class=\"line\">LogLevel INFO</span><br><span class=\"line\">LoginGraceTime 2m</span><br><span class=\"line\">StrictModes yes</span><br><span class=\"line\">MaxAuthTries 6</span><br><span class=\"line\">MaxSessions 10</span><br><span class=\"line\">RSAAuthentication yes</span><br><span class=\"line\">PubkeyAuthentication yes</span><br><span class=\"line\">AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2</span><br><span class=\"line\">PasswordAuthentication no</span><br><span class=\"line\">PermitEmptyPasswords no</span><br><span class=\"line\">Subsystem       sftp    /usr/libexec/sftp-server</span><br><span class=\"line\">PermitRootLogin no</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sudo tee -a /etc/rc.conf &lt;&lt;EOF</span><br><span class=\"line\">firewall_enable=<span class=\"string\">\"YES\"</span></span><br><span class=\"line\">firewall_quiet=<span class=\"string\">\"YES\"</span></span><br><span class=\"line\">firewall_type=<span class=\"string\">\"workstation\"</span></span><br><span class=\"line\">firewall_myservices=<span class=\"string\">\"22/tcp\"</span></span><br><span class=\"line\">firewall_allowservices=<span class=\"string\">\"any\"</span></span><br><span class=\"line\">firewall_logdeny=<span class=\"string\">\"YES\"</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sudo service sshd restart</span><br><span class=\"line\">sudo service ipfw start</span><br></pre></td></tr></table></figure>\n<p>A maintained version of this script can be found on\n<a href=\"https://gist.github.com/spaghetti-/40896fb8f6cdc56851f894291d149ae5\" target=\"_blank\" rel=\"noopener\">gist</a>.</p>\n<p>The blog syntax highlighter seems to remove newlines from the source.</p>\n"},{"title":"Running Windows with PCI passthrough enabled on Gentoo Linux","date":"2018-07-27T04:23:18.000Z","_content":"\n# Why?\n\n* I have a 1080 GTX that I use to power my 2 1440p screens, render high\ndefinition video, re-encoding and also to play Dota 2 on Linux.\n* I also foresee the card running CUDA specific stuff just out of personal\ninterest.\n* I _hate_ rebooting machines (the box is also a ZFS datastore that is accessible\nover the network, music server, etc.).\n* I want to play certain games on Windows (GTA V, Dying Light, etc.)\n\n# Hardware\n\nThe requirements for pci passthrough can be found all over the internet,\nparticularly in the Arch wiki, but in short: If you've an Intel processor it\nwill need to support VT-d and IOMMU. Most modern processors support that. The\nQEMU wiki states that most K processors don't - but the 8700k does support it.\n\nThe motherboard needs to support it as well (and again, most modern boards do)\n  but some manufacturers are known to disable it to shave cost. Google around.\n\nThe MSI z370-A PRO board supports it. Couldn't find it in a database somewhere\nbut it does (tested).\n\nI don't want to have two separate KB and mouse because that beats the point of\nwhat I'm trying to achieve. I want a Linux host that can run games at times and\nsorta 'alt-tab' into each other. However, if you care about achieving bare\nmetal latencies - you'd need to get a PCI USB hub that can be passed through.\n\nThe z370-A PRO motherboard comes with only 1 xHCI USB hub.\n\nThe rest of this post is tailored to hardware I own so\n\n| Components                            |\n| ------------------------------------- |\n| Intel i7 8700k                        |\n| MSI z370-A PRO                        |\n| G.Skill Ripjaws V 16GB @ 3000MHz CL15 |\n| Corsair 128GB SATA3 SSD               |\n| Generic HID Keyboard                  |\n| Generic HID Mouse                     |\n\nThe SSD is from another computer that no longer exists and was scavenged.\n\nIt is important that there's two GPUs available on the system. The i7 8700k\ncomes with its integrated graphics and that works fine.\n\n# BIOS Setup\n\nEnable VT-d in Overclocking (smh) -> CPU features. I have no idea why it's not\nenabled by default on this motherboard.\n\nSet the boot GPU to the Intel i915 by navigating to Advanced -> Integrated\nGraphics Configuration -> Set to IGD.\n\nWhen I boot from the 1080 GTX everything still works, but I can swap X between\nnvidia and intel gpus exactly _two_ times. Any more and it'll stall the CPU and\nI have to REISUB the machine. Details can be found in the email I sent to the\nvfio-users mailing list [here](https://www.redhat.com/archives/vfio-users/2018-July/msg00005.html).\n\n# Kernel setup\n\nI'm on gentoo-sources 4.17.9 at the time of writing. You need to keyword it so\nyou'd need\n\n```\nsys-kernel/gentoo-sources ~amd64\n```\n\nEnable the following for IOMMU\n\n```\nCONFIG_IOMMU_SUPPORT\nCONFIG_INTEL_IOMMU\nCONFIG_INTEL_IOMMU_SVM\nCONFIG_IRQ_REMAP\nCONFIG_VFIO\nCONFIG_VFIO_PCI\nCONFIG_VFIO_PCI_VGA\n```\n\nI'll also upload my kernel configuration so that it's easier to reference.\n\n\nThen add to `/etc/default/grub` and reboot\n\n```\nGRUB_CMDLINE_LINUX=\"iommu=on intel_iommu=on\"\n```\n\nCheck if the options work by checking the log\n\n```\nalex@trixie ~ $ dmesg | grep -e IOMMU -e DMAR\n[    0.000000] ACPI: DMAR 0x000000007C5A8880 0000A8 (v01 INTEL  EDK2     00000001 INTL 00000001)\n[    0.000000] DMAR: IOMMU enabled\n```\n\nAlso enable the relevant Kernel flags for the Intel GPU and NVIDA GPU (see the\ngentoo handbook for this).\n\nThe i965 (newer i915 name in mesa) seems to flicker on my screen and cause\nartifacts at times. The Arch wiki recommends adding `i915.enable_psr=0` to get\naround that. You can find more details about that here.\n\n# Display setup\n\nI changed my display setup slightly to remove DP chaining. The final setup is\nlike so\n\n```\n\n                                +--------------+    +--------------+\n                                |  2560x1440   |    | 2560x1440    |\n                                |  MST on      |    | MST off      |\n                                |  DP1.2       |    |              |\n                                |              |    |              |\n                                +-----+--------+    +----+---------+\n                             mDP in|  |      DP out      |  DP in\n                                   |  |                  |\n                                   |  |                  |\n                                   |  |                  |\n+------------+DP out               |  |                  |\n|  Intel     +---------------------+  |                  |\n|  Onboard   |                        |                  |\n|            |                        |                  |\n+------------+                        |                  |\n                                      |                  |\n+------------+        DP              |                  |\n|            +------------------------+                  |\n| GTX 1080   |                                           |\n|            +-------------------------------------------+\n+------------+\n```\n\nI removed the DP chaining because if you're (and you should be) using the nvidia\nproprietary drivers on Linux, there's a bug preventing DDC control from working\nover DP.\n\nDDC control enables us to switch the inputs of the monitors from mDP <-> DP from\nsoftware (i2c write). It works fine with the intel GPU which works out well for\nus since that's the display that'll be running X when we're in passthrough.\n\nThere's a nice little utility called `ddccontrol` that enables us to use this.\n\n```\n=app-misc/ddccontrol-db-20061014_p20121105 ~amd64\n=app-misc/ddccontrol-0.4.2_p20140105-r2 ~amd64\n\nemerge -a ddccontrol\n```\n\n# IOMMU Groups\n\nAnd IOMMU group is the smallest set of devices the VM can grab at a time.\n\nYou can check your IOMMU groups by running this little command that I got from\nmany sources (Archwiki, /vg/s installgentoo page)\n\n```sh\nfor iommu_group in \\\n      $(find /sys/kernel/iommu_groups/ -maxdepth 1 -mindepth 1 -type d); do \\\n  echo \"IOMMU group $(basename \"$iommu_group\")\"; \\\n  for device in $(ls -1 \"$iommu_group\"/devices/); do \\\n    echo -n $'\\t'; lspci -nns \"$device\"; \\\n  done; \\\ndone\n```\n\nMine are\n\n```\nIOMMU group 7\n        00:1c.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #1 [8086:a290] (rev f0)\nIOMMU group 5\n        00:16.0 Communication controller [0780]: Intel Corporation 200 Series PCH CSME HECI #1 [8086:a2ba]\nIOMMU group 3\n        00:08.0 System peripheral [0880]: Intel Corporation Xeon E3-1200 v5/v6 / E3-1500 v5 / 6th/7th Gen Core Processor Gaussian Mixture Model [8086:1911]\nIOMMU group 11\n        03:00.0 Ethernet controller [0200]: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller [10ec:8168] (rev 15)\nIOMMU group 1\n        00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v5/E3-1500 v5/6th Gen Core Processor PCIe Controller (x16) [8086:1901] (rev 07)\n        01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP104 [GeForce GTX 1080] [10de:1b80] (rev a1)\n        01:00.1 Audio device [0403]: NVIDIA Corporation GP104 High Definition Audio Controller [10de:10f0] (rev a1)\nIOMMU group 8\n        00:1c.3 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #4 [8086:a293] (rev f0)\nIOMMU group 6\n        00:17.0 SATA controller [0106]: Intel Corporation 200 Series PCH SATA controller [AHCI mode] [8086:a282]\nIOMMU group 4\n        00:14.0 USB controller [0c03]: Intel Corporation 200 Series PCH USB 3.0 xHCI Controller [8086:a2af]\n        00:14.2 Signal processing controller [1180]: Intel Corporation 200 Series PCH Thermal Subsystem [8086:a2b1]\nIOMMU group 12\n        04:00.0 Non-Volatile memory controller [0108]: Samsung Electronics Co Ltd Device [144d:a808]\nIOMMU group 2\n        00:02.0 VGA compatible controller [0300]: Intel Corporation Device [8086:3e92]\nIOMMU group 10\n        00:1f.0 ISA bridge [0601]: Intel Corporation Device [8086:a2c9]\n        00:1f.2 Memory controller [0580]: Intel Corporation 200 Series PCH PMC [8086:a2a1]\n        00:1f.3 Audio device [0403]: Intel Corporation 200 Series PCH HD Audio [8086:a2f0]\n        00:1f.4 SMBus [0c05]: Intel Corporation 200 Series PCH SMBus Controller [8086:a2a3]\nIOMMU group 0\n        00:00.0 Host bridge [0600]: Intel Corporation Device [8086:3ec2] (rev 07)\nIOMMU group 9\n        00:1d.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #9 [8086:a298] (rev f0)\n```\n\nMy IOMMU group 1 is perfect, which is basically just my nvidia GPU and its HD\naudio device. The PCI bridge can be ignored but it needs to be removed from the\npcieport driver before we can bind the gpu to the vm.\n\nThough if you have things like your network card inside the same group then\ngrabbing it is going to be more difficult. You can try an ACS patch which may be\nable to break down your IOMMU groups further. I don't need it with this setup.\nYet.\n\n\n# X server stuff\n\nLike I mentioned before the host graphics is equally important and I do more\nwork on the host. I use a generic `xorg.conf` that is generated by\n`nvidia-xconfig` to configure my graphics initially.\n\nI leave that file untouched in `/etc/X11`.\n\nI have a seperate Xorg configuration that I use for the Intel i915\n\n```\nSection \"Device\"\n        Identifier  \"intel\"\n        Driver      \"modesetting\"\n        BusID       \"PCI:0:2:0\"\nEndSection\n```\n\nThis filed is named `intel.xorg.conf` and dumped in the same directory.\n\nUpdate:\n\nI no longer patch `xinit`. I started using a login manager: SLiM, which also\nstarts a consolekit session (makes things easier). I keep the default config as\n`/etc/slim.conf.orig` and symlink either that or `/etc/slim.conf.intel` which\nhas the server argument `-config xorg.conf.intel` to `/etc/slim.conf`.\n\n# Relevant scripts\n\nHere's how I start and stop my VM and bind to different environments. This is\nnot perfect (neither is anything in this post) and criticism is welcome. Pull\nrequests too.\n\nI don't use virt-manager or libvirt because\n\n* I don't want another layer of abstraction\n* XML makes life difficult and there are still parameters that can't be passed\nin via the configuration file\n* XML\n* Did I mention XML?\n\nMy scripts are `sh` compatible and do not require any special shell.\n\nThis part prepares the drivers and binding to vfio-pci as required. I don't\nthink that the rebinding of vtconsole is required.\n\n```sh\n#!/bin/sh\n\n# PCIe device ids\nGPU=0000:01:00.0\nGPU_SND=0000:01:00.1\nPCI_BRIDGE=0000:00:01.0\n\n# this script is intended to be run as root\n# @TODO put in a check against whoami or $USER\n\nfunction perror() {\n  echo \"$@\" 1>&2;\n}\n\nfunction bus_rescan() {\n  perror \"[*] rescaning pci bus\"\n  echo 1 > /sys/bus/pci/rescan\n  sleep 1\n}\n\n# usage\n# vfio-bind $GPU vfio-bind\nfunction driver_bind() {\n  DEV=\"$1\"\n  DRV=\"$2\"\n  VENDOR=$(< /sys/bus/pci/devices/$DEV/vendor)\n  DEVICE=$(< /sys/bus/pci/devices/$DEV/device)\n  if [ -e /sys/bus/pci/devices/$DEV/driver ]; then\n    perror \"[*] unbinding $DEV\"\n    echo $DEV > /sys/bus/pci/devices/$DEV/driver/unbind\n    sleep 1\n  else\n    perror \"[!] existing driver for $DEV not found\"\n  fi\n  perror \"[*] binding $DEV to $DRV\"\n  echo $VENDOR $DEVICE > /sys/bus/pci/drivers/$DRV/new_id\n}\n\nfunction remove_pci_bridge() {\n  perror \"[*] removing pci bridge\"\n  echo 1 > /sys/bus/pci/devices/$PCI_BRIDGE/remove\n  bus_rescan\n}\n\nfunction unbind_fb_vtconsole() {\n  perror \"[*] removing efifb and vtconsole binding\"\n  perror \"[!!] you WILL lose console\"\n  echo \"efi-framebuffer.0\" > /sys/bus/platform/drivers/efi-framebuffer/unbind\n  sleep .5\n  echo 0 > /sys/class/vtconsole/vtcon0/bind\n  echo 0 > /sys/class/vtconsole/vtcon1/bind\n}\n\nfunction rebind_fb_vtconsole() {\n  echo \"efi-framebuffer.0\" > /sys/bus/platform/drivers/efi-framebuffer/bind\n  sleep .5\n  echo 1 > /sys/class/vtconsole/vtcon0/bind\n  echo 1 > /sys/class/vtconsole/vtcon1/bind\n}\n```\n\nAnd then for the X server\n\n```sh\nkillall X\nsleep 5\n\n#unbind_fb_vtconsole\n\ndriver_bind $GPU vfio-pci\ndriver_bind $GPU_SND vfio-pci\nremove_pci_bridge\n\nperror \"[*] switching monitor 1 to mDP\"\nddccontrol -r 0x60 -w 16 dev:/dev/i2c-3\n\ntouch /tmp/vm.lock\nsu alex -c startx\n\nrebind_fb_vtconsole\n```\n\nAnd for when I'm done with the VM:\n\n```sh\nkillall X\nsleep 5\n\ndriver_bind $GPU nvidia\ndriver_bind $GPU_SND snd_hda_intel\nbus_rescan\n\nrm /tmp/vm.lock\nddccontrol -r 0x60 -w 15 dev:/dev/i2c-3\n#rebind_fb_vtconsole\nsu alex -c startx\n```\n\n# QEMU parameters\n\nI'm using Qemu 3.1.0 at the time of updating this article.\n\n\n```\nexport QEMU_AUDIO_DRV=pa\nqemu-system-x86_64 -enable-kvm -m 8G \\\n  -machine pc-q35-3.0,accel=kvm \\\n  -cpu host,kvm=off,hv_relaxed,hv_spinlocks=0x1fff,hv_time,hv_vapic,hv_vendor_id=0xDEADBEEFFF \\\n  -rtc clock=host,base=localtime \\\n  -smp 4,sockets=1,cores=2,threads=2 \\\n  -vga none \\\n  -soundhw ac97 \\\n  -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \\\n  -device vfio-pci,host=01:00.1 \\\n  -drive if=pflash,format=raw,file=/usr/share/edk2-ovmf/OVMF_CODE.fd \\\n  -device ide-cd,bus=ide.1,drive=virtiocd1 \\\n  -drive media=cdrom,file=/tank/vm/win10.iso,id=virtiocd1,if=none \\\n  -object input-linux,id=kbd,evdev=/dev/input/by-id/usb-04d9_USB-HID_Keyboard-event-kbd,grab_all=on,repeat=on \\\n  -object input-linux,id=mouse,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-event-mouse \\\n  -object input-linux,id=kbd2,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-if01-event-kbd,grab_all=on,repeat=on \\\n  -device virtio-scsi-pci,id=scsi0 \\\n  -device scsi-hd,bus=scsi0.0,drive=rootfs \\\n  -drive id=rootfs,file=/tank/vm/photog.qcow2,id=disk,format=qcow2,if=none \\\n```\n","source":"_posts/running-windows-with-pci-passthrough-on-gentoo-linux.md","raw":"---\ntitle: Running Windows with PCI passthrough enabled on Gentoo Linux\ndate: 2018-07-27 12:23:18\ntags:\n - linux\n - gentoo\n - nvidia\n - pci-passthrough\n - qemu\n---\n\n# Why?\n\n* I have a 1080 GTX that I use to power my 2 1440p screens, render high\ndefinition video, re-encoding and also to play Dota 2 on Linux.\n* I also foresee the card running CUDA specific stuff just out of personal\ninterest.\n* I _hate_ rebooting machines (the box is also a ZFS datastore that is accessible\nover the network, music server, etc.).\n* I want to play certain games on Windows (GTA V, Dying Light, etc.)\n\n# Hardware\n\nThe requirements for pci passthrough can be found all over the internet,\nparticularly in the Arch wiki, but in short: If you've an Intel processor it\nwill need to support VT-d and IOMMU. Most modern processors support that. The\nQEMU wiki states that most K processors don't - but the 8700k does support it.\n\nThe motherboard needs to support it as well (and again, most modern boards do)\n  but some manufacturers are known to disable it to shave cost. Google around.\n\nThe MSI z370-A PRO board supports it. Couldn't find it in a database somewhere\nbut it does (tested).\n\nI don't want to have two separate KB and mouse because that beats the point of\nwhat I'm trying to achieve. I want a Linux host that can run games at times and\nsorta 'alt-tab' into each other. However, if you care about achieving bare\nmetal latencies - you'd need to get a PCI USB hub that can be passed through.\n\nThe z370-A PRO motherboard comes with only 1 xHCI USB hub.\n\nThe rest of this post is tailored to hardware I own so\n\n| Components                            |\n| ------------------------------------- |\n| Intel i7 8700k                        |\n| MSI z370-A PRO                        |\n| G.Skill Ripjaws V 16GB @ 3000MHz CL15 |\n| Corsair 128GB SATA3 SSD               |\n| Generic HID Keyboard                  |\n| Generic HID Mouse                     |\n\nThe SSD is from another computer that no longer exists and was scavenged.\n\nIt is important that there's two GPUs available on the system. The i7 8700k\ncomes with its integrated graphics and that works fine.\n\n# BIOS Setup\n\nEnable VT-d in Overclocking (smh) -> CPU features. I have no idea why it's not\nenabled by default on this motherboard.\n\nSet the boot GPU to the Intel i915 by navigating to Advanced -> Integrated\nGraphics Configuration -> Set to IGD.\n\nWhen I boot from the 1080 GTX everything still works, but I can swap X between\nnvidia and intel gpus exactly _two_ times. Any more and it'll stall the CPU and\nI have to REISUB the machine. Details can be found in the email I sent to the\nvfio-users mailing list [here](https://www.redhat.com/archives/vfio-users/2018-July/msg00005.html).\n\n# Kernel setup\n\nI'm on gentoo-sources 4.17.9 at the time of writing. You need to keyword it so\nyou'd need\n\n```\nsys-kernel/gentoo-sources ~amd64\n```\n\nEnable the following for IOMMU\n\n```\nCONFIG_IOMMU_SUPPORT\nCONFIG_INTEL_IOMMU\nCONFIG_INTEL_IOMMU_SVM\nCONFIG_IRQ_REMAP\nCONFIG_VFIO\nCONFIG_VFIO_PCI\nCONFIG_VFIO_PCI_VGA\n```\n\nI'll also upload my kernel configuration so that it's easier to reference.\n\n\nThen add to `/etc/default/grub` and reboot\n\n```\nGRUB_CMDLINE_LINUX=\"iommu=on intel_iommu=on\"\n```\n\nCheck if the options work by checking the log\n\n```\nalex@trixie ~ $ dmesg | grep -e IOMMU -e DMAR\n[    0.000000] ACPI: DMAR 0x000000007C5A8880 0000A8 (v01 INTEL  EDK2     00000001 INTL 00000001)\n[    0.000000] DMAR: IOMMU enabled\n```\n\nAlso enable the relevant Kernel flags for the Intel GPU and NVIDA GPU (see the\ngentoo handbook for this).\n\nThe i965 (newer i915 name in mesa) seems to flicker on my screen and cause\nartifacts at times. The Arch wiki recommends adding `i915.enable_psr=0` to get\naround that. You can find more details about that here.\n\n# Display setup\n\nI changed my display setup slightly to remove DP chaining. The final setup is\nlike so\n\n```\n\n                                +--------------+    +--------------+\n                                |  2560x1440   |    | 2560x1440    |\n                                |  MST on      |    | MST off      |\n                                |  DP1.2       |    |              |\n                                |              |    |              |\n                                +-----+--------+    +----+---------+\n                             mDP in|  |      DP out      |  DP in\n                                   |  |                  |\n                                   |  |                  |\n                                   |  |                  |\n+------------+DP out               |  |                  |\n|  Intel     +---------------------+  |                  |\n|  Onboard   |                        |                  |\n|            |                        |                  |\n+------------+                        |                  |\n                                      |                  |\n+------------+        DP              |                  |\n|            +------------------------+                  |\n| GTX 1080   |                                           |\n|            +-------------------------------------------+\n+------------+\n```\n\nI removed the DP chaining because if you're (and you should be) using the nvidia\nproprietary drivers on Linux, there's a bug preventing DDC control from working\nover DP.\n\nDDC control enables us to switch the inputs of the monitors from mDP <-> DP from\nsoftware (i2c write). It works fine with the intel GPU which works out well for\nus since that's the display that'll be running X when we're in passthrough.\n\nThere's a nice little utility called `ddccontrol` that enables us to use this.\n\n```\n=app-misc/ddccontrol-db-20061014_p20121105 ~amd64\n=app-misc/ddccontrol-0.4.2_p20140105-r2 ~amd64\n\nemerge -a ddccontrol\n```\n\n# IOMMU Groups\n\nAnd IOMMU group is the smallest set of devices the VM can grab at a time.\n\nYou can check your IOMMU groups by running this little command that I got from\nmany sources (Archwiki, /vg/s installgentoo page)\n\n```sh\nfor iommu_group in \\\n      $(find /sys/kernel/iommu_groups/ -maxdepth 1 -mindepth 1 -type d); do \\\n  echo \"IOMMU group $(basename \"$iommu_group\")\"; \\\n  for device in $(ls -1 \"$iommu_group\"/devices/); do \\\n    echo -n $'\\t'; lspci -nns \"$device\"; \\\n  done; \\\ndone\n```\n\nMine are\n\n```\nIOMMU group 7\n        00:1c.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #1 [8086:a290] (rev f0)\nIOMMU group 5\n        00:16.0 Communication controller [0780]: Intel Corporation 200 Series PCH CSME HECI #1 [8086:a2ba]\nIOMMU group 3\n        00:08.0 System peripheral [0880]: Intel Corporation Xeon E3-1200 v5/v6 / E3-1500 v5 / 6th/7th Gen Core Processor Gaussian Mixture Model [8086:1911]\nIOMMU group 11\n        03:00.0 Ethernet controller [0200]: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller [10ec:8168] (rev 15)\nIOMMU group 1\n        00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v5/E3-1500 v5/6th Gen Core Processor PCIe Controller (x16) [8086:1901] (rev 07)\n        01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP104 [GeForce GTX 1080] [10de:1b80] (rev a1)\n        01:00.1 Audio device [0403]: NVIDIA Corporation GP104 High Definition Audio Controller [10de:10f0] (rev a1)\nIOMMU group 8\n        00:1c.3 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #4 [8086:a293] (rev f0)\nIOMMU group 6\n        00:17.0 SATA controller [0106]: Intel Corporation 200 Series PCH SATA controller [AHCI mode] [8086:a282]\nIOMMU group 4\n        00:14.0 USB controller [0c03]: Intel Corporation 200 Series PCH USB 3.0 xHCI Controller [8086:a2af]\n        00:14.2 Signal processing controller [1180]: Intel Corporation 200 Series PCH Thermal Subsystem [8086:a2b1]\nIOMMU group 12\n        04:00.0 Non-Volatile memory controller [0108]: Samsung Electronics Co Ltd Device [144d:a808]\nIOMMU group 2\n        00:02.0 VGA compatible controller [0300]: Intel Corporation Device [8086:3e92]\nIOMMU group 10\n        00:1f.0 ISA bridge [0601]: Intel Corporation Device [8086:a2c9]\n        00:1f.2 Memory controller [0580]: Intel Corporation 200 Series PCH PMC [8086:a2a1]\n        00:1f.3 Audio device [0403]: Intel Corporation 200 Series PCH HD Audio [8086:a2f0]\n        00:1f.4 SMBus [0c05]: Intel Corporation 200 Series PCH SMBus Controller [8086:a2a3]\nIOMMU group 0\n        00:00.0 Host bridge [0600]: Intel Corporation Device [8086:3ec2] (rev 07)\nIOMMU group 9\n        00:1d.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #9 [8086:a298] (rev f0)\n```\n\nMy IOMMU group 1 is perfect, which is basically just my nvidia GPU and its HD\naudio device. The PCI bridge can be ignored but it needs to be removed from the\npcieport driver before we can bind the gpu to the vm.\n\nThough if you have things like your network card inside the same group then\ngrabbing it is going to be more difficult. You can try an ACS patch which may be\nable to break down your IOMMU groups further. I don't need it with this setup.\nYet.\n\n\n# X server stuff\n\nLike I mentioned before the host graphics is equally important and I do more\nwork on the host. I use a generic `xorg.conf` that is generated by\n`nvidia-xconfig` to configure my graphics initially.\n\nI leave that file untouched in `/etc/X11`.\n\nI have a seperate Xorg configuration that I use for the Intel i915\n\n```\nSection \"Device\"\n        Identifier  \"intel\"\n        Driver      \"modesetting\"\n        BusID       \"PCI:0:2:0\"\nEndSection\n```\n\nThis filed is named `intel.xorg.conf` and dumped in the same directory.\n\nUpdate:\n\nI no longer patch `xinit`. I started using a login manager: SLiM, which also\nstarts a consolekit session (makes things easier). I keep the default config as\n`/etc/slim.conf.orig` and symlink either that or `/etc/slim.conf.intel` which\nhas the server argument `-config xorg.conf.intel` to `/etc/slim.conf`.\n\n# Relevant scripts\n\nHere's how I start and stop my VM and bind to different environments. This is\nnot perfect (neither is anything in this post) and criticism is welcome. Pull\nrequests too.\n\nI don't use virt-manager or libvirt because\n\n* I don't want another layer of abstraction\n* XML makes life difficult and there are still parameters that can't be passed\nin via the configuration file\n* XML\n* Did I mention XML?\n\nMy scripts are `sh` compatible and do not require any special shell.\n\nThis part prepares the drivers and binding to vfio-pci as required. I don't\nthink that the rebinding of vtconsole is required.\n\n```sh\n#!/bin/sh\n\n# PCIe device ids\nGPU=0000:01:00.0\nGPU_SND=0000:01:00.1\nPCI_BRIDGE=0000:00:01.0\n\n# this script is intended to be run as root\n# @TODO put in a check against whoami or $USER\n\nfunction perror() {\n  echo \"$@\" 1>&2;\n}\n\nfunction bus_rescan() {\n  perror \"[*] rescaning pci bus\"\n  echo 1 > /sys/bus/pci/rescan\n  sleep 1\n}\n\n# usage\n# vfio-bind $GPU vfio-bind\nfunction driver_bind() {\n  DEV=\"$1\"\n  DRV=\"$2\"\n  VENDOR=$(< /sys/bus/pci/devices/$DEV/vendor)\n  DEVICE=$(< /sys/bus/pci/devices/$DEV/device)\n  if [ -e /sys/bus/pci/devices/$DEV/driver ]; then\n    perror \"[*] unbinding $DEV\"\n    echo $DEV > /sys/bus/pci/devices/$DEV/driver/unbind\n    sleep 1\n  else\n    perror \"[!] existing driver for $DEV not found\"\n  fi\n  perror \"[*] binding $DEV to $DRV\"\n  echo $VENDOR $DEVICE > /sys/bus/pci/drivers/$DRV/new_id\n}\n\nfunction remove_pci_bridge() {\n  perror \"[*] removing pci bridge\"\n  echo 1 > /sys/bus/pci/devices/$PCI_BRIDGE/remove\n  bus_rescan\n}\n\nfunction unbind_fb_vtconsole() {\n  perror \"[*] removing efifb and vtconsole binding\"\n  perror \"[!!] you WILL lose console\"\n  echo \"efi-framebuffer.0\" > /sys/bus/platform/drivers/efi-framebuffer/unbind\n  sleep .5\n  echo 0 > /sys/class/vtconsole/vtcon0/bind\n  echo 0 > /sys/class/vtconsole/vtcon1/bind\n}\n\nfunction rebind_fb_vtconsole() {\n  echo \"efi-framebuffer.0\" > /sys/bus/platform/drivers/efi-framebuffer/bind\n  sleep .5\n  echo 1 > /sys/class/vtconsole/vtcon0/bind\n  echo 1 > /sys/class/vtconsole/vtcon1/bind\n}\n```\n\nAnd then for the X server\n\n```sh\nkillall X\nsleep 5\n\n#unbind_fb_vtconsole\n\ndriver_bind $GPU vfio-pci\ndriver_bind $GPU_SND vfio-pci\nremove_pci_bridge\n\nperror \"[*] switching monitor 1 to mDP\"\nddccontrol -r 0x60 -w 16 dev:/dev/i2c-3\n\ntouch /tmp/vm.lock\nsu alex -c startx\n\nrebind_fb_vtconsole\n```\n\nAnd for when I'm done with the VM:\n\n```sh\nkillall X\nsleep 5\n\ndriver_bind $GPU nvidia\ndriver_bind $GPU_SND snd_hda_intel\nbus_rescan\n\nrm /tmp/vm.lock\nddccontrol -r 0x60 -w 15 dev:/dev/i2c-3\n#rebind_fb_vtconsole\nsu alex -c startx\n```\n\n# QEMU parameters\n\nI'm using Qemu 3.1.0 at the time of updating this article.\n\n\n```\nexport QEMU_AUDIO_DRV=pa\nqemu-system-x86_64 -enable-kvm -m 8G \\\n  -machine pc-q35-3.0,accel=kvm \\\n  -cpu host,kvm=off,hv_relaxed,hv_spinlocks=0x1fff,hv_time,hv_vapic,hv_vendor_id=0xDEADBEEFFF \\\n  -rtc clock=host,base=localtime \\\n  -smp 4,sockets=1,cores=2,threads=2 \\\n  -vga none \\\n  -soundhw ac97 \\\n  -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \\\n  -device vfio-pci,host=01:00.1 \\\n  -drive if=pflash,format=raw,file=/usr/share/edk2-ovmf/OVMF_CODE.fd \\\n  -device ide-cd,bus=ide.1,drive=virtiocd1 \\\n  -drive media=cdrom,file=/tank/vm/win10.iso,id=virtiocd1,if=none \\\n  -object input-linux,id=kbd,evdev=/dev/input/by-id/usb-04d9_USB-HID_Keyboard-event-kbd,grab_all=on,repeat=on \\\n  -object input-linux,id=mouse,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-event-mouse \\\n  -object input-linux,id=kbd2,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-if01-event-kbd,grab_all=on,repeat=on \\\n  -device virtio-scsi-pci,id=scsi0 \\\n  -device scsi-hd,bus=scsi0.0,drive=rootfs \\\n  -drive id=rootfs,file=/tank/vm/photog.qcow2,id=disk,format=qcow2,if=none \\\n```\n","slug":"running-windows-with-pci-passthrough-on-gentoo-linux","published":1,"updated":"2019-12-28T07:55:42.187Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0xa0000r4ol3adxu91ql","content":"<h1 id=\"Why\"><a href=\"#Why\" class=\"headerlink\" title=\"Why?\"></a>Why?</h1><ul>\n<li>I have a 1080 GTX that I use to power my 2 1440p screens, render high\ndefinition video, re-encoding and also to play Dota 2 on Linux.</li>\n<li>I also foresee the card running CUDA specific stuff just out of personal\ninterest.</li>\n<li>I <em>hate</em> rebooting machines (the box is also a ZFS datastore that is accessible\nover the network, music server, etc.).</li>\n<li>I want to play certain games on Windows (GTA V, Dying Light, etc.)</li>\n</ul>\n<h1 id=\"Hardware\"><a href=\"#Hardware\" class=\"headerlink\" title=\"Hardware\"></a>Hardware</h1><p>The requirements for pci passthrough can be found all over the internet,\nparticularly in the Arch wiki, but in short: If you’ve an Intel processor it\nwill need to support VT-d and IOMMU. Most modern processors support that. The\nQEMU wiki states that most K processors don’t - but the 8700k does support it.</p>\n<p>The motherboard needs to support it as well (and again, most modern boards do)\n  but some manufacturers are known to disable it to shave cost. Google around.</p>\n<p>The MSI z370-A PRO board supports it. Couldn’t find it in a database somewhere\nbut it does (tested).</p>\n<p>I don’t want to have two separate KB and mouse because that beats the point of\nwhat I’m trying to achieve. I want a Linux host that can run games at times and\nsorta ‘alt-tab’ into each other. However, if you care about achieving bare\nmetal latencies - you’d need to get a PCI USB hub that can be passed through.</p>\n<p>The z370-A PRO motherboard comes with only 1 xHCI USB hub.</p>\n<p>The rest of this post is tailored to hardware I own so</p>\n<table>\n<thead>\n<tr>\n<th>Components</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Intel i7 8700k</td>\n</tr>\n<tr>\n<td>MSI z370-A PRO</td>\n</tr>\n<tr>\n<td>G.Skill Ripjaws V 16GB @ 3000MHz CL15</td>\n</tr>\n<tr>\n<td>Corsair 128GB SATA3 SSD</td>\n</tr>\n<tr>\n<td>Generic HID Keyboard</td>\n</tr>\n<tr>\n<td>Generic HID Mouse</td>\n</tr>\n</tbody>\n</table>\n<p>The SSD is from another computer that no longer exists and was scavenged.</p>\n<p>It is important that there’s two GPUs available on the system. The i7 8700k\ncomes with its integrated graphics and that works fine.</p>\n<h1 id=\"BIOS-Setup\"><a href=\"#BIOS-Setup\" class=\"headerlink\" title=\"BIOS Setup\"></a>BIOS Setup</h1><p>Enable VT-d in Overclocking (smh) -&gt; CPU features. I have no idea why it’s not\nenabled by default on this motherboard.</p>\n<p>Set the boot GPU to the Intel i915 by navigating to Advanced -&gt; Integrated\nGraphics Configuration -&gt; Set to IGD.</p>\n<p>When I boot from the 1080 GTX everything still works, but I can swap X between\nnvidia and intel gpus exactly <em>two</em> times. Any more and it’ll stall the CPU and\nI have to REISUB the machine. Details can be found in the email I sent to the\nvfio-users mailing list <a href=\"https://www.redhat.com/archives/vfio-users/2018-July/msg00005.html\" target=\"_blank\" rel=\"noopener\">here</a>.</p>\n<h1 id=\"Kernel-setup\"><a href=\"#Kernel-setup\" class=\"headerlink\" title=\"Kernel setup\"></a>Kernel setup</h1><p>I’m on gentoo-sources 4.17.9 at the time of writing. You need to keyword it so\nyou’d need</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sys-kernel/gentoo-sources ~amd64</span><br></pre></td></tr></table></figure>\n<p>Enable the following for IOMMU</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CONFIG_IOMMU_SUPPORT</span><br><span class=\"line\">CONFIG_INTEL_IOMMU</span><br><span class=\"line\">CONFIG_INTEL_IOMMU_SVM</span><br><span class=\"line\">CONFIG_IRQ_REMAP</span><br><span class=\"line\">CONFIG_VFIO</span><br><span class=\"line\">CONFIG_VFIO_PCI</span><br><span class=\"line\">CONFIG_VFIO_PCI_VGA</span><br></pre></td></tr></table></figure>\n<p>I’ll also upload my kernel configuration so that it’s easier to reference.</p>\n<p>Then add to <code>/etc/default/grub</code> and reboot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GRUB_CMDLINE_LINUX=&quot;iommu=on intel_iommu=on&quot;</span><br></pre></td></tr></table></figure>\n<p>Check if the options work by checking the log</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alex@trixie ~ $ dmesg | grep -e IOMMU -e DMAR</span><br><span class=\"line\">[    0.000000] ACPI: DMAR 0x000000007C5A8880 0000A8 (v01 INTEL  EDK2     00000001 INTL 00000001)</span><br><span class=\"line\">[    0.000000] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>\n<p>Also enable the relevant Kernel flags for the Intel GPU and NVIDA GPU (see the\ngentoo handbook for this).</p>\n<p>The i965 (newer i915 name in mesa) seems to flicker on my screen and cause\nartifacts at times. The Arch wiki recommends adding <code>i915.enable_psr=0</code> to get\naround that. You can find more details about that here.</p>\n<h1 id=\"Display-setup\"><a href=\"#Display-setup\" class=\"headerlink\" title=\"Display setup\"></a>Display setup</h1><p>I changed my display setup slightly to remove DP chaining. The final setup is\nlike so</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">                                +--------------+    +--------------+</span><br><span class=\"line\">                                |  2560x1440   |    | 2560x1440    |</span><br><span class=\"line\">                                |  MST on      |    | MST off      |</span><br><span class=\"line\">                                |  DP1.2       |    |              |</span><br><span class=\"line\">                                |              |    |              |</span><br><span class=\"line\">                                +-----+--------+    +----+---------+</span><br><span class=\"line\">                             mDP in|  |      DP out      |  DP in</span><br><span class=\"line\">                                   |  |                  |</span><br><span class=\"line\">                                   |  |                  |</span><br><span class=\"line\">                                   |  |                  |</span><br><span class=\"line\">+------------+DP out               |  |                  |</span><br><span class=\"line\">|  Intel     +---------------------+  |                  |</span><br><span class=\"line\">|  Onboard   |                        |                  |</span><br><span class=\"line\">|            |                        |                  |</span><br><span class=\"line\">+------------+                        |                  |</span><br><span class=\"line\">                                      |                  |</span><br><span class=\"line\">+------------+        DP              |                  |</span><br><span class=\"line\">|            +------------------------+                  |</span><br><span class=\"line\">| GTX 1080   |                                           |</span><br><span class=\"line\">|            +-------------------------------------------+</span><br><span class=\"line\">+------------+</span><br></pre></td></tr></table></figure>\n<p>I removed the DP chaining because if you’re (and you should be) using the nvidia\nproprietary drivers on Linux, there’s a bug preventing DDC control from working\nover DP.</p>\n<p>DDC control enables us to switch the inputs of the monitors from mDP <-> DP from\nsoftware (i2c write). It works fine with the intel GPU which works out well for\nus since that’s the display that’ll be running X when we’re in passthrough.</-></p>\n<p>There’s a nice little utility called <code>ddccontrol</code> that enables us to use this.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">=app-misc/ddccontrol-db-20061014_p20121105 ~amd64</span><br><span class=\"line\">=app-misc/ddccontrol-0.4.2_p20140105-r2 ~amd64</span><br><span class=\"line\"></span><br><span class=\"line\">emerge -a ddccontrol</span><br></pre></td></tr></table></figure>\n<h1 id=\"IOMMU-Groups\"><a href=\"#IOMMU-Groups\" class=\"headerlink\" title=\"IOMMU Groups\"></a>IOMMU Groups</h1><p>And IOMMU group is the smallest set of devices the VM can grab at a time.</p>\n<p>You can check your IOMMU groups by running this little command that I got from\nmany sources (Archwiki, /vg/s installgentoo page)</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> iommu_group <span class=\"keyword\">in</span> \\</span><br><span class=\"line\">      $(find /sys/kernel/iommu_groups/ -maxdepth 1 -mindepth 1 -<span class=\"built_in\">type</span> d); <span class=\"keyword\">do</span> \\</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"IOMMU group <span class=\"variable\">$(basename \"$iommu_group\")</span>\"</span>; \\</span><br><span class=\"line\">  <span class=\"keyword\">for</span> device <span class=\"keyword\">in</span> $(ls -1 <span class=\"string\">\"<span class=\"variable\">$iommu_group</span>\"</span>/devices/); <span class=\"keyword\">do</span> \\</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> -n $<span class=\"string\">'\\t'</span>; lspci -nns <span class=\"string\">\"<span class=\"variable\">$device</span>\"</span>; \\</span><br><span class=\"line\">  <span class=\"keyword\">done</span>; \\</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<p>Mine are</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IOMMU group 7</span><br><span class=\"line\">        00:1c.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #1 [8086:a290] (rev f0)</span><br><span class=\"line\">IOMMU group 5</span><br><span class=\"line\">        00:16.0 Communication controller [0780]: Intel Corporation 200 Series PCH CSME HECI #1 [8086:a2ba]</span><br><span class=\"line\">IOMMU group 3</span><br><span class=\"line\">        00:08.0 System peripheral [0880]: Intel Corporation Xeon E3-1200 v5/v6 / E3-1500 v5 / 6th/7th Gen Core Processor Gaussian Mixture Model [8086:1911]</span><br><span class=\"line\">IOMMU group 11</span><br><span class=\"line\">        03:00.0 Ethernet controller [0200]: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller [10ec:8168] (rev 15)</span><br><span class=\"line\">IOMMU group 1</span><br><span class=\"line\">        00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v5/E3-1500 v5/6th Gen Core Processor PCIe Controller (x16) [8086:1901] (rev 07)</span><br><span class=\"line\">        01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP104 [GeForce GTX 1080] [10de:1b80] (rev a1)</span><br><span class=\"line\">        01:00.1 Audio device [0403]: NVIDIA Corporation GP104 High Definition Audio Controller [10de:10f0] (rev a1)</span><br><span class=\"line\">IOMMU group 8</span><br><span class=\"line\">        00:1c.3 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #4 [8086:a293] (rev f0)</span><br><span class=\"line\">IOMMU group 6</span><br><span class=\"line\">        00:17.0 SATA controller [0106]: Intel Corporation 200 Series PCH SATA controller [AHCI mode] [8086:a282]</span><br><span class=\"line\">IOMMU group 4</span><br><span class=\"line\">        00:14.0 USB controller [0c03]: Intel Corporation 200 Series PCH USB 3.0 xHCI Controller [8086:a2af]</span><br><span class=\"line\">        00:14.2 Signal processing controller [1180]: Intel Corporation 200 Series PCH Thermal Subsystem [8086:a2b1]</span><br><span class=\"line\">IOMMU group 12</span><br><span class=\"line\">        04:00.0 Non-Volatile memory controller [0108]: Samsung Electronics Co Ltd Device [144d:a808]</span><br><span class=\"line\">IOMMU group 2</span><br><span class=\"line\">        00:02.0 VGA compatible controller [0300]: Intel Corporation Device [8086:3e92]</span><br><span class=\"line\">IOMMU group 10</span><br><span class=\"line\">        00:1f.0 ISA bridge [0601]: Intel Corporation Device [8086:a2c9]</span><br><span class=\"line\">        00:1f.2 Memory controller [0580]: Intel Corporation 200 Series PCH PMC [8086:a2a1]</span><br><span class=\"line\">        00:1f.3 Audio device [0403]: Intel Corporation 200 Series PCH HD Audio [8086:a2f0]</span><br><span class=\"line\">        00:1f.4 SMBus [0c05]: Intel Corporation 200 Series PCH SMBus Controller [8086:a2a3]</span><br><span class=\"line\">IOMMU group 0</span><br><span class=\"line\">        00:00.0 Host bridge [0600]: Intel Corporation Device [8086:3ec2] (rev 07)</span><br><span class=\"line\">IOMMU group 9</span><br><span class=\"line\">        00:1d.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #9 [8086:a298] (rev f0)</span><br></pre></td></tr></table></figure>\n<p>My IOMMU group 1 is perfect, which is basically just my nvidia GPU and its HD\naudio device. The PCI bridge can be ignored but it needs to be removed from the\npcieport driver before we can bind the gpu to the vm.</p>\n<p>Though if you have things like your network card inside the same group then\ngrabbing it is going to be more difficult. You can try an ACS patch which may be\nable to break down your IOMMU groups further. I don’t need it with this setup.\nYet.</p>\n<h1 id=\"X-server-stuff\"><a href=\"#X-server-stuff\" class=\"headerlink\" title=\"X server stuff\"></a>X server stuff</h1><p>Like I mentioned before the host graphics is equally important and I do more\nwork on the host. I use a generic <code>xorg.conf</code> that is generated by\n<code>nvidia-xconfig</code> to configure my graphics initially.</p>\n<p>I leave that file untouched in <code>/etc/X11</code>.</p>\n<p>I have a seperate Xorg configuration that I use for the Intel i915</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Section &quot;Device&quot;</span><br><span class=\"line\">        Identifier  &quot;intel&quot;</span><br><span class=\"line\">        Driver      &quot;modesetting&quot;</span><br><span class=\"line\">        BusID       &quot;PCI:0:2:0&quot;</span><br><span class=\"line\">EndSection</span><br></pre></td></tr></table></figure>\n<p>This filed is named <code>intel.xorg.conf</code> and dumped in the same directory.</p>\n<p>Update:</p>\n<p>I no longer patch <code>xinit</code>. I started using a login manager: SLiM, which also\nstarts a consolekit session (makes things easier). I keep the default config as\n<code>/etc/slim.conf.orig</code> and symlink either that or <code>/etc/slim.conf.intel</code> which\nhas the server argument <code>-config xorg.conf.intel</code> to <code>/etc/slim.conf</code>.</p>\n<h1 id=\"Relevant-scripts\"><a href=\"#Relevant-scripts\" class=\"headerlink\" title=\"Relevant scripts\"></a>Relevant scripts</h1><p>Here’s how I start and stop my VM and bind to different environments. This is\nnot perfect (neither is anything in this post) and criticism is welcome. Pull\nrequests too.</p>\n<p>I don’t use virt-manager or libvirt because</p>\n<ul>\n<li>I don’t want another layer of abstraction</li>\n<li>XML makes life difficult and there are still parameters that can’t be passed\nin via the configuration file</li>\n<li>XML</li>\n<li>Did I mention XML?</li>\n</ul>\n<p>My scripts are <code>sh</code> compatible and do not require any special shell.</p>\n<p>This part prepares the drivers and binding to vfio-pci as required. I don’t\nthink that the rebinding of vtconsole is required.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># PCIe device ids</span></span><br><span class=\"line\">GPU=0000:01:00.0</span><br><span class=\"line\">GPU_SND=0000:01:00.1</span><br><span class=\"line\">PCI_BRIDGE=0000:00:01.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># this script is intended to be run as root</span></span><br><span class=\"line\"><span class=\"comment\"># @TODO put in a check against whoami or $USER</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">perror</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span> 1&gt;&amp;2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">bus_rescan</span></span>() &#123;</span><br><span class=\"line\">  perror <span class=\"string\">\"[*] rescaning pci bus\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/bus/pci/rescan</span><br><span class=\"line\">  sleep 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># usage</span></span><br><span class=\"line\"><span class=\"comment\"># vfio-bind $GPU vfio-bind</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">driver_bind</span></span>() &#123;</span><br><span class=\"line\">  DEV=<span class=\"string\">\"<span class=\"variable\">$1</span>\"</span></span><br><span class=\"line\">  DRV=<span class=\"string\">\"<span class=\"variable\">$2</span>\"</span></span><br><span class=\"line\">  VENDOR=$(&lt; /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/vendor)</span><br><span class=\"line\">  DEVICE=$(&lt; /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/device)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ -e /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/driver ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    perror <span class=\"string\">\"[*] unbinding <span class=\"variable\">$DEV</span>\"</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"variable\">$DEV</span> &gt; /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/driver/unbind</span><br><span class=\"line\">    sleep 1</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    perror <span class=\"string\">\"[!] existing driver for <span class=\"variable\">$DEV</span> not found\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  perror <span class=\"string\">\"[*] binding <span class=\"variable\">$DEV</span> to <span class=\"variable\">$DRV</span>\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"variable\">$VENDOR</span> <span class=\"variable\">$DEVICE</span> &gt; /sys/bus/pci/drivers/<span class=\"variable\">$DRV</span>/new_id</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">remove_pci_bridge</span></span>() &#123;</span><br><span class=\"line\">  perror <span class=\"string\">\"[*] removing pci bridge\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/bus/pci/devices/<span class=\"variable\">$PCI_BRIDGE</span>/remove</span><br><span class=\"line\">  bus_rescan</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">unbind_fb_vtconsole</span></span>() &#123;</span><br><span class=\"line\">  perror <span class=\"string\">\"[*] removing efifb and vtconsole binding\"</span></span><br><span class=\"line\">  perror <span class=\"string\">\"[!!] you WILL lose console\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"efi-framebuffer.0\"</span> &gt; /sys/bus/platform/drivers/efi-framebuffer/unbind</span><br><span class=\"line\">  sleep .5</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 0 &gt; /sys/class/vtconsole/vtcon0/<span class=\"built_in\">bind</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 0 &gt; /sys/class/vtconsole/vtcon1/<span class=\"built_in\">bind</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">rebind_fb_vtconsole</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"efi-framebuffer.0\"</span> &gt; /sys/bus/platform/drivers/efi-framebuffer/<span class=\"built_in\">bind</span></span><br><span class=\"line\">  sleep .5</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/class/vtconsole/vtcon0/<span class=\"built_in\">bind</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/class/vtconsole/vtcon1/<span class=\"built_in\">bind</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>And then for the X server</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">killall X</span><br><span class=\"line\">sleep 5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#unbind_fb_vtconsole</span></span><br><span class=\"line\"></span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU</span> vfio-pci</span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU_SND</span> vfio-pci</span><br><span class=\"line\">remove_pci_bridge</span><br><span class=\"line\"></span><br><span class=\"line\">perror <span class=\"string\">\"[*] switching monitor 1 to mDP\"</span></span><br><span class=\"line\">ddccontrol -r 0x60 -w 16 dev:/dev/i2c-3</span><br><span class=\"line\"></span><br><span class=\"line\">touch /tmp/vm.lock</span><br><span class=\"line\">su alex -c startx</span><br><span class=\"line\"></span><br><span class=\"line\">rebind_fb_vtconsole</span><br></pre></td></tr></table></figure>\n<p>And for when I’m done with the VM:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">killall X</span><br><span class=\"line\">sleep 5</span><br><span class=\"line\"></span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU</span> nvidia</span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU_SND</span> snd_hda_intel</span><br><span class=\"line\">bus_rescan</span><br><span class=\"line\"></span><br><span class=\"line\">rm /tmp/vm.lock</span><br><span class=\"line\">ddccontrol -r 0x60 -w 15 dev:/dev/i2c-3</span><br><span class=\"line\"><span class=\"comment\">#rebind_fb_vtconsole</span></span><br><span class=\"line\">su alex -c startx</span><br></pre></td></tr></table></figure>\n<h1 id=\"QEMU-parameters\"><a href=\"#QEMU-parameters\" class=\"headerlink\" title=\"QEMU parameters\"></a>QEMU parameters</h1><p>I’m using Qemu 3.1.0 at the time of updating this article.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export QEMU_AUDIO_DRV=pa</span><br><span class=\"line\">qemu-system-x86_64 -enable-kvm -m 8G \\</span><br><span class=\"line\">  -machine pc-q35-3.0,accel=kvm \\</span><br><span class=\"line\">  -cpu host,kvm=off,hv_relaxed,hv_spinlocks=0x1fff,hv_time,hv_vapic,hv_vendor_id=0xDEADBEEFFF \\</span><br><span class=\"line\">  -rtc clock=host,base=localtime \\</span><br><span class=\"line\">  -smp 4,sockets=1,cores=2,threads=2 \\</span><br><span class=\"line\">  -vga none \\</span><br><span class=\"line\">  -soundhw ac97 \\</span><br><span class=\"line\">  -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \\</span><br><span class=\"line\">  -device vfio-pci,host=01:00.1 \\</span><br><span class=\"line\">  -drive if=pflash,format=raw,file=/usr/share/edk2-ovmf/OVMF_CODE.fd \\</span><br><span class=\"line\">  -device ide-cd,bus=ide.1,drive=virtiocd1 \\</span><br><span class=\"line\">  -drive media=cdrom,file=/tank/vm/win10.iso,id=virtiocd1,if=none \\</span><br><span class=\"line\">  -object input-linux,id=kbd,evdev=/dev/input/by-id/usb-04d9_USB-HID_Keyboard-event-kbd,grab_all=on,repeat=on \\</span><br><span class=\"line\">  -object input-linux,id=mouse,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-event-mouse \\</span><br><span class=\"line\">  -object input-linux,id=kbd2,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-if01-event-kbd,grab_all=on,repeat=on \\</span><br><span class=\"line\">  -device virtio-scsi-pci,id=scsi0 \\</span><br><span class=\"line\">  -device scsi-hd,bus=scsi0.0,drive=rootfs \\</span><br><span class=\"line\">  -drive id=rootfs,file=/tank/vm/photog.qcow2,id=disk,format=qcow2,if=none \\</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Why\"><a href=\"#Why\" class=\"headerlink\" title=\"Why?\"></a>Why?</h1><ul>\n<li>I have a 1080 GTX that I use to power my 2 1440p screens, render high\ndefinition video, re-encoding and also to play Dota 2 on Linux.</li>\n<li>I also foresee the card running CUDA specific stuff just out of personal\ninterest.</li>\n<li>I <em>hate</em> rebooting machines (the box is also a ZFS datastore that is accessible\nover the network, music server, etc.).</li>\n<li>I want to play certain games on Windows (GTA V, Dying Light, etc.)</li>\n</ul>\n<h1 id=\"Hardware\"><a href=\"#Hardware\" class=\"headerlink\" title=\"Hardware\"></a>Hardware</h1><p>The requirements for pci passthrough can be found all over the internet,\nparticularly in the Arch wiki, but in short: If you’ve an Intel processor it\nwill need to support VT-d and IOMMU. Most modern processors support that. The\nQEMU wiki states that most K processors don’t - but the 8700k does support it.</p>\n<p>The motherboard needs to support it as well (and again, most modern boards do)\n  but some manufacturers are known to disable it to shave cost. Google around.</p>\n<p>The MSI z370-A PRO board supports it. Couldn’t find it in a database somewhere\nbut it does (tested).</p>\n<p>I don’t want to have two separate KB and mouse because that beats the point of\nwhat I’m trying to achieve. I want a Linux host that can run games at times and\nsorta ‘alt-tab’ into each other. However, if you care about achieving bare\nmetal latencies - you’d need to get a PCI USB hub that can be passed through.</p>\n<p>The z370-A PRO motherboard comes with only 1 xHCI USB hub.</p>\n<p>The rest of this post is tailored to hardware I own so</p>\n<table>\n<thead>\n<tr>\n<th>Components</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Intel i7 8700k</td>\n</tr>\n<tr>\n<td>MSI z370-A PRO</td>\n</tr>\n<tr>\n<td>G.Skill Ripjaws V 16GB @ 3000MHz CL15</td>\n</tr>\n<tr>\n<td>Corsair 128GB SATA3 SSD</td>\n</tr>\n<tr>\n<td>Generic HID Keyboard</td>\n</tr>\n<tr>\n<td>Generic HID Mouse</td>\n</tr>\n</tbody>\n</table>\n<p>The SSD is from another computer that no longer exists and was scavenged.</p>\n<p>It is important that there’s two GPUs available on the system. The i7 8700k\ncomes with its integrated graphics and that works fine.</p>\n<h1 id=\"BIOS-Setup\"><a href=\"#BIOS-Setup\" class=\"headerlink\" title=\"BIOS Setup\"></a>BIOS Setup</h1><p>Enable VT-d in Overclocking (smh) -&gt; CPU features. I have no idea why it’s not\nenabled by default on this motherboard.</p>\n<p>Set the boot GPU to the Intel i915 by navigating to Advanced -&gt; Integrated\nGraphics Configuration -&gt; Set to IGD.</p>\n<p>When I boot from the 1080 GTX everything still works, but I can swap X between\nnvidia and intel gpus exactly <em>two</em> times. Any more and it’ll stall the CPU and\nI have to REISUB the machine. Details can be found in the email I sent to the\nvfio-users mailing list <a href=\"https://www.redhat.com/archives/vfio-users/2018-July/msg00005.html\" target=\"_blank\" rel=\"noopener\">here</a>.</p>\n<h1 id=\"Kernel-setup\"><a href=\"#Kernel-setup\" class=\"headerlink\" title=\"Kernel setup\"></a>Kernel setup</h1><p>I’m on gentoo-sources 4.17.9 at the time of writing. You need to keyword it so\nyou’d need</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sys-kernel/gentoo-sources ~amd64</span><br></pre></td></tr></table></figure>\n<p>Enable the following for IOMMU</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CONFIG_IOMMU_SUPPORT</span><br><span class=\"line\">CONFIG_INTEL_IOMMU</span><br><span class=\"line\">CONFIG_INTEL_IOMMU_SVM</span><br><span class=\"line\">CONFIG_IRQ_REMAP</span><br><span class=\"line\">CONFIG_VFIO</span><br><span class=\"line\">CONFIG_VFIO_PCI</span><br><span class=\"line\">CONFIG_VFIO_PCI_VGA</span><br></pre></td></tr></table></figure>\n<p>I’ll also upload my kernel configuration so that it’s easier to reference.</p>\n<p>Then add to <code>/etc/default/grub</code> and reboot</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GRUB_CMDLINE_LINUX=&quot;iommu=on intel_iommu=on&quot;</span><br></pre></td></tr></table></figure>\n<p>Check if the options work by checking the log</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alex@trixie ~ $ dmesg | grep -e IOMMU -e DMAR</span><br><span class=\"line\">[    0.000000] ACPI: DMAR 0x000000007C5A8880 0000A8 (v01 INTEL  EDK2     00000001 INTL 00000001)</span><br><span class=\"line\">[    0.000000] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>\n<p>Also enable the relevant Kernel flags for the Intel GPU and NVIDA GPU (see the\ngentoo handbook for this).</p>\n<p>The i965 (newer i915 name in mesa) seems to flicker on my screen and cause\nartifacts at times. The Arch wiki recommends adding <code>i915.enable_psr=0</code> to get\naround that. You can find more details about that here.</p>\n<h1 id=\"Display-setup\"><a href=\"#Display-setup\" class=\"headerlink\" title=\"Display setup\"></a>Display setup</h1><p>I changed my display setup slightly to remove DP chaining. The final setup is\nlike so</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">                                +--------------+    +--------------+</span><br><span class=\"line\">                                |  2560x1440   |    | 2560x1440    |</span><br><span class=\"line\">                                |  MST on      |    | MST off      |</span><br><span class=\"line\">                                |  DP1.2       |    |              |</span><br><span class=\"line\">                                |              |    |              |</span><br><span class=\"line\">                                +-----+--------+    +----+---------+</span><br><span class=\"line\">                             mDP in|  |      DP out      |  DP in</span><br><span class=\"line\">                                   |  |                  |</span><br><span class=\"line\">                                   |  |                  |</span><br><span class=\"line\">                                   |  |                  |</span><br><span class=\"line\">+------------+DP out               |  |                  |</span><br><span class=\"line\">|  Intel     +---------------------+  |                  |</span><br><span class=\"line\">|  Onboard   |                        |                  |</span><br><span class=\"line\">|            |                        |                  |</span><br><span class=\"line\">+------------+                        |                  |</span><br><span class=\"line\">                                      |                  |</span><br><span class=\"line\">+------------+        DP              |                  |</span><br><span class=\"line\">|            +------------------------+                  |</span><br><span class=\"line\">| GTX 1080   |                                           |</span><br><span class=\"line\">|            +-------------------------------------------+</span><br><span class=\"line\">+------------+</span><br></pre></td></tr></table></figure>\n<p>I removed the DP chaining because if you’re (and you should be) using the nvidia\nproprietary drivers on Linux, there’s a bug preventing DDC control from working\nover DP.</p>\n<p>DDC control enables us to switch the inputs of the monitors from mDP <-> DP from\nsoftware (i2c write). It works fine with the intel GPU which works out well for\nus since that’s the display that’ll be running X when we’re in passthrough.</-></p>\n<p>There’s a nice little utility called <code>ddccontrol</code> that enables us to use this.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">=app-misc/ddccontrol-db-20061014_p20121105 ~amd64</span><br><span class=\"line\">=app-misc/ddccontrol-0.4.2_p20140105-r2 ~amd64</span><br><span class=\"line\"></span><br><span class=\"line\">emerge -a ddccontrol</span><br></pre></td></tr></table></figure>\n<h1 id=\"IOMMU-Groups\"><a href=\"#IOMMU-Groups\" class=\"headerlink\" title=\"IOMMU Groups\"></a>IOMMU Groups</h1><p>And IOMMU group is the smallest set of devices the VM can grab at a time.</p>\n<p>You can check your IOMMU groups by running this little command that I got from\nmany sources (Archwiki, /vg/s installgentoo page)</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> iommu_group <span class=\"keyword\">in</span> \\</span><br><span class=\"line\">      $(find /sys/kernel/iommu_groups/ -maxdepth 1 -mindepth 1 -<span class=\"built_in\">type</span> d); <span class=\"keyword\">do</span> \\</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"IOMMU group <span class=\"variable\">$(basename \"$iommu_group\")</span>\"</span>; \\</span><br><span class=\"line\">  <span class=\"keyword\">for</span> device <span class=\"keyword\">in</span> $(ls -1 <span class=\"string\">\"<span class=\"variable\">$iommu_group</span>\"</span>/devices/); <span class=\"keyword\">do</span> \\</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> -n $<span class=\"string\">'\\t'</span>; lspci -nns <span class=\"string\">\"<span class=\"variable\">$device</span>\"</span>; \\</span><br><span class=\"line\">  <span class=\"keyword\">done</span>; \\</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n<p>Mine are</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IOMMU group 7</span><br><span class=\"line\">        00:1c.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #1 [8086:a290] (rev f0)</span><br><span class=\"line\">IOMMU group 5</span><br><span class=\"line\">        00:16.0 Communication controller [0780]: Intel Corporation 200 Series PCH CSME HECI #1 [8086:a2ba]</span><br><span class=\"line\">IOMMU group 3</span><br><span class=\"line\">        00:08.0 System peripheral [0880]: Intel Corporation Xeon E3-1200 v5/v6 / E3-1500 v5 / 6th/7th Gen Core Processor Gaussian Mixture Model [8086:1911]</span><br><span class=\"line\">IOMMU group 11</span><br><span class=\"line\">        03:00.0 Ethernet controller [0200]: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller [10ec:8168] (rev 15)</span><br><span class=\"line\">IOMMU group 1</span><br><span class=\"line\">        00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v5/E3-1500 v5/6th Gen Core Processor PCIe Controller (x16) [8086:1901] (rev 07)</span><br><span class=\"line\">        01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GP104 [GeForce GTX 1080] [10de:1b80] (rev a1)</span><br><span class=\"line\">        01:00.1 Audio device [0403]: NVIDIA Corporation GP104 High Definition Audio Controller [10de:10f0] (rev a1)</span><br><span class=\"line\">IOMMU group 8</span><br><span class=\"line\">        00:1c.3 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #4 [8086:a293] (rev f0)</span><br><span class=\"line\">IOMMU group 6</span><br><span class=\"line\">        00:17.0 SATA controller [0106]: Intel Corporation 200 Series PCH SATA controller [AHCI mode] [8086:a282]</span><br><span class=\"line\">IOMMU group 4</span><br><span class=\"line\">        00:14.0 USB controller [0c03]: Intel Corporation 200 Series PCH USB 3.0 xHCI Controller [8086:a2af]</span><br><span class=\"line\">        00:14.2 Signal processing controller [1180]: Intel Corporation 200 Series PCH Thermal Subsystem [8086:a2b1]</span><br><span class=\"line\">IOMMU group 12</span><br><span class=\"line\">        04:00.0 Non-Volatile memory controller [0108]: Samsung Electronics Co Ltd Device [144d:a808]</span><br><span class=\"line\">IOMMU group 2</span><br><span class=\"line\">        00:02.0 VGA compatible controller [0300]: Intel Corporation Device [8086:3e92]</span><br><span class=\"line\">IOMMU group 10</span><br><span class=\"line\">        00:1f.0 ISA bridge [0601]: Intel Corporation Device [8086:a2c9]</span><br><span class=\"line\">        00:1f.2 Memory controller [0580]: Intel Corporation 200 Series PCH PMC [8086:a2a1]</span><br><span class=\"line\">        00:1f.3 Audio device [0403]: Intel Corporation 200 Series PCH HD Audio [8086:a2f0]</span><br><span class=\"line\">        00:1f.4 SMBus [0c05]: Intel Corporation 200 Series PCH SMBus Controller [8086:a2a3]</span><br><span class=\"line\">IOMMU group 0</span><br><span class=\"line\">        00:00.0 Host bridge [0600]: Intel Corporation Device [8086:3ec2] (rev 07)</span><br><span class=\"line\">IOMMU group 9</span><br><span class=\"line\">        00:1d.0 PCI bridge [0604]: Intel Corporation 200 Series PCH PCI Express Root Port #9 [8086:a298] (rev f0)</span><br></pre></td></tr></table></figure>\n<p>My IOMMU group 1 is perfect, which is basically just my nvidia GPU and its HD\naudio device. The PCI bridge can be ignored but it needs to be removed from the\npcieport driver before we can bind the gpu to the vm.</p>\n<p>Though if you have things like your network card inside the same group then\ngrabbing it is going to be more difficult. You can try an ACS patch which may be\nable to break down your IOMMU groups further. I don’t need it with this setup.\nYet.</p>\n<h1 id=\"X-server-stuff\"><a href=\"#X-server-stuff\" class=\"headerlink\" title=\"X server stuff\"></a>X server stuff</h1><p>Like I mentioned before the host graphics is equally important and I do more\nwork on the host. I use a generic <code>xorg.conf</code> that is generated by\n<code>nvidia-xconfig</code> to configure my graphics initially.</p>\n<p>I leave that file untouched in <code>/etc/X11</code>.</p>\n<p>I have a seperate Xorg configuration that I use for the Intel i915</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Section &quot;Device&quot;</span><br><span class=\"line\">        Identifier  &quot;intel&quot;</span><br><span class=\"line\">        Driver      &quot;modesetting&quot;</span><br><span class=\"line\">        BusID       &quot;PCI:0:2:0&quot;</span><br><span class=\"line\">EndSection</span><br></pre></td></tr></table></figure>\n<p>This filed is named <code>intel.xorg.conf</code> and dumped in the same directory.</p>\n<p>Update:</p>\n<p>I no longer patch <code>xinit</code>. I started using a login manager: SLiM, which also\nstarts a consolekit session (makes things easier). I keep the default config as\n<code>/etc/slim.conf.orig</code> and symlink either that or <code>/etc/slim.conf.intel</code> which\nhas the server argument <code>-config xorg.conf.intel</code> to <code>/etc/slim.conf</code>.</p>\n<h1 id=\"Relevant-scripts\"><a href=\"#Relevant-scripts\" class=\"headerlink\" title=\"Relevant scripts\"></a>Relevant scripts</h1><p>Here’s how I start and stop my VM and bind to different environments. This is\nnot perfect (neither is anything in this post) and criticism is welcome. Pull\nrequests too.</p>\n<p>I don’t use virt-manager or libvirt because</p>\n<ul>\n<li>I don’t want another layer of abstraction</li>\n<li>XML makes life difficult and there are still parameters that can’t be passed\nin via the configuration file</li>\n<li>XML</li>\n<li>Did I mention XML?</li>\n</ul>\n<p>My scripts are <code>sh</code> compatible and do not require any special shell.</p>\n<p>This part prepares the drivers and binding to vfio-pci as required. I don’t\nthink that the rebinding of vtconsole is required.</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># PCIe device ids</span></span><br><span class=\"line\">GPU=0000:01:00.0</span><br><span class=\"line\">GPU_SND=0000:01:00.1</span><br><span class=\"line\">PCI_BRIDGE=0000:00:01.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># this script is intended to be run as root</span></span><br><span class=\"line\"><span class=\"comment\"># @TODO put in a check against whoami or $USER</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">perror</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span> 1&gt;&amp;2;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">bus_rescan</span></span>() &#123;</span><br><span class=\"line\">  perror <span class=\"string\">\"[*] rescaning pci bus\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/bus/pci/rescan</span><br><span class=\"line\">  sleep 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># usage</span></span><br><span class=\"line\"><span class=\"comment\"># vfio-bind $GPU vfio-bind</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">driver_bind</span></span>() &#123;</span><br><span class=\"line\">  DEV=<span class=\"string\">\"<span class=\"variable\">$1</span>\"</span></span><br><span class=\"line\">  DRV=<span class=\"string\">\"<span class=\"variable\">$2</span>\"</span></span><br><span class=\"line\">  VENDOR=$(&lt; /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/vendor)</span><br><span class=\"line\">  DEVICE=$(&lt; /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/device)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ -e /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/driver ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    perror <span class=\"string\">\"[*] unbinding <span class=\"variable\">$DEV</span>\"</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"variable\">$DEV</span> &gt; /sys/bus/pci/devices/<span class=\"variable\">$DEV</span>/driver/unbind</span><br><span class=\"line\">    sleep 1</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    perror <span class=\"string\">\"[!] existing driver for <span class=\"variable\">$DEV</span> not found\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  perror <span class=\"string\">\"[*] binding <span class=\"variable\">$DEV</span> to <span class=\"variable\">$DRV</span>\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"variable\">$VENDOR</span> <span class=\"variable\">$DEVICE</span> &gt; /sys/bus/pci/drivers/<span class=\"variable\">$DRV</span>/new_id</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">remove_pci_bridge</span></span>() &#123;</span><br><span class=\"line\">  perror <span class=\"string\">\"[*] removing pci bridge\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/bus/pci/devices/<span class=\"variable\">$PCI_BRIDGE</span>/remove</span><br><span class=\"line\">  bus_rescan</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">unbind_fb_vtconsole</span></span>() &#123;</span><br><span class=\"line\">  perror <span class=\"string\">\"[*] removing efifb and vtconsole binding\"</span></span><br><span class=\"line\">  perror <span class=\"string\">\"[!!] you WILL lose console\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"efi-framebuffer.0\"</span> &gt; /sys/bus/platform/drivers/efi-framebuffer/unbind</span><br><span class=\"line\">  sleep .5</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 0 &gt; /sys/class/vtconsole/vtcon0/<span class=\"built_in\">bind</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 0 &gt; /sys/class/vtconsole/vtcon1/<span class=\"built_in\">bind</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">rebind_fb_vtconsole</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"efi-framebuffer.0\"</span> &gt; /sys/bus/platform/drivers/efi-framebuffer/<span class=\"built_in\">bind</span></span><br><span class=\"line\">  sleep .5</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/class/vtconsole/vtcon0/<span class=\"built_in\">bind</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> 1 &gt; /sys/class/vtconsole/vtcon1/<span class=\"built_in\">bind</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>And then for the X server</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">killall X</span><br><span class=\"line\">sleep 5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#unbind_fb_vtconsole</span></span><br><span class=\"line\"></span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU</span> vfio-pci</span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU_SND</span> vfio-pci</span><br><span class=\"line\">remove_pci_bridge</span><br><span class=\"line\"></span><br><span class=\"line\">perror <span class=\"string\">\"[*] switching monitor 1 to mDP\"</span></span><br><span class=\"line\">ddccontrol -r 0x60 -w 16 dev:/dev/i2c-3</span><br><span class=\"line\"></span><br><span class=\"line\">touch /tmp/vm.lock</span><br><span class=\"line\">su alex -c startx</span><br><span class=\"line\"></span><br><span class=\"line\">rebind_fb_vtconsole</span><br></pre></td></tr></table></figure>\n<p>And for when I’m done with the VM:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">killall X</span><br><span class=\"line\">sleep 5</span><br><span class=\"line\"></span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU</span> nvidia</span><br><span class=\"line\">driver_bind <span class=\"variable\">$GPU_SND</span> snd_hda_intel</span><br><span class=\"line\">bus_rescan</span><br><span class=\"line\"></span><br><span class=\"line\">rm /tmp/vm.lock</span><br><span class=\"line\">ddccontrol -r 0x60 -w 15 dev:/dev/i2c-3</span><br><span class=\"line\"><span class=\"comment\">#rebind_fb_vtconsole</span></span><br><span class=\"line\">su alex -c startx</span><br></pre></td></tr></table></figure>\n<h1 id=\"QEMU-parameters\"><a href=\"#QEMU-parameters\" class=\"headerlink\" title=\"QEMU parameters\"></a>QEMU parameters</h1><p>I’m using Qemu 3.1.0 at the time of updating this article.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export QEMU_AUDIO_DRV=pa</span><br><span class=\"line\">qemu-system-x86_64 -enable-kvm -m 8G \\</span><br><span class=\"line\">  -machine pc-q35-3.0,accel=kvm \\</span><br><span class=\"line\">  -cpu host,kvm=off,hv_relaxed,hv_spinlocks=0x1fff,hv_time,hv_vapic,hv_vendor_id=0xDEADBEEFFF \\</span><br><span class=\"line\">  -rtc clock=host,base=localtime \\</span><br><span class=\"line\">  -smp 4,sockets=1,cores=2,threads=2 \\</span><br><span class=\"line\">  -vga none \\</span><br><span class=\"line\">  -soundhw ac97 \\</span><br><span class=\"line\">  -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \\</span><br><span class=\"line\">  -device vfio-pci,host=01:00.1 \\</span><br><span class=\"line\">  -drive if=pflash,format=raw,file=/usr/share/edk2-ovmf/OVMF_CODE.fd \\</span><br><span class=\"line\">  -device ide-cd,bus=ide.1,drive=virtiocd1 \\</span><br><span class=\"line\">  -drive media=cdrom,file=/tank/vm/win10.iso,id=virtiocd1,if=none \\</span><br><span class=\"line\">  -object input-linux,id=kbd,evdev=/dev/input/by-id/usb-04d9_USB-HID_Keyboard-event-kbd,grab_all=on,repeat=on \\</span><br><span class=\"line\">  -object input-linux,id=mouse,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-event-mouse \\</span><br><span class=\"line\">  -object input-linux,id=kbd2,evdev=/dev/input/by-id/usb-Logitech_G102_Prodigy_Gaming_Mouse_017F36743435-if01-event-kbd,grab_all=on,repeat=on \\</span><br><span class=\"line\">  -device virtio-scsi-pci,id=scsi0 \\</span><br><span class=\"line\">  -device scsi-hd,bus=scsi0.0,drive=rootfs \\</span><br><span class=\"line\">  -drive id=rootfs,file=/tank/vm/photog.qcow2,id=disk,format=qcow2,if=none \\</span><br></pre></td></tr></table></figure>\n"},{"title":"WhatsApp chat backup getting stuck/no progress","date":"2017-10-29T11:57:45.000Z","_content":"\nSometimes the iOS WhatsApp application refuses to perform its chat backup\nproperly. Yesterday, my backup was stuck at 152kB/couple of GB for the better\npart of the day. Restarting your phone, restarting the app, toggling cellular\nand airplane modes will not fix the issue.\n\nInstead, head on over to `Settings > iCloud > iCloud Drive` and turn that off.\nIt'll warn that there is some data from WhatsApp that is not saved yet, but\nyou can turn it off anyway. No data was lost on my end.\n\nJust turn it back on, head on over to WhatsApp and restart the backup process\nmanually. This fixes the issue.\n","source":"_posts/whatsapp-chat-backup-getting-stuck.md","raw":"---\ntitle: WhatsApp chat backup getting stuck/no progress\ndate: 2017-10-29 19:57:45\ntags: ios\n---\n\nSometimes the iOS WhatsApp application refuses to perform its chat backup\nproperly. Yesterday, my backup was stuck at 152kB/couple of GB for the better\npart of the day. Restarting your phone, restarting the app, toggling cellular\nand airplane modes will not fix the issue.\n\nInstead, head on over to `Settings > iCloud > iCloud Drive` and turn that off.\nIt'll warn that there is some data from WhatsApp that is not saved yet, but\nyou can turn it off anyway. No data was lost on my end.\n\nJust turn it back on, head on over to WhatsApp and restart the backup process\nmanually. This fixes the issue.\n","slug":"whatsapp-chat-backup-getting-stuck","published":1,"updated":"2019-12-28T07:55:42.188Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0xa1000t4ol3uyhu9awt","content":"<p>Sometimes the iOS WhatsApp application refuses to perform its chat backup\nproperly. Yesterday, my backup was stuck at 152kB/couple of GB for the better\npart of the day. Restarting your phone, restarting the app, toggling cellular\nand airplane modes will not fix the issue.</p>\n<p>Instead, head on over to <code>Settings &gt; iCloud &gt; iCloud Drive</code> and turn that off.\nIt’ll warn that there is some data from WhatsApp that is not saved yet, but\nyou can turn it off anyway. No data was lost on my end.</p>\n<p>Just turn it back on, head on over to WhatsApp and restart the backup process\nmanually. This fixes the issue.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Sometimes the iOS WhatsApp application refuses to perform its chat backup\nproperly. Yesterday, my backup was stuck at 152kB/couple of GB for the better\npart of the day. Restarting your phone, restarting the app, toggling cellular\nand airplane modes will not fix the issue.</p>\n<p>Instead, head on over to <code>Settings &gt; iCloud &gt; iCloud Drive</code> and turn that off.\nIt’ll warn that there is some data from WhatsApp that is not saved yet, but\nyou can turn it off anyway. No data was lost on my end.</p>\n<p>Just turn it back on, head on over to WhatsApp and restart the backup process\nmanually. This fixes the issue.</p>\n"},{"title":"Say no to catkin_make","date":"2017-01-19T09:03:20.000Z","author":"alex","_content":"`catkin` is the wrapper around cmake that ROS uses. Majority of the people I\nknow are still using plain `catkin_make` to build their workspaces but that is\npretty basic. Please use `catkin`, it is much more powerful and convienient.\n\nFor one, it can resolve dependencies and parallelize your workspace compilation.\nWhen you're building individual packages it can sometimes be useful as it'll\ndetect if your dependencies are out of date and compile them too.\n\nInstall catkin with\n\n```\npip install catkin catkin_tools\n```\n\nTo initialize a workspace (that already has a `src` folder)\n\n```sh\ncatkin init\ncatkin build\n```\n\nThen you can easily set cmake parameters\n\n```sh\ncatkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\\n  -DCMAKE_BUILD_TYPE=Release\n```\n\nor \n\n```sh\ncatkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\\n  -DCMAKE_BUILD_TYPE=Release \\\n  -DPYTHON_LIBRARY=$(python -c \"import sys; print sys.prefix\")/lib/libpython2.7.dylib \\\n  -DPYTHON_INCLUDE_DIR=$(python -c \"import sys; print sys.prefix\")/include/python2.7 \\\n  -DQT_USE_FRAMEWORKS=ON -DCATKIN_ENABLE_TESTING=ON\n```\n\nIf you're using homebrewed libraries on MacOS.\n\nTo build a particular package\n\n```sh\ncatkin build pkg\n```\n\nOr blacklist/whitelist with \n\n```sh\ncatkin config (--blacklist|--whitelist) pkg\n```\n\nIf you are building an individual package you can force it to\nbuild only that package by \n\n```sh\ncatkin build pkg --no-deps\n```\n\nVerbosity and job control\n\n```sh\ncatkin build -v -jN\n```\n\n","source":"_posts/say-no-to-catkin-make.md","raw":"---\ntitle: Say no to catkin_make\ndate: 2017-01-19 17:03:20\ntags: ros\nauthor: alex\n---\n`catkin` is the wrapper around cmake that ROS uses. Majority of the people I\nknow are still using plain `catkin_make` to build their workspaces but that is\npretty basic. Please use `catkin`, it is much more powerful and convienient.\n\nFor one, it can resolve dependencies and parallelize your workspace compilation.\nWhen you're building individual packages it can sometimes be useful as it'll\ndetect if your dependencies are out of date and compile them too.\n\nInstall catkin with\n\n```\npip install catkin catkin_tools\n```\n\nTo initialize a workspace (that already has a `src` folder)\n\n```sh\ncatkin init\ncatkin build\n```\n\nThen you can easily set cmake parameters\n\n```sh\ncatkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\\n  -DCMAKE_BUILD_TYPE=Release\n```\n\nor \n\n```sh\ncatkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\\n  -DCMAKE_BUILD_TYPE=Release \\\n  -DPYTHON_LIBRARY=$(python -c \"import sys; print sys.prefix\")/lib/libpython2.7.dylib \\\n  -DPYTHON_INCLUDE_DIR=$(python -c \"import sys; print sys.prefix\")/include/python2.7 \\\n  -DQT_USE_FRAMEWORKS=ON -DCATKIN_ENABLE_TESTING=ON\n```\n\nIf you're using homebrewed libraries on MacOS.\n\nTo build a particular package\n\n```sh\ncatkin build pkg\n```\n\nOr blacklist/whitelist with \n\n```sh\ncatkin config (--blacklist|--whitelist) pkg\n```\n\nIf you are building an individual package you can force it to\nbuild only that package by \n\n```sh\ncatkin build pkg --no-deps\n```\n\nVerbosity and job control\n\n```sh\ncatkin build -v -jN\n```\n\n","slug":"say-no-to-catkin-make","published":1,"updated":"2019-12-28T07:55:42.188Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckd9v0xa2000w4ol3e7gmrohr","content":"<p><code>catkin</code> is the wrapper around cmake that ROS uses. Majority of the people I\nknow are still using plain <code>catkin_make</code> to build their workspaces but that is\npretty basic. Please use <code>catkin</code>, it is much more powerful and convienient.</p>\n<p>For one, it can resolve dependencies and parallelize your workspace compilation.\nWhen you’re building individual packages it can sometimes be useful as it’ll\ndetect if your dependencies are out of date and compile them too.</p>\n<p>Install catkin with</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install catkin catkin_tools</span><br></pre></td></tr></table></figure>\n<p>To initialize a workspace (that already has a <code>src</code> folder)</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin init</span><br><span class=\"line\">catkin build</span><br></pre></td></tr></table></figure>\n<p>Then you can easily set cmake parameters</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\</span><br><span class=\"line\">  -DCMAKE_BUILD_TYPE=Release</span><br></pre></td></tr></table></figure>\n<p>or </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\</span><br><span class=\"line\">  -DCMAKE_BUILD_TYPE=Release \\</span><br><span class=\"line\">  -DPYTHON_LIBRARY=$(python -c <span class=\"string\">\"import sys; print sys.prefix\"</span>)/lib/libpython2.7.dylib \\</span><br><span class=\"line\">  -DPYTHON_INCLUDE_DIR=$(python -c <span class=\"string\">\"import sys; print sys.prefix\"</span>)/include/python2.7 \\</span><br><span class=\"line\">  -DQT_USE_FRAMEWORKS=ON -DCATKIN_ENABLE_TESTING=ON</span><br></pre></td></tr></table></figure>\n<p>If you’re using homebrewed libraries on MacOS.</p>\n<p>To build a particular package</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin build pkg</span><br></pre></td></tr></table></figure>\n<p>Or blacklist/whitelist with </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin config (--blacklist|--whitelist) pkg</span><br></pre></td></tr></table></figure>\n<p>If you are building an individual package you can force it to\nbuild only that package by </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin build pkg --no-deps</span><br></pre></td></tr></table></figure>\n<p>Verbosity and job control</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin build -v -jN</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<p><code>catkin</code> is the wrapper around cmake that ROS uses. Majority of the people I\nknow are still using plain <code>catkin_make</code> to build their workspaces but that is\npretty basic. Please use <code>catkin</code>, it is much more powerful and convienient.</p>\n<p>For one, it can resolve dependencies and parallelize your workspace compilation.\nWhen you’re building individual packages it can sometimes be useful as it’ll\ndetect if your dependencies are out of date and compile them too.</p>\n<p>Install catkin with</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install catkin catkin_tools</span><br></pre></td></tr></table></figure>\n<p>To initialize a workspace (that already has a <code>src</code> folder)</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin init</span><br><span class=\"line\">catkin build</span><br></pre></td></tr></table></figure>\n<p>Then you can easily set cmake parameters</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\</span><br><span class=\"line\">  -DCMAKE_BUILD_TYPE=Release</span><br></pre></td></tr></table></figure>\n<p>or </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin config --install --cmake-args -DCMAKE_FIND_FRAMEWORK=LAST \\</span><br><span class=\"line\">  -DCMAKE_BUILD_TYPE=Release \\</span><br><span class=\"line\">  -DPYTHON_LIBRARY=$(python -c <span class=\"string\">\"import sys; print sys.prefix\"</span>)/lib/libpython2.7.dylib \\</span><br><span class=\"line\">  -DPYTHON_INCLUDE_DIR=$(python -c <span class=\"string\">\"import sys; print sys.prefix\"</span>)/include/python2.7 \\</span><br><span class=\"line\">  -DQT_USE_FRAMEWORKS=ON -DCATKIN_ENABLE_TESTING=ON</span><br></pre></td></tr></table></figure>\n<p>If you’re using homebrewed libraries on MacOS.</p>\n<p>To build a particular package</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin build pkg</span><br></pre></td></tr></table></figure>\n<p>Or blacklist/whitelist with </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin config (--blacklist|--whitelist) pkg</span><br></pre></td></tr></table></figure>\n<p>If you are building an individual package you can force it to\nbuild only that package by </p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin build pkg --no-deps</span><br></pre></td></tr></table></figure>\n<p>Verbosity and job control</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catkin build -v -jN</span><br></pre></td></tr></table></figure>\n"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"ckd9v0x9d00004ol3qklmgq8l","tag_id":"ckd9v0x9i00024ol3i5nswhld","_id":"ckd9v0x9n00074ol38yp2bign"},{"post_id":"ckd9v0x9h00014ol3w7lxp6nv","tag_id":"ckd9v0x9m00064ol3yqdn6faf","_id":"ckd9v0x9w000i4ol3qz2hhy51"},{"post_id":"ckd9v0x9h00014ol3w7lxp6nv","tag_id":"ckd9v0x9p000a4ol364qgnpps","_id":"ckd9v0x9x000k4ol38lb3sufk"},{"post_id":"ckd9v0x9h00014ol3w7lxp6nv","tag_id":"ckd9v0x9r000d4ol3fm8wa662","_id":"ckd9v0x9y000n4ol33ugxyrwr"},{"post_id":"ckd9v0x9k00034ol3chan1kpe","tag_id":"ckd9v0x9u000g4ol315fet3qb","_id":"ckd9v0xa1000s4ol3f4ygkm3v"},{"post_id":"ckd9v0x9k00034ol3chan1kpe","tag_id":"ckd9v0x9x000m4ol3hzxyf6ql","_id":"ckd9v0xa2000u4ol362zsywj5"},{"post_id":"ckd9v0x9l00044ol3jcpbbfva","tag_id":"ckd9v0xa0000q4ol3gueivji6","_id":"ckd9v0xa4000z4ol3dt7kt2h7"},{"post_id":"ckd9v0x9l00044ol3jcpbbfva","tag_id":"ckd9v0xa2000v4ol3ruihi5xa","_id":"ckd9v0xa400104ol37m5q360f"},{"post_id":"ckd9v0x9l00044ol3jcpbbfva","tag_id":"ckd9v0xa4000x4ol3w4wo2zqp","_id":"ckd9v0xa400124ol36rqo4ry4"},{"post_id":"ckd9v0x9n00084ol38lfkb5dg","tag_id":"ckd9v0xa4000y4ol3ckqmkz8m","_id":"ckd9v0xa400134ol3253zcsbt"},{"post_id":"ckd9v0x9o00094ol3rjz9gwcr","tag_id":"ckd9v0xa400114ol3t2hq9xoi","_id":"ckd9v0xa500164ol3d9e0ilm7"},{"post_id":"ckd9v0x9o00094ol3rjz9gwcr","tag_id":"ckd9v0xa500144ol3xj1k5em9","_id":"ckd9v0xa500174ol3ettqqro5"},{"post_id":"ckd9v0x9p000b4ol35r6wyhin","tag_id":"ckd9v0xa500154ol3yhg27y42","_id":"ckd9v0xa500194ol3d7x1wq84"},{"post_id":"ckd9v0x9q000c4ol3yh7n6uky","tag_id":"ckd9v0xa500184ol3se65gr40","_id":"ckd9v0xa6001b4ol3i4ogcxmj"},{"post_id":"ckd9v0x9r000e4ol3lnis36wa","tag_id":"ckd9v0xa6001a4ol3oavytvom","_id":"ckd9v0xa6001e4ol3doiky9go"},{"post_id":"ckd9v0x9r000e4ol3lnis36wa","tag_id":"ckd9v0x9m00064ol3yqdn6faf","_id":"ckd9v0xa7001f4ol3rv067rg1"},{"post_id":"ckd9v0x9r000e4ol3lnis36wa","tag_id":"ckd9v0xa6001c4ol32hhmu0bp","_id":"ckd9v0xa7001h4ol3az16br6a"},{"post_id":"ckd9v0x9r000e4ol3lnis36wa","tag_id":"ckd9v0x9r000d4ol3fm8wa662","_id":"ckd9v0xa7001i4ol3joa89dei"},{"post_id":"ckd9v0x9t000f4ol3142wkpeo","tag_id":"ckd9v0xa6001d4ol3bqds0sqn","_id":"ckd9v0xa7001k4ol3u3hxuwyr"},{"post_id":"ckd9v0x9v000h4ol32vmgp07p","tag_id":"ckd9v0xa7001g4ol38qi0h72u","_id":"ckd9v0xa9001o4ol37esorwly"},{"post_id":"ckd9v0x9v000h4ol32vmgp07p","tag_id":"ckd9v0x9r000d4ol3fm8wa662","_id":"ckd9v0xa9001p4ol31jbjwkox"},{"post_id":"ckd9v0x9v000h4ol32vmgp07p","tag_id":"ckd9v0xa7001j4ol3zmkvilqs","_id":"ckd9v0xaa001r4ol3hq3uihy5"},{"post_id":"ckd9v0x9v000h4ol32vmgp07p","tag_id":"ckd9v0xa8001l4ol3xj6bc1np","_id":"ckd9v0xaa001s4ol34h6kowhh"},{"post_id":"ckd9v0x9v000h4ol32vmgp07p","tag_id":"ckd9v0xa4000x4ol3w4wo2zqp","_id":"ckd9v0xaa001u4ol3e3sue028"},{"post_id":"ckd9v0x9x000l4ol3ga898cfe","tag_id":"ckd9v0xa9001n4ol3t8klyc3q","_id":"ckd9v0xab001x4ol3a39phb6l"},{"post_id":"ckd9v0x9x000l4ol3ga898cfe","tag_id":"ckd9v0xa9001q4ol3v93wnrad","_id":"ckd9v0xab001y4ol3g4iy2oqu"},{"post_id":"ckd9v0x9x000l4ol3ga898cfe","tag_id":"ckd9v0xaa001t4ol3kyz12xow","_id":"ckd9v0xab00204ol3liqg04n7"},{"post_id":"ckd9v0x9x000l4ol3ga898cfe","tag_id":"ckd9v0xa6001a4ol3oavytvom","_id":"ckd9v0xab00214ol33zgamsc1"},{"post_id":"ckd9v0x9y000o4ol3x7yg9rvo","tag_id":"ckd9v0xab001w4ol3c8ygduko","_id":"ckd9v0xac00234ol370aymv0d"},{"post_id":"ckd9v0x9y000o4ol3x7yg9rvo","tag_id":"ckd9v0xab001z4ol3h92dldse","_id":"ckd9v0xac00244ol3700rjb72"},{"post_id":"ckd9v0x9z000p4ol30b6j0xt6","tag_id":"ckd9v0xa2000v4ol3ruihi5xa","_id":"ckd9v0xac00264ol3vg3g25f8"},{"post_id":"ckd9v0xa0000r4ol3adxu91ql","tag_id":"ckd9v0x9u000g4ol315fet3qb","_id":"ckd9v0xae002b4ol3dreln7k4"},{"post_id":"ckd9v0xa0000r4ol3adxu91ql","tag_id":"ckd9v0xac00254ol3z5xg49q2","_id":"ckd9v0xae002c4ol34upuv9qu"},{"post_id":"ckd9v0xa0000r4ol3adxu91ql","tag_id":"ckd9v0xad00274ol3lyugkfre","_id":"ckd9v0xae002e4ol3ehr4ghcm"},{"post_id":"ckd9v0xa0000r4ol3adxu91ql","tag_id":"ckd9v0xad00284ol3gypizp3p","_id":"ckd9v0xae002f4ol3ie35dy13"},{"post_id":"ckd9v0xa0000r4ol3adxu91ql","tag_id":"ckd9v0xa7001g4ol38qi0h72u","_id":"ckd9v0xae002g4ol3c1t2f2ki"},{"post_id":"ckd9v0xa1000t4ol3uyhu9awt","tag_id":"ckd9v0xad002a4ol3r5j8bc3y","_id":"ckd9v0xaf002h4ol3dkz1sgyh"},{"post_id":"ckd9v0xa2000w4ol3e7gmrohr","tag_id":"ckd9v0xa6001d4ol3bqds0sqn","_id":"ckd9v0xaf002i4ol3jq5e1c04"}],"Tag":[{"name":"shell, scripting","_id":"ckd9v0x9i00024ol3i5nswhld"},{"name":"vm","_id":"ckd9v0x9m00064ol3yqdn6faf"},{"name":"audio","_id":"ckd9v0x9p000a4ol364qgnpps"},{"name":"passthrough","_id":"ckd9v0x9r000d4ol3fm8wa662"},{"name":"linux","_id":"ckd9v0x9u000g4ol315fet3qb"},{"name":"kernel","_id":"ckd9v0x9x000m4ol3hzxyf6ql"},{"name":"ezjail","_id":"ckd9v0xa0000q4ol3gueivji6"},{"name":"freebsd","_id":"ckd9v0xa2000v4ol3ruihi5xa"},{"name":"networking","_id":"ckd9v0xa4000x4ol3w4wo2zqp"},{"name":"esp8266","_id":"ckd9v0xa4000y4ol3ckqmkz8m"},{"name":"automation","_id":"ckd9v0xa400114ol3t2hq9xoi"},{"name":"macos","_id":"ckd9v0xa500144ol3xj1k5em9"},{"name":"ios, openvpn","_id":"ckd9v0xa500154ol3yhg27y42"},{"name":"weechat","_id":"ckd9v0xa500184ol3se65gr40"},{"name":"zfs","_id":"ckd9v0xa6001a4ol3oavytvom"},{"name":"vfio","_id":"ckd9v0xa6001c4ol32hhmu0bp"},{"name":"ros","_id":"ckd9v0xa6001d4ol3bqds0sqn"},{"name":"qemu","_id":"ckd9v0xa7001g4ol38qi0h72u"},{"name":"vpn","_id":"ckd9v0xa7001j4ol3zmkvilqs"},{"name":"wireguard","_id":"ckd9v0xa8001l4ol3xj6bc1np"},{"name":"rtorrent","_id":"ckd9v0xa9001n4ol3t8klyc3q"},{"name":"flood","_id":"ckd9v0xa9001q4ol3v93wnrad"},{"name":"bittorrent","_id":"ckd9v0xaa001t4ol3kyz12xow"},{"name":"rust","_id":"ckd9v0xab001w4ol3c8ygduko"},{"name":"conference","_id":"ckd9v0xab001z4ol3h92dldse"},{"name":"gentoo","_id":"ckd9v0xac00254ol3z5xg49q2"},{"name":"nvidia","_id":"ckd9v0xad00274ol3lyugkfre"},{"name":"pci-passthrough","_id":"ckd9v0xad00284ol3gypizp3p"},{"name":"ios","_id":"ckd9v0xad002a4ol3r5j8bc3y"}]}}